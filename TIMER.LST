8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:32:17  11/09/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\USERS\ANGADS~1\DOWNLO~1\ASM\ASM\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer0_action, timer1_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   Set_timer0:far, Set_timer1:far, Set_timer2:far
                            20     
----                        21     STACK_SEG       SEGMENT
0000 (256                   22                     DB      256 DUP(?)
     ??
     )
0100                        23             TOS     LABEL   WORD
----                        24     STACK_SEG       ENDS
                            25     
                            26     
----                        27     DATA_SEG        SEGMENT
0000 0A                     28             MAIN_MESS   DB  10,13,'Main Loop           '
0001 0D
0002 4D61696E204C6F
     6F702020202020
     202020202020
0016 0A                     29             TIMER0_MESS     DB      10,13,'TIMER0 INTERRUPT    '
0017 0D
0018 54494D45523020
     494E5445525255
     505420202020
002C 0A                     30             TIMER1_MESS     DB      10,13,'TIMER1 INTERRUPT    '
002D 0D
002E 54494D45523120
     494E5445525255
     505420202020
0042 0A                     31             TIMER2_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0043 0D
0044 54494D45523220
     494E5445525255
     505420202020
                            32             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:32:17  11/09/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

                            33             ; -- define messages for other timers
                            34     
0058 2F                     35             T0_COUNT                DB      2FH
0059 2F                     36             T0_COUNT_SET    DB      2FH
005A 2F                     37             T1_COUNT                DB      2FH
005B 2F                     38             T1_COUNT_SET    DB      2FH
005C 2F                     39             T2_COUNT                DB      2FH
005D 2F                     40             T2_COUNT_SET    DB      2FH
                            41     
005E FE                     42             LED_SELECT  DB  0FEH
005F 3F                     43             NUMBERS         DB      03FH, 006H, 05BH, 04FH, 066H, 06DH, 07DH, 007H, 07FH,
                                    06FH
0060 06
0061 5B
0062 4F
0063 66
0064 6D
0065 7D
0066 07
0067 7F
0068 6F
0069 00                     44             CURRENT_NUMBER DB 00H
006A (6                     45             BARCODE         DB  06 DUP (?)
     ??
     )
0070 00                     46             BARCODE_I       DB 00H
0071 0A                     47             REC_MESS        DB      10,13,'Period of timer0 =     '
0072 0D
0073 506572696F6420
     6F662074696D65
     7230203D202020
     2020
                            48     
                            49              ;****Keypad******
008A (24                    50       KEY_DECODE    DB 24 DUP(0)
     00
     )
00A2 00                     51       LAST_FOUND    DB 0H ; 0 NO KEY FOUND, 1 KEY FOUND
00A3 21                     52       KEYPAD_INPUT  DB 33 
                            53       ;**********
                            54     
                            55     
----                        56     DATA_SEG        ENDS
                            57     
                            58     ;------------------------------------------
                            59     ;--CHIP SELECTS
                            60     ; 8255 register addresses
                            61     ; PCS1
  0080                      62     IC8255_PORTA_ADDR EQU 80H;
  0081                      63     IC8255_PORTB_ADDR EQU 81H;
  0082                      64     IC8255_PORTC_ADDR EQU 82H;
  0083                      65     IC8255_CW_ADDR    EQU 83H;
                            66     
  0100                      67     PCS2_ADDR EQU 100H
  0180                      68     PCS3_ADDR EQU 180H
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:32:17  11/09/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

  0200                      69     PCS4_ADDR EQU 200H
                            70             
                            71     
                            72     
                            73     ;-------------------------------------------
                            74     
----                        75     CODE_SEG        SEGMENT
                            76     
                            77             PUBLIC          START
                            78     
                            79     ASSUME  CS:CODE_SEG, SS:STACK_SEG, DS:DATA_SEG
                            80     
0000                        81     START:
                            82     
                            83     ;initialize stack area
0000 B8----         R       84                     MOV     AX, STACK_SEG           
0003 8ED0                   85                     MOV     SS, AX
0005 368B260001             86                     MOV     SP, TOS
                            87     
000A B8----         R       88                     MOV AX, DATA_SEG
000D 8ED8                   89                     MOV DS, AX
                            90     
                            91     ; Initialize the on-chip pheripherals
000F 9A0000----     E       92                     CALL    FAR PTR IODEFINE
                            93                     
                            94             ;KEYPAD INIT
                            95     
0014 BA8300                 96             MOV DX, IC8255_CW_ADDR
                            97     
                            98             ;CW Register 
                            99             ;Port C Lower Input, Port C Upper Output 
                           100             ;Port B input, Port A output
                           101             ;1 0 0 0 0 0 1 0
                           102     
0017 B082                  103             MOV AL, 82H
0019 EE                    104             OUT DX, AL
                           105     
                           106     ; Initialize MCS
                           107     
                           108     ; Initialize key code
                           109     
001A C6068A0001            110             MOV DS:KEY_DECODE[0], 1
001F C6068B0002            111             MOV DS:KEY_DECODE[1], 2
0024 C6068C0003            112             MOV DS:KEY_DECODE[2], 3
0029 C6068D0001            113             MOV DS:KEY_DECODE[3], 1
002E C6068E0002            114             MOV DS:KEY_DECODE[4], 2
0033 C6068F0003            115             MOV DS:KEY_DECODE[5], 3
0038 C606900004            116             MOV DS:KEY_DECODE[6], 4
003D C606910005            117             MOV DS:KEY_DECODE[7], 5
0042 C606920006            118             MOV DS:KEY_DECODE[8], 6
0047 C606930004            119             MOV DS:KEY_DECODE[9], 4
004C C606940005            120             MOV DS:KEY_DECODE[10], 5
0051 C606950006            121             MOV DS:KEY_DECODE[11], 6
0056 C606960007            122             MOV DS:KEY_DECODE[12], 7
005B C606970008            123             MOV DS:KEY_DECODE[13], 8
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:32:17  11/09/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

0060 C606980009            124             MOV DS:KEY_DECODE[14], 9
0065 C606990007            125             MOV DS:KEY_DECODE[15], 7
006A C6069A0008            126             MOV DS:KEY_DECODE[16], 8
006F C6069B0009            127             MOV DS:KEY_DECODE[17], 9
                           128             ;MOV DS:KEY_DECODE[18], *
0074 C6069D0000            129             MOV DS:KEY_DECODE[19], 0
                           130             ;MOV DS:KEY_DECODE[20], #
                           131             ;MOV DS:KEY_DECODE[21], *
0079 C606A00000            132             MOV DS:KEY_DECODE[22], 0
                           133             ;MOV DS:KEY_DECODE[23], #
                           134     
                           135     ;Initialize barcode array
007E C6066A0000            136             MOV DS:BARCODE[0], 0
0083 C6066B0000            137             MOV DS:BARCODE[1], 0
0088 C6066C0000            138             MOV DS:BARCODE[2], 0
008D C6066D0000            139             MOV DS:BARCODE[3], 0
0092 C6066E0000            140             MOV DS:BARCODE[4], 0
0097 C6066F0000            141             MOV DS:BARCODE[5], 0
                           142     
                           143     
                           144     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
009C 9A0000----     E      145         call Set_timer0
00A1 9A0000----     E      146             call Set_timer1
00A6 9A0000----     E      147             call Set_timer2
00AB FB                    148           STI
                           149     
00AC                       150     NEXT:     
                           151     ;BEGIN MAIN LOOP
                           152             
                           153     
                           154     
00AC EBFE                  155     JMP NEXT
                           156     
                           157     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
                           158     
                           159     
00AE                       160     SERIAL_REC_ACTION       PROC    FAR
00AE 51                    161                     PUSH    CX
00AF 53                    162                     PUSH    BX
00B0 1E                    163                     PUSH    DS
                           164     
00B1 BB----         R      165                     MOV     BX,DATA_SEG             ;initialize data segment register
00B4 8EDB                  166                     MOV     DS,BX
                           167     
00B6 3C3C                  168                     CMP     AL,'<'
00B8 750B                  169                     JNE     S_FAST
                           170     
00BA FE065900              171                     INC     DS:T0_COUNT_SET
00BE FE065900              172                     INC     DS:T0_COUNT_SET
                           173                     
                           174                     ;MOV DX, IC8255_PORTA_ADDR
                           175                     ;MOV AL, 0FFH
                           176                     ;OUT DX, AL
                           177     
00C2 EB0D90                178                     JMP     S_NEXT0
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:32:17  11/09/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

00C5                       179     S_FAST:
00C5 3C3E                  180                     CMP     AL,'>'
00C7 7521                  181                     JNE     S_RET
                           182     
00C9 FE0E5900              183                     DEC     DS:T0_COUNT_SET
00CD FE0E5900              184                     DEC     DS:T0_COUNT_SET
                           185     
00D1                       186     S_NEXT0:
00D1 B91600                187                     MOV     CX,22                   ;initialize counter for message
00D4 BB0000                188                     MOV     BX,0
                           189     
00D7 8A4771                190     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
00DA 9A0000----     E      191                     call    FAR ptr print_char
00DF 43                    192                     INC     BX
00E0 E2F5                  193                     LOOP    S_NEXT1
                           194     
00E2 A05900                195                     MOV     AL,DS:T0_COUNT_SET      ;print current period of timer0
00E5 9A0000----     E      196                     CALL    FAR PTR PRINT_2HEX
00EA                       197     S_RET:
00EA 1F                    198                     POP     DS
00EB 5B                    199                     POP     BX
00EC 59                    200                     POP     CX
00ED CB                    201                     RET
                           202     SERIAL_REC_ACTION       ENDP
                           203     
                           204     
                           205     ;--------------------------------------------------------------
                           206     
                           207     ;--------------------TIMER 0 ----------------------------------
                           208     
00EE                       209     TIMER0_ACTION   PROC    FAR
00EE 50                    210                     PUSH    AX
00EF 1E                    211                     PUSH    DS
00F0 53                    212                     PUSH    BX
00F1 51                    213                     PUSH    CX
                           214     
                           215     ;----------------------------
                           216                     ;AD0 - AD5 PCS3 CS for 7-segment
                           217                     ;7  6  5  4  3  2  1  0
                           218                     ;x  x  A5 A4 A3 A2 A1 A0
00F2 BA8001                219                     MOV DX, PCS3_ADDR
00F5 A05E00                220                     MOV AL, LED_SELECT
                           221                     ;MOV AL, 00111110B
00F8 EE                    222                     OUT DX, AL
00F9 D0065E00              223                     ROL LED_SELECT, 01H
                           224     
                           225                     ;AD0 - AD7 PCS2
                           226                     ;AD7 - DOT (MSB)
                           227                     
00FD BA0001                228                     MOV DX, PCS2_ADDR
0100 8A1E6900              229                     MOV BL, CURRENT_NUMBER
0104 8A475F                230                     MOV AL, NUMBERS[BX]
                           231                     ;MOV AL, 01111111B
0107 EE                    232                     OUT DX, AL
0108 FE066900              233                     INC CURRENT_NUMBER
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:32:17  11/09/;2  PAGE    6


LOC  OBJ                  LINE     SOURCE

010C 803E690008            234                     CMP CURRENT_NUMBER, 08H
0111 7411                  235                     JE RESET_CURRENT
0113 7523                  236                     JNE T0_NEXT1
                           237     ;---------------------------
0115 FE0E5800              238                     DEC     DS:T0_COUNT
0119 751D                  239                     JNZ     T0_NEXT1
011B A05900                240                     MOV     AL,DS:T0_COUNT_SET
011E A25800                241                     MOV     DS:T0_COUNT,AL
0121 BB0000                242                     MOV     BX,0H
                           243                     
0124                       244     RESET_CURRENT:
0124 C606690000            245                     MOV CURRENT_NUMBER, 00H
0129 FE0E5800              246                     DEC     DS:T0_COUNT
012D 7509                  247                     JNZ     T0_NEXT1
012F A05900                248                     MOV     AL,DS:T0_COUNT_SET
0132 A25800                249                     MOV     DS:T0_COUNT,AL
0135 BB0000                250                     MOV     BX,0H
                           251     
0138                       252     T0_NEXT1:       
0138 59                    253                     POP     CX
0139 5B                    254                     POP     BX
013A 1F                    255                     POP     DS
013B 58                    256                     POP     AX
013C CB                    257                     RET
                           258     TIMER0_ACTION   ENDP
                           259     
                           260     ;--------------------------------------------------------------
                           261     
                           262     ;--------------------TIMER 1 ----------------------------------
                           263     
                           264     
013D                       265     TIMER1_ACTION   PROC    FAR
013D 50                    266                     PUSH    AX
013E 1E                    267                     PUSH    DS
013F 53                    268                     PUSH    BX
0140 51                    269                     PUSH    CX
                           270     
0141 B8----         R      271                     MOV     AX,DATA_SEG
0144 8ED8                  272                     MOV     DS,AX
                           273             
0146 FE0E5A00              274                     DEC     DS:T1_COUNT
014A 7517                  275                     JNZ     T1_NEXT1
014C A05B00                276                     MOV     AL,DS:T1_COUNT_SET
014F A25A00                277                     MOV     DS:T1_COUNT,AL
                           278     
0152 B91400                279                     MOV     CX,20
0155 BB0000                280                     MOV     BX,0H
0158                       281     T1_NEXT0:
0158 8A472C                282                     MOV     AL,DS:TIMER1_MESS[BX]
015B 43                    283                     INC     BX
015C 9A0000----     E      284                     CALL    FAR PTR PRINT_CHAR
0161 E2F5                  285                     LOOP    T1_NEXT0
                           286     
0163                       287     T1_NEXT1:       
0163 59                    288                     POP     CX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:32:17  11/09/;2  PAGE    7


LOC  OBJ                  LINE     SOURCE

0164 5B                    289                     POP     BX
0165 1F                    290                     POP     DS
0166 58                    291                     POP     AX
0167 CB                    292                     RET
                           293     TIMER1_ACTION   ENDP
                           294     
                           295     ;--------------------------------------------------------------
                           296     
                           297     ;--------------------TIMER 2 ----------------------------------
                           298     
                           299     
0168                       300     TIMER2_ACTION   PROC    FAR
0168 50                    301                     PUSH    AX
0169 1E                    302                     PUSH    DS
016A 53                    303                     PUSH    BX
016B 51                    304                     PUSH    CX
                           305     
016C 33C0                  306             XOR AX,AX
016E 33DB                  307             XOR BX,BX
                           308     
0170 BA8200                309             MOV DX, IC8255_PORTC_ADDR       ;DX = Port B Address
0173 EE                    310             OUT DX, AL                                      ;
0174 BA8100                311             MOV DX, IC8255_PORTB_ADDR       ;
                           312     
0177                       313     CHECK_KEY_CLOSED:                               ;Check when key is pressed. Keep loop
                                   ing here
0177 EC                    314             IN AL, DX                                       ;Move to AL, value in Port B.
                                    
0178 8A1E7000              315             MOV BL, BARCODE_I
017C 88476A                316             MOV BARCODE[BX], AL
017F BA8000                317             MOV DX, IC8255_PORTA_ADDR
0182 EE                    318             OUT DX, AL
                           319     
0183                       320     T2_NEXT1:
0183 59                    321                     POP     CX
0184 5B                    322                     POP     BX
0185 1F                    323                     POP     DS
0186 58                    324                     POP AX
0187 CB                    325                     RET
                           326     
                           327     TIMER2_ACTION   ENDP
                           328     
                           329     ;--------------------------------------------------------------
                           330     
----                       331     CODE_SEG        ENDS
                           332     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
