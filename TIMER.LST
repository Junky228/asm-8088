8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\USERS\ANGADS~1\DOWNLO~1\ASM\ASM\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; =========================================================================
                             5     
                             6     public  serial_rec_action, timer0_action, timer1_action, timer2_action
                             7     extrn   print_char:far, print_2hex:far, iodefine:far
                             8     extrn   Set_timer0:far, Set_timer1:far, Set_timer2:far, disable_timer0:far, disable_s
                                   erial:far, enable_serial:far
                             9     
----                        10     STACK_SEG       SEGMENT
0000 (256                   11                     DB      256 DUP(?)
     ??
     )
0100                        12             TOS     LABEL   WORD
----                        13     STACK_SEG       ENDS
                            14     
                            15     
                            16     ;----------------------------------------------------------------
                            17     ;--------------------DATA SEGMENT--------------------------------
                            18     ;----------------------------------------------------------------
                            19     
----                        20     DATA_SEG        SEGMENT
                            21     
                            22             ;-- String messages
0000 0A                     23             MAIN_MESS   DB  10,13,'Main Loop           '
0001 0D
0002 4D61696E204C6F
     6F702020202020
     202020202020
0016 0A                     24             TIMER0_MESS     DB      10,13,'TIMER0 INTERRUPT    '
0017 0D
0018 54494D45523020
     494E5445525255
     505420202020
002C 0A                     25             TIMER1_MESS     DB      10,13,'TIMER1 INTERRUPT    '
002D 0D
002E 54494D45523120
     494E5445525255
     505420202020
0042 0A                     26             TIMER2_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0043 0D
0044 54494D45523220
     494E5445525255
     505420202020
0058 0A                     27             KEY_PRESSED DB  10,13,'KEY PRESSED         '
0059 0D
005A 4B455920505245
     53534544202020
     202020202020
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

                            28     
006E 0A                     29             REC_MESS        DB  10,13,'INPUT RECEIVED      '
006F 0D
0070 494E5055542052
     45434549564544
     202020202020
                            30     
0084 5F5F4F50454E           31             OPEN_MESS       DB      '__OPEN'
008A 5F5F4954454D           32             ITEM_MESS       DB      '__ITEM'
0090 5F5F424152435F         33             BARCODE_MESS    DB  '__BARC_'
0097 5F5F5155414E5F         34             QUANTITY_MESS   DB      '__QUAN_'
                            35     
009E 00                     36             PRICE_I         DB      00H
009F 00                     37             PRICE_BCD       DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00A0 00
00A1 00
00A2 00
00A3 00
00A4 00
00A5 00
00A6 00
00A7 00                     38             PRICE_DEC       DB  00H
                            39             
00A8 69313030333634         40             PRODUCT1        DB      'i100364,1'
     2C31
00B1 69313233343537         41             PRODUCT2        DB      'i123457,1'     
     2C31
                            42             
00BA 0000                   43             DI_INC  DW 0000H
                            44     
                            45             ; -- Timers counters
                            46     
00BC 2F                     47             T0_COUNT                DB      2FH
00BD 2F                     48             T0_COUNT_SET    DB      2FH
00BE 2F                     49             T1_COUNT                DB      2FH
00BF 2F                     50             T1_COUNT_SET    DB      2FH
00C0 2F                     51             T2_COUNT                DB      2FH
00C1 2F                     52             T2_COUNT_SET    DB      2FH
                            53     
                            54             ; -- BCD and Keypad
                            55     
00C2 FE                     56             LED_SELECT  DB  0FEH
00C3 3F                     57             NUMBERS         DB      03FH, 006H, 05BH, 04FH, 066H, 06DH, 07DH, 007H, 07FH,
                                    06FH
00C4 06
00C5 5B
00C6 4F
00C7 66
00C8 6D
00C9 7D
00CA 07
00CB 7F
00CC 6F
00CD 00                     58             CURRENT_NUMBER DB 00H
00CE 00                     59             BARCODE         DB  00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

00CF 00
00D0 00
00D1 00
00D2 00
00D3 00
00D4 00
00D5 00
00D6 00
00D7 00
                            60             ;BARCODE                DB  03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 0
                                   3FH, 03FH
00D8 00                     61             BARCODE_DEC     DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00D9 00
00DA 00
00DB 00
00DC 00
00DD 00
00DE 00
00DF 00
00E0 00
00E1 00
00E2 00                     62             BARCODE_I       DB 00H
  0006                      63             BARCODE_LEN             EQU 6
00E3 (6                     64             BARCODE_BUFFER  DB BARCODE_LEN DUP(?)
     ??
     )
  0000                      65             BARCODE_TAIL    EQU 0
                            66             ;BARCODE_TAIL   EQU 0
                            67     
                            68     
00E9 00                     69             QUANTITY                DB  00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00EA 00
00EB 00
00EC 00
00ED 00
00EE 00
00EF 00
00F0 00
00F1 00
00F2 00
00F3 00                     70             QUANTITY_DEC    DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00F4 00
00F5 00
00F6 00
00F7 00
00F8 00
00F9 00
00FA 00
00FB 00
00FC 00
00FD 00                     71             QUANTITY_I              DB      00H
00FE 00                     72             QUANTITY_FLAG   DB      00H
00FF 00                     73             TEMP_FLAG               DB      00H
                            74     
                            75             ;TRANSMIT_ARR   DB      30 DUP(?)
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

                            76             ;TRANSMIT_C             DB      00H
                            77     
                            78             ;-- TODO: Add BCD Mappings
0100 7F                     79             ENTER_BARCODE DB        07FH, 07FH, 07FH, 07FH, 07FH, 07FH
0101 7F
0102 7F
0103 7F
0104 7F
0105 7F
0106 6F                     80             ENTER_QUANTITY  DB      06FH, 06FH, 06FH, 06FH, 06FH, 06FH 
0107 6F
0108 6F
0109 6F
010A 6F
010B 6F
                            81             
                            82             
010C 00                     83             KEYPAD_CURRENT_ROW DB 00H
010D FE                     84             KEYPAD_ROW      DB 0FEH; 
010E FC                     85             KEYPAD1_HASH            DB      0FCH, 0F3H, 0F5H, 0F6H, 0FBH, 0F9H, 0FAH, 0F9
                                   H, 0FDH, 0FCH, 0FAH
010F F3
0110 F5
0111 F6
0112 FB
0113 F9
0114 FA
0115 F9
0116 FD
0117 FC
0118 FA
0119 EE                     86             KEYPAD2_HASH    DB      0EEH, 0D7H, 0E7H, 0F7H, 0DBH, 0EBH, 0F3H, 0DDH, 0EDH,
                                    0F5H, 0DEH
011A D7
011B E7
011C F7
011D DB
011E EB
011F F3
0120 DD
0121 ED
0122 F5
0123 DE
                            87     
                            88             ; -- Voice
                            89     
0124 E703                   90             DESIRED_SOUND DW 999
0126 00000000               91             SOUND_ADDR                      DD      0
012A 0000                   92             SOUND_LEFT                      DW      0
012C 00000000               93             SOUND_BASE_ADDR         DD      0, 4713, 8481, 11945, 15315, 18317, 21614, 26
                                   120, 30013, 31809
0130 69120000
0134 21210000
0138 A92E0000
013C D33B0000
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

0140 8D470000
0144 6E540000
0148 08660000
014C 3D750000
0150 417C0000
0154 0B8D0000               94                                                     DD      36107, 39110, 43768, 47646, 5
                                   1847, 56124, 60775, 66907, 73225
0158 C6980000
015C F8AA0000
0160 1EBA0000
0164 87CA0000
0168 3CDB0000
016C 67ED0000
0170 5B050100
0174 091E0100
0178 B8320100               95                                                     DD      78520, 84565, 87674, 90326, 9
                                   3756, 96907, 101370, 106075, 109155
017C 554A0100
0180 7A560100
0184 D6600100
0188 3C6E0100
018C 8B7A0100
0190 FA8B0100
0194 5B9E0100
0198 63AA0100
019C D6B80100               96                                                     DD      112854, 115703, 118631, 12186
                                   7, 126347, 129602, 133161, 134469
01A0 F7C30100
01A4 67CF0100
01A8 0BDC0100
01AC 8BED0100
01B0 42FA0100
01B4 29080200
01B8 450D0200
01BC 87180200               97                                                     DD      137351, 141625, 146695, 15250
                                   3, 159103, 162214, 166331, 170638
01C0 39290200
01C4 073D0200
01C8 B7530200
01CC 7F6D0200
01D0 A6790200
01D4 BB890200
01D8 8E9A0200
01DC 99AE0200               98                                                     DD      175769, 178219, 181435, 18339
                                   1, 187071, 191560, 196299, 198222
01E0 2BB80200
01E4 BBC40200
01E8 5FCC0200
01EC BFDA0200
01F0 48EC0200
01F4 CBFE0200
01F8 4E060300
01FC 81120300               99                                                     DD      201345, 205826, 210477, 21377
                                   0, 216003, 219454, 225267, 229879
0200 02240300
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    6


LOC  OBJ                  LINE     SOURCE

0204 2D360300
0208 0A430300
020C C34B0300
0210 3E590300
0214 F36F0300
0218 F7810300
021C 98950300              100                                                     DD      234904, 242475, 249711, 25986
                                   2, 260667
0220 2BB30300
0224 6FCF0300
0228 16F70300
022C 3BFA0300
0230 6912                  101             SOUND_SIZE                      DW      4713, 3768, 3464, 3370, 3002, 3297, 4
                                   506, 3893, 1796, 4298
0232 B80E
0234 880D
0236 2A0D
0238 BA0B
023A E10C
023C 9A11
023E 350F
0240 0407
0242 CA10
0244 BB0B                  102                                                     DW      3003, 4658, 3878, 4201, 4277,
                                    4651, 6132, 6318, 5295, 6045
0246 3212
0248 260F
024A 6910
024C B510
024E 2B12
0250 F417
0252 AE18
0254 AF14
0256 9D17
0258 250C                  103                                                     DW      3109, 2652, 3430, 3151, 4463,
                                    4705, 3080, 3699, 2849, 2928
025A 5C0A
025C 660D
025E 4F0C
0260 6F11
0262 6112
0264 080C
0266 730E
0268 210B
026A 700B
026C A40C                  104                                                     DW      3236, 4480, 3255, 3559, 1308,
                                    2882, 4274, 5070, 5808, 6600
026E 8011
0270 B70C
0272 E70D
0274 1C05
0276 420B
0278 B210
027A CE13
027C B016
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    7


LOC  OBJ                  LINE     SOURCE

027E C819
0280 270C                  105                                                     DW      3111, 4117, 4307, 5131, 2450,
                                    3216, 1956, 3680, 4489, 4739
0282 1510
0284 D310
0286 0B14
0288 9209
028A 900C
028C A407
028E 600E
0290 8911
0292 8312
0294 8307                  106                                                     DW      1923, 3123, 4481, 4651, 3293,
                                    2233, 3451, 5813, 4612, 5025
0296 330C
0298 8111
029A 2B12
029C DD0C
029E B908
02A0 7B0D
02A2 B516
02A4 0412
02A6 A113
02A8 931D                  107                                                     DW      7571, 7236, 10151, 805, 800
02AA 441C
02AC A727
02AE 2503
02B0 2003
  0000                     108             SOUND_INIT                      EQU 0
  001C                     109             SOUND_HUNDRED           EQU     28
  001D                     110             SOUND_THOUSAND          EQU     29
  001E                     111             SOUND_PRODUCT           EQU     30
  0032                     112             SOUND_AND                       EQU     50
  0034                     113             SOUND_COST                      EQU     52
  0035                     114             SOUND_DOLLAR            EQU     53
  0036                     115             SOUND_CENT                      EQU     54
  0037                     116             SOUND_GREETING          EQU     55
  0038                     117             SOUND_MORNING           EQU     56
  0039                     118             SOUND_AFTERNOON         EQU     57
  003A                     119             SOUND_EVENING           EQU     58
  003B                     120             SOUND_PAY                       EQU     59
  003C                     121             SOUND_PURCHASE          EQU     60
  003D                     122             SOUND_CHANGE            EQU     61
  003E                     123             SOUND_EXIT                      EQU     62
  003F                     124             SOUND_BEEP                      EQU     63
  0040                     125             SOUND_SILENCE           EQU     64
  0020                     126             SOUND_QUEUE_LEN         EQU     32
02B2 (32                   127             SOUND_QUEUE                     DB      SOUND_QUEUE_LEN DUP(?)
     ??
     )
02D2 00                    128             SOUND_HEAD                      DB      0
02D3 00                    129             SOUND_TAIL                      DB      0
02D4 00                    130             SOUND_TEST_LEFT         DB      0
                           131             
02D5 0000                  132             TOTAL                           DW 0
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    8


LOC  OBJ                  LINE     SOURCE

                           133     
----                       134     DATA_SEG        ENDS
                           135     
                           136     ;----------------------------------------------------------------
                           137     ;--------------------DATA SEGMENT END----------------------------
                           138     ;----------------------------------------------------------------
                           139     
                           140     
                           141     ;----------------------------------------------------------------
                           142     ;--------------------CHIP SELECTS--------------------------------
                           143     ;----------------------------------------------------------------
                           144     ; 8255 register addresses
                           145     ; PCS1
  0080                     146     IC8255_PORTA_ADDR EQU 80H;
  0081                     147     IC8255_PORTB_ADDR EQU 81H;
  0082                     148     IC8255_PORTC_ADDR EQU 82H;
  0083                     149     IC8255_CW_ADDR    EQU 83H;
                           150     
  0100                     151     PCS2_ADDR EQU 100H
  0180                     152     PCS3_ADDR EQU 180H
  0200                     153     PCS4_ADDR EQU 200H
                           154     
  FFA6                     155     MMCS EQU 0FFA6H
  FFA8                     156     MPCS EQU 0FFA8H
                           157     
                           158     ;----------------------------------------------------------------
                           159     ;-------------------CHIP SELECT END------------------------------
                           160     ;----------------------------------------------------------------
                           161     
                           162     
                           163     ;----------------------------------------------------------------
                           164     ;--------------------CODE SEGMENT--------------------------------
                           165     ;----------------------------------------------------------------
                           166     
----                       167     CODE_SEG        SEGMENT
                           168             PUBLIC          START
                           169     ASSUME          CS:CODE_SEG, SS:STACK_SEG, DS:DATA_SEG
                           170     
0000                       171     START:
                           172     
                           173     ;-----------------------STACK AREA INIT--------------------------
0000 B8----         R      174             MOV     AX, STACK_SEG           
0003 8ED0                  175             MOV     SS, AX
0005 368B260001            176             MOV     SP, TOS
                           177     
000A B8----         R      178             MOV AX, DATA_SEG
000D 8ED8                  179             MOV DS, AX
                           180     ;----------------------------------------------------------------
                           181     
                           182     ;--------------ON-CHIP PERIPEHRALS--------------------------------
000F 9A0000----     E      183             CALL    FAR PTR IODEFINE
                           184             
                           185             ;IC8255 - Control Word
0014 BA8300                186             MOV DX, IC8255_CW_ADDR
                           187     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE    9


LOC  OBJ                  LINE     SOURCE

                           188             ;CW Register 
                           189             ;Port C Lower Input, Port C Upper Output 
                           190             ;Port B input, Port A output
                           191             ;1 0 0 0 0 0 1 0
0017 B082                  192             MOV AL, 82H
0019 EE                    193             OUT DX, AL
                           194     
                           195     ; Initialize MCS
                           196     
001A BAA6FF                197             MOV DX, MMCS
001D B80380                198             MOV     AX, 8003H
0020 EF                    199             OUT     DX, AX
                           200     
0021 BAA8FF                201             MOV DX, MPCS
0024 B88440                202             MOV AX, 4084H
0027 EF                    203             OUT DX, AX
                           204     
                           205     ;----------------------------------------------------------------
                           206     
                           207     ;This procedure generates 10ms delay at 5MHz
                           208     ;operating frequency, which corresponds to 
                           209     ;50,000 clock cycles.
                           210     ;DEBOUNCE PROC  NEAR
                           211     ;       PUSH    CX
                           212     ;       MOV CX, 094Ch ; 2380 dec
                           213     ;       BACK:           
                           214     ;               NOP       ; 3 clocks
                           215     ;       LOOP BACK; 18 clocks
                           216     ;       POP CX
                           217     ;       RET
                           218     ;DEBOUNCE ENDP
                           219     
                           220     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                           221     
                           222     ;------------------------Setting the timers---------------------
                           223         ;call Set_timer0
                           224             ;call Set_timer1
0028 9A0000----     E      225             call Set_timer2
002D FB                    226           STI
                           227     ;---------------------------------------------------------------
                           228     
002E                       229     NEXT:
                           230     ;----------------------------------------------------------------
                           231     ;--------------------MAIN LOOP INIT------------------------------
                           232     ;----------------------------------------------------------------
                           233     
                           234             ;slowing down the main loop
002E B9FF5F                235             MOV CX, 05FFFH ; 2380 dec
0031                       236             SLEEP:
0031 90                    237                     NOP
0032 E2FD                  238             LOOP SLEEP; 18 clocks
                           239     
                           240     ;----------------------------------------------------------------
                           241     ;--------------------START KEYPAD----------------------------------
                           242     ;----------------------------------------------------------------
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   10


LOC  OBJ                  LINE     SOURCE

0034 33C0                  243             XOR AX, AX
0036 D0060D01              244             ROL KEYPAD_ROW, 01H
003A 803E0D0177            245             CMP KEYPAD_ROW, 77H
003F 7402                  246             JE RESET_KEYPAD_ROW
0041 7505                  247             JNZ CHECK_KEYPAD_ROW
                           248     
0043                       249     RESET_KEYPAD_ROW:
0043 C6060D010E            250             MOV KEYPAD_ROW, 0EH
                           251     
0048                       252     CHECK_KEYPAD_ROW:
0048 A00D01                253             MOV AL, KEYPAD_ROW
004B BA8200                254             MOV DX, IC8255_PORTC_ADDR       ;DX = Port B Address
004E EE                    255             OUT DX, AL                                      ;
004F BA8100                256             MOV DX, IC8255_PORTB_ADDR       ;
                           257     
0052                       258     CHECK_KEY_CLOSED:                               ;Check when key is pressed. Keep loop
                                   ing here
0052 EC                    259             IN AL, DX                                       ;Move to AL, value in Port B.
                                    
                           260             
                           261             ;--TODO: Get rid of these compares
0053 3C00                  262             CMP AL, 00H
0055 74D7                  263             JE NEXT
0057 3C3F                  264             CMP AL, 03FH
0059 74D3                  265             JE NEXT
005B 3CFF                  266             CMP AL, 0FFH
005D 74CF                  267             JE NEXT
005F 3CBF                  268             CMP AL, 0BFH
0061 74CB                  269             JE NEXT
0063 3C7F                  270             CMP AL, 07FH
0065 74C7                  271             JE NEXT
0067 3C0F                  272             CMP AL, 0FH
0069 74C3                  273             JE NEXT
006B 3C08                  274             CMP AL, 08H
006D 74BF                  275             JE NEXT
                           276     
                           277             ;ANGAD'S SMARTASS HASHING ALGO
006F 22060D01              278             AND AL, KEYPAD_ROW
0073 8A260D01              279             MOV AH, KEYPAD_ROW
                           280     
0077 E80200                281             CALL NEAR PTR KEYPAD_PROCESS
                           282     
                           283     
                           284     ;----------------------------------------------------------------
                           285     ;--------------------END KEYPAD----------------------------------
                           286     ;----------------------------------------------------------------
007A EBB2                  287     JMP NEXT
                           288     
                           289     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
007C                       290     KEYPAD_PROCESS PROC NEAR
007C 50                    291             PUSH AX
007D 53                    292             PUSH BX
007E 51                    293             PUSH CX
007F 52                    294             PUSH DX
0080 1E                    295             PUSH DS
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   11


LOC  OBJ                  LINE     SOURCE

                           296     
0081 BA----         R      297             MOV     DX, DATA_SEG
0084 8EDA                  298             MOV     DS, DX
                           299     
                           300             ;-------Keypad 1------------
                           301     
0086 B90A00                302             MOV CX, 10
0089                       303             FIND_KEY:
0089 8BD9                  304                     MOV BX, CX
008B 8AA70E01              305                     MOV AH, KEYPAD1_HASH[BX]
008F 3AE0                  306                     CMP AH, AL
0091 7404                  307                     JE RESOLVE_COLLISION
0093 E2F4                  308             LOOP FIND_KEY
                           309     
0095 7574                  310             JNE KEYPAD2
                           311     
0097                       312             RESOLVE_COLLISION:
0097 A00D01                313                     MOV AL, KEYPAD_ROW
                           314     
                           315                     ;PUSH AX
                           316                     ;CALL FAR PTR PRINT_2HEX
                           317                     ;MOV AL, 0AH ;NEW LINE
                           318                     ;CALL   FAR PTR PRINT_CHAR
                           319                     ;MOV AL, 0DH ;CARRIAGE RETURN
                           320                     ;CALL   FAR PTR PRINT_CHAR
                           321                     ;POP AX
                           322     
009A 83F90A                323                     CMP CX, 10
009D 7435                  324                     JE COLLISION_6_STAR
009F 83F907                325                     CMP CX, 7
00A2 7439                  326                     JE COLLISION_7_5
00A4 83F909                327                     CMP CX, 9
00A7 743D                  328                     JE COLLISION_9_0
                           329     
00A9                       330             ADD_BARCODE:
00A9 8BD9                  331                     MOV BX, CX
00AB 8A87C300              332                     MOV AL, NUMBERS[BX]
00AF 8BCB                  333                     MOV CX, BX
00B1 8A1EE200              334                     MOV BL, BARCODE_I
00B5 8887CE00              335                     MOV BARCODE[BX], AL
00B9 888FD800              336                     MOV BARCODE_DEC[BX], CL
00BD FE06E200              337                     INC BARCODE_I
00C1 8A87D800              338                     MOV AL, BARCODE_DEC[BX]
00C5 0430                  339                     ADD AL, 48
00C7 9A0000----     E      340                     CALL FAR PTR PRINT_CHAR
00CC B03F                  341                     MOV AL, SOUND_BEEP
00CE E84D01                342                     CALL VOICE_ON_QUEUE
00D1 E9B200                343                     JMP KEYPAD_EXIT
                           344     
00D4                       345             COLLISION_6_STAR:
00D4 3CFE                  346                     CMP AL, 0FEH
00D6 7417                  347                     JE CLEAR
00D8 B90600                348                     MOV CX, 6
00DB EBCC                  349                     JMP ADD_BARCODE
                           350     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   12


LOC  OBJ                  LINE     SOURCE

00DD                       351             COLLISION_7_5:
00DD 3CFB                  352                     CMP AL, 0FBH
00DF 75C8                  353                     JNE ADD_BARCODE
00E1 B90500                354                     MOV CX, 5
00E4 EBC3                  355                     JMP ADD_BARCODE
                           356     
00E6                       357             COLLISION_9_0:
00E6 3CFE                  358                     CMP AL, 0FEH
00E8 75BF                  359                     JNE ADD_BARCODE
00EA B90000                360                     MOV CX, 0
00ED EBBA                  361                     JMP ADD_BARCODE
                           362     
00EF                       363             CLEAR:
00EF 33DB                  364                     XOR BX, BX
00F1 B90800                365                     MOV CX, 08H
00F4                       366                     CLEAR_BARCODE:
00F4 8BD9                  367                             MOV BX, CX
00F6 4B                    368                             DEC BX
00F7 C687CE0000            369                             MOV BARCODE[BX], 00H
00FC C687D80000            370                             MOV BARCODE_DEC[BX], 00H
0101 E2F1                  371                     LOOP CLEAR_BARCODE
0103 C606E20000            372                     MOV BARCODE_I, 00H
0108 EB7C90                373                     JMP KEYPAD_EXIT
                           374     
010B                       375             KEYPAD2:
010B B90A00                376                     MOV CX, 10
010E                       377                     FIND_KEY2:
010E 8BD9                  378                             MOV BX, CX
0110 8AA71901              379                             MOV AH, KEYPAD2_HASH[BX]
0114 3AE0                  380                             CMP AH, AL
0116 7402                  381                             JE PROCESS_COMMAND
0118 E2F4                  382                     LOOP FIND_KEY2
                           383     
011A                       384                     PROCESS_COMMAND:
011A 83F901                385                             CMP CX, 1
011D 7417                  386                             JE NEW_TRANSACTION
011F 83F902                387                             CMP CX, 2
0122 7426                  388                             JE NEW_ITEM
0124 83F903                389                             CMP CX, 3
0127 742B                  390                             JE SEND_BARCODE
0129 83F90A                391                             CMP CX, 10
012C 7437                  392                             JE SEND_QUANTITY
012E 83F905                393                             CMP CX, 5
0131 7444                  394                             JE DONE_TRANSACTION
0133 EB5190                395                             JMP KEYPAD_EXIT
                           396     
                           397                     ; New transaction
                           398                     ; Send [OP]EN to shop pc
                           399                     ; Play greeting
0136                       400                     NEW_TRANSACTION:
0136 B05F                  401                             MOV AL, '_'
0138 9A0000----     E      402                             CALL FAR PTR PRINT_CHAR
                           403                             ;MOV AL, ':'
                           404                             ;CALL FAR PTR PRINT_CHAR
013D B037                  405                             MOV AL, SOUND_GREETING
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   13


LOC  OBJ                  LINE     SOURCE

013F E8DC00                406                             CALL NEAR PTR VOICE_ON_QUEUE
0142 B039                  407                             MOV AL, SOUND_AFTERNOON
0144 E8D700                408                             CALL NEAR PTR VOICE_ON_QUEUE
0147 EB3D90                409                             JMP KEYPAD_EXIT
                           410     
                           411                     ; New item
                           412                     ; Send [IT]EM to shop pc
                           413                     ; Clear BCD
                           414                     ; Wait for user to input Barcode
014A                       415                     NEW_ITEM:
014A B03F                  416                             MOV AL, SOUND_BEEP
014C E8CF00                417                             CALL NEAR PTR VOICE_ON_QUEUE
014F EB9E                  418                             JMP CLEAR
0151 EB3390                419                             JMP KEYPAD_EXIT
                           420     
0154                       421                     SEND_BARCODE:
0154 B03F                  422                             MOV AL, SOUND_BEEP
0156 E8C500                423                             CALL NEAR PTR VOICE_ON_QUEUE
0159 B02C                  424                             MOV AL, ','
015B 9A0000----     E      425                             CALL FAR PTR PRINT_CHAR
0160 EB8D                  426                             JMP CLEAR
0162 EB2290                427                             JMP KEYPAD_EXIT
                           428     
0165                       429                     SEND_QUANTITY:
0165 B03F                  430                             MOV AL, SOUND_BEEP
0167 E8B400                431                             CALL NEAR PTR VOICE_ON_QUEUE
016A B06E                  432                             MOV AL, 'n'
016C 9A0000----     E      433                             CALL FAR PTR PRINT_CHAR
0171 E97BFF                434                             JMP CLEAR
0174 EB1090                435                             JMP KEYPAD_EXIT
                           436     
0177                       437                     DONE_TRANSACTION:
0177 B03F                  438                             MOV AL, SOUND_BEEP
0179 E8A200                439                             CALL NEAR PTR VOICE_ON_QUEUE
017C B074                  440                             MOV AL, 't'
017E 9A0000----     E      441                             CALL FAR PTR PRINT_CHAR
0183 E969FF                442                             JMP CLEAR
                           443     
                           444     
0186                       445     KEYPAD_EXIT:
0186 1F                    446             POP     DS
0187 5A                    447             POP DX
0188 59                    448             POP CX
0189 5B                    449             POP BX
018A 58                    450             POP AX
                           451     
018B C3                    452             RET
                           453     KEYPAD_PROCESS ENDP
                           454     
018C                       455     SAY_PRICE PROC NEAR
018C 50                    456             PUSH AX
                           457             ;MOV AX, TOTAL
018D B038                  458             MOV AL, SOUND_MORNING
018F E88C00                459             CALL NEAR PTR VOICE_ON_QUEUE
                           460     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   14


LOC  OBJ                  LINE     SOURCE

0192 B89800                461             MOV AX, 152             ;1 hundred fifty 2
0195 E80200                462             CALL NEAR PTR PRICE_ON_QUEUE
                           463             
0198 58                    464             POP AX
0199 C3                    465             RET
                           466     SAY_PRICE ENDP
                           467     
019A                       468     PRICE_ON_QUEUE PROC NEAR
019A 60                    469             PUSHA
                           470             
                           471             ; Divide out dollars and cents, dollars in AX, cents in DX
019B BA0000                472             MOV DX, 0
019E B96400                473             MOV CX, 100
01A1 F7F1                  474             DIV CX
                           475             
                           476             ;Please pay
01A3 B03B                  477             MOV AL, SOUND_PAY
01A5 E87600                478             CALL NEAR PTR VOICE_ON_QUEUE
                           479     
                           480             ; Push dollars
01A8 E81600                481             CALL NEAR PTR NUMBER_ON_QUEUE
                           482             
                           483             ; "Dollars"
01AB B035                  484             MOV AL, SOUND_DOLLAR
01AD E86E00                485             CALL NEAR PTR VOICE_ON_QUEUE
                           486             
                           487             ; "And"
01B0 B032                  488             MOV AL, SOUND_AND
01B2 E86900                489             CALL NEAR PTR VOICE_ON_QUEUE
                           490             
                           491             ; Push cents
01B5 8BC2                  492             MOV AX, DX
01B7 E80700                493             CALL NEAR PTR NUMBER_ON_QUEUE
                           494             
                           495             ; "Cents"
01BA B036                  496             MOV AL, SOUND_CENT
01BC E85F00                497             CALL NEAR PTR VOICE_ON_QUEUE
                           498             
01BF 61                    499             POPA
01C0 C3                    500             RET
                           501     PRICE_ON_QUEUE ENDP
                           502     
                           503     ; Pushes number onto queue, do not care about buffer overflow
                           504     ; Always do speech in main program, since interrupts might change SOUND_HEAD arbitrar
                                   y
                           505     ; Input: AX contains the value
                           506     ; 0 to 999 can be represented
01C1                       507     NUMBER_ON_QUEUE PROC NEAR
01C1 60                    508             PUSHA
                           509             
                           510             ; Check whether it is less than 100
01C2 8BD0                  511             MOV DX, AX
01C4 81FAE803              512             CMP DX, 1000
01C8 7812                  513             JS NUMBER_ON_QUEUE_SKIP_THOUSAND
                           514             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   15


LOC  OBJ                  LINE     SOURCE

                           515             ; Converting hundred place
01CA 8BC2                  516             MOV AX, DX
01CC BA0000                517             MOV DX, 0
01CF B9E803                518             MOV CX, 1000
01D2 F7F1                  519             DIV CX
                           520             
                           521             ; AX consists of the hundred place digit
01D4 E84700                522             CALL NEAR PTR VOICE_ON_QUEUE
                           523             
                           524             ; "Hundred"
01D7 B01D                  525             MOV AL, SOUND_THOUSAND
01D9 E84200                526             CALL NEAR PTR VOICE_ON_QUEUE
                           527             
01DC                       528     NUMBER_ON_QUEUE_SKIP_THOUSAND:
                           529             ; Check whether it is less than 100
01DC 8BD0                  530             MOV DX, AX
01DE 83FA64                531             CMP DX, 100
01E1 7812                  532             JS NUMBER_ON_QUEUE_SKIP_HUNDERD
                           533             
                           534             ; Converting hundred place
01E3 8BC2                  535             MOV AX, DX
01E5 BA0000                536             MOV DX, 0
01E8 B96400                537             MOV CX, 100
01EB F7F1                  538             DIV CX
                           539             
                           540             ; AX consists of the hundred place digit
01ED E82E00                541             CALL NEAR PTR VOICE_ON_QUEUE
                           542             
                           543             ; "Hundred"
01F0 B01C                  544             MOV AL, SOUND_HUNDRED
01F2 E82900                545             CALL NEAR PTR VOICE_ON_QUEUE
                           546     
01F5                       547     NUMBER_ON_QUEUE_SKIP_HUNDERD:
                           548      
                           549             ; Check whether remainder is 20 or less
01F5 83FA15                550             CMP DX, 21
01F8 7908                  551             JNS NUMBER_ON_QUEUE_GREATER_TWENTY
                           552             
                           553             ; Twenty or less
01FA 8AC2                  554             MOV AL, DL
01FC E81F00                555             CALL NEAR PTR VOICE_ON_QUEUE
                           556             
01FF EB1B90                557             JMP NUMBER_ON_QUEUE_EXIT
                           558             
0202                       559     NUMBER_ON_QUEUE_GREATER_TWENTY:
                           560     
                           561             ; Converting tens place
0202 8BC2                  562             MOV AX, DX
0204 BA0000                563             MOV DX, 0
0207 B90A00                564             MOV CX, 10
020A F7F1                  565             DIV CX
                           566             
                           567             ; AX consists of the tens place
020C 051200                568             ADD AX, 18
020F E80C00                569             CALL NEAR PTR VOICE_ON_QUEUE
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   16


LOC  OBJ                  LINE     SOURCE

                           570             
                           571             ; DX consists of the ones place
0212 83FA00                572             CMP DX, 0
0215 7405                  573             JE NUMBER_ON_QUEUE_EXIT
                           574             
0217 8AC2                  575             MOV AL, DL
0219 E80200                576             CALL NEAR PTR VOICE_ON_QUEUE
                           577     
021C                       578     NUMBER_ON_QUEUE_EXIT:
                           579     
021C 61                    580             POPA
021D C3                    581             RET
                           582     NUMBER_ON_QUEUE ENDP
                           583     ;------------------------------------------------
                           584     
                           585     
                           586     ;------------------VOICE-------------------------
021E                       587     VOICE_ON_QUEUE PROC NEAR
021E 50                    588             PUSH AX
021F 53                    589             PUSH BX
0220 52                    590             PUSH DX
0221 1E                    591             PUSH DS
                           592             
0222 BA----         R      593             MOV     DX, DATA_SEG
0225 8EDA                  594             MOV     DS, DX
                           595     
0227 B700                  596             MOV BH, 0
0229 8A1ED202              597             MOV BL, BYTE PTR SOUND_HEAD
022D 8887B202              598             MOV BYTE PTR SOUND_QUEUE[BX], AL
0231 FEC3                  599             INC BL
                           600     
0233 80FB20                601             CMP BL, SOUND_QUEUE_LEN
0236 7502                  602             JNE VOICE_ON_QUEUE_STALL
                           603             
0238 B300                  604             MOV BL, 0
                           605             
023A                       606     VOICE_ON_QUEUE_STALL:
                           607                     
023A 881ED202              608             MOV BYTE PTR SOUND_HEAD, BL
023E 9A0000----     E      609             CALL    FAR PTR Set_timer0
                           610             
0243 1F                    611             POP     DS
0244 5A                    612             POP DX
0245 5B                    613             POP BX
0246 58                    614             POP AX
                           615             
0247 C3                    616             RET
                           617     VOICE_ON_QUEUE ENDP
                           618     
                           619     
0248                       620     SERIAL_REC_ACTION       PROC    FAR
0248 51                    621                     PUSH    CX
0249 53                    622                     PUSH    BX
024A 1E                    623                     PUSH    DS
                           624     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   17


LOC  OBJ                  LINE     SOURCE

024B BB----         R      625                     MOV     BX,DATA_SEG             ;initialize data segment register
024E 8EDB                  626                     MOV     DS,BX
                           627     
0250 3C2E                  628                     CMP AL, '.'
0252 7443                  629                     JE ADD_DECIMAL
                           630     
                           631                     ;CMP AL, '$'
                           632                     ;JE VOICE_PRICE
                           633                     
0254 3C30                  634                     CMP     AL, '0'
0256 7C74                  635                     JL S_RET
                           636     
0258 FE06BD00              637                     INC     DS:T0_COUNT_SET
025C FE06BD00              638                     INC     DS:T0_COUNT_SET
                           639     
                           640     
0260                       641     DISP_PRICE:
                           642     
0260 33DB                  643             XOR BX, BX
0262 8AD8                  644             MOV BL, AL
0264 80EB30                645             SUB BL, 48
0267 8A87C300              646             MOV AL, NUMBERS[BX]
026B 8BCB                  647             MOV CX, BX
026D 8A1EE200              648             MOV BL, BARCODE_I
0271 8887CE00              649             MOV BARCODE[BX], AL
0275 888FD800              650             MOV BARCODE_DEC[BX], CL
0279 FE06E200              651             INC BARCODE_I
                           652     
027D 33C0                  653             XOR AX, AX
027F 33C9                  654             XOR CX, CX
0281 A1D502                655             MOV AX, TOTAL
0284 B90A00                656             MOV CX, 10
0287 F7E1                  657             MUL CX
0289 8A8FD800              658             MOV CL, BARCODE_DEC[BX]
028D 32ED                  659             XOR CH, CH
028F 03C1                  660             ADD AX, CX
0291 A3D502                661             MOV TOTAL, AX
                           662     ;       MOV BL, AH
                           663     ;       XOR AH, AH
                           664     ;       CALL FAR PTR PRINT_2HEX
                           665     ;       MOV AL, BL
                           666     ;       CALL FAR PTR PRINT_2HEX
                           667     ;       MOV AL, 0AH
                           668     ;       CALL FAR PTR PRINT_CHAR
                           669     
0294 EB3690                670             JMP S_RET
                           671     
0297                       672     ADD_DECIMAL:
0297 8A1EE200              673             MOV BL, BARCODE_I
029B FECB                  674             DEC BL
029D 8A87CE00              675             MOV AL, BARCODE[BX]
02A1 0C80                  676             OR AL, 80H
02A3 8887CE00              677             MOV BARCODE[BX], AL
02A7 EB2390                678             JMP S_RET
                           679     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   18


LOC  OBJ                  LINE     SOURCE

                           680     ;VOICE_PRICE:
                           681             
                           682     ;       XOR AX, AX
                           683     ;       MOV AX, TOTAL
                           684     ;       CALL NEAR PTR SAY_PRICE
                           685     ;       JMP S_RET
                           686     
02AA                       687     S_FAST:
02AA 3C01                  688                     CMP     AL,01H
02AC 751E                  689                     JNE     S_RET
                           690     
02AE FE0EBD00              691                     DEC     DS:T0_COUNT_SET
02B2 FE0EBD00              692                     DEC     DS:T0_COUNT_SET
                           693     
02B6                       694     S_NEXT0:
02B6 B90F00                695                     MOV     CX,15                   ;initialize counter for message
02B9 BB0000                696                     MOV     BX,0
                           697     
02BC                       698     S_NEXT1:        
02BC 8A476E                699                     MOV     AL,DS:REC_MESS[BX]      ;print message
02BF 9A0000----     E      700                     call    FAR ptr print_char
02C4 43                    701                     INC     BX
02C5 E2F5                  702                     LOOP    S_NEXT1
02C7 B037                  703                     MOV AL, SOUND_GREETING
02C9 E852FF                704                     CALL NEAR PTR VOICE_ON_QUEUE
                           705     
02CC                       706     S_RET:
02CC 1F                    707                     POP     DS
02CD 5B                    708                     POP     BX
02CE 59                    709                     POP     CX
02CF CB                    710                     RET
                           711     SERIAL_REC_ACTION       ENDP
                           712     
                           713     
                           714     ;--------------------------------------------------------------
                           715     
                           716     ;--------------------TIMER 0 ----------------------------------
                           717     
02D0                       718     TIMER0_ACTION   PROC    FAR
02D0 50                    719                     PUSH    AX
02D1 1E                    720                     PUSH    DS
02D2 53                    721                     PUSH    BX
02D3 51                    722                     PUSH    CX
                           723     
02D4 33C0                  724             XOR AX,AX
02D6 33DB                  725             XOR BX,BX
02D8 33C9                  726             XOR CX,CX
02DA 33D2                  727             XOR DX,DX
                           728     
02DC B8----         R      729             MOV     AX,DATA_SEG
02DF 8ED8                  730             MOV     DS,AX
                           731             
                           732             ;slowing down the timer 
                           733             ;MOV CX, 04FFFH ; 2380 dec
                           734             ;SLEEP_TIMER:
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   19


LOC  OBJ                  LINE     SOURCE

                           735             ;       NOP
                           736             ;LOOP SLEEP_TIMER; 18 clocks
                           737     
                           738     ;----------------------------------------------------
                           739             ; SOUND_LEFT: Number of bytes left in the queue
02E1 833E2A0100            740             CMP WORD PTR SOUND_LEFT, 0
02E6 7544                  741             JNE timer0_ACTION_PROCEED
                           742             
                           743             ; Reload with next item in the queue
02E8 B700                  744             MOV BH, 0
02EA 8A1ED302              745             MOV BL, BYTE PTR SOUND_TAIL
                           746             
02EE 381ED202              747             CMP BYTE PTR SOUND_HEAD, BL
02F2 7508                  748             JNE timer0_ACTION_RELOAD
                           749             
                           750             ;disable timer 0, freeing up resources
02F4 9A0000----     E      751             call disable_timer0
                           752      
02F9 EB6690                753             JMP T0_NEXT1
                           754             
02FC                       755     timer0_ACTION_RELOAD:
                           756             
02FC 8A9FB202              757             MOV BL, BYTE PTR SOUND_QUEUE[BX]
0300 BE2C01                758             MOV SI, OFFSET SOUND_BASE_ADDR
                           759                     
0303 C1E302                760             SHL BX, 2
0306 8B00                  761             MOV AX, WORD PTR [BX][SI]
                           762      
0308 A32601                763             MOV WORD PTR SOUND_ADDR[0], AX
                           764             
030B 8B4002                765             MOV AX, WORD PTR 2[BX][SI]      
030E A32801                766             MOV WORD PTR SOUND_ADDR[2], AX
                           767             
0311 D1EB                  768             SHR BX, 1
0313 BE3002                769             MOV SI, OFFSET SOUND_SIZE
0316 8B00                  770             MOV AX, WORD PTR [BX][SI]
0318 A32A01                771             MOV WORD PTR SOUND_LEFT, AX
031B A0D302                772             MOV AL, BYTE PTR SOUND_TAIL
031E FEC0                  773             INC AL
0320 3C20                  774             CMP AL, SOUND_QUEUE_LEN
0322 7502                  775             JNE timer0_QUEUE_NO_OVERFLOW
                           776             
0324 B000                  777             MOV AL, 0
                           778             
0326                       779     timer0_QUEUE_NO_OVERFLOW:
                           780     
0326 A2D302                781             MOV BYTE PTR SOUND_TAIL, AL
0329 EB3690                782             JMP T0_NEXT1
                           783             
032C                       784     timer0_ACTION_PROCEED:
                           785     
032C FF0E2A01              786             DEC WORD PTR SOUND_LEFT
                           787             
0330 8B362601              788             MOV SI, WORD PTR SOUND_ADDR[0]
0334 8B3E2801              789             MOV DI, WORD PTR SOUND_ADDR[2]
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   20


LOC  OBJ                  LINE     SOURCE

                           790     
                           791             ; SI - Intra-segment address, DI - Segment address
0338 83C708                792             ADD DI, 8H
033B C1E70C                793             SHL DI, 12
                           794     
                           795             ; Set extra segment to point to 8000H, the starting segment of the EEPROM
033E 8EDF                  796             MOV DS, DI
                           797              
                           798             ; Get byte from EEPROM address space
0340 8A04                  799             MOV AL, [SI]
                           800             
                           801             ; Put byte to DAC
0342 BA0002                802             MOV DX, PCS4_ADDR
0345 EE                    803             OUT DX, AL
                           804             
                           805             ; Increment EEPROM address to move to the next sample
0346 B8----         R      806             MOV AX, DATA_SEG
0349 8ED8                  807             MOV DS, AX
                           808     
034B FF062601              809             INC WORD PTR SOUND_ADDR[0]
034F 7510                  810             JNZ T0_NEXT1
                           811     
                           812             ; Increment memory segment
0351 FF062801              813             INC WORD PTR SOUND_ADDR[2]
                           814     
                           815     ;---------------------------------------------
                           816     
                           817     
0355 FE0EBC00              818             DEC     DS:T0_COUNT
0359 7506                  819             JNZ     T0_NEXT1
035B A0BD00                820             MOV     AL,DS:T0_COUNT_SET
035E A2BC00                821             MOV     DS:T0_COUNT,AL
                           822     
0361                       823     T0_NEXT1:
                           824     ;T0_NEXT1:
0361 59                    825             POP     CX
0362 5B                    826             POP     BX
0363 1F                    827             POP     DS
0364 58                    828             POP AX
0365 CB                    829             RET
                           830     TIMER0_ACTION   ENDP
                           831     
                           832     ;--------------------------------------------------------------
                           833     
                           834     ;--------------------TIMER 1 ----------------------------------
                           835     
0366                       836     TIMER1_ACTION   PROC    FAR
0366 50                    837                     PUSH    AX
0367 1E                    838                     PUSH    DS
0368 53                    839                     PUSH    BX
0369 51                    840                     PUSH    CX
                           841     
036A B8----         R      842                     MOV     AX,DATA_SEG
036D 8ED8                  843                     MOV     DS,AX
                           844             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   21


LOC  OBJ                  LINE     SOURCE

036F FE0EBE00              845                     DEC     DS:T1_COUNT
0373 7517                  846                     JNZ     T1_NEXT1
0375 A0BF00                847                     MOV     AL,DS:T1_COUNT_SET
0378 A2BE00                848                     MOV     DS:T1_COUNT,AL
                           849     
037B B91400                850                     MOV     CX,20
037E BB0000                851                     MOV     BX,0H
0381                       852     T1_NEXT0:
0381 8A472C                853                     MOV     AL,DS:TIMER1_MESS[BX]
0384 43                    854                     INC     BX
0385 9A0000----     E      855                     CALL    FAR PTR PRINT_CHAR
038A E2F5                  856                     LOOP    T1_NEXT0
                           857     
038C                       858     T1_NEXT1:       
038C 59                    859                     POP     CX
038D 5B                    860                     POP     BX
038E 1F                    861                     POP     DS
038F 58                    862                     POP     AX
0390 CB                    863                     RET
                           864     TIMER1_ACTION   ENDP
                           865     
                           866     ;--------------------------------------------------------------
                           867     
                           868     ;--------------------TIMER 2 ----------------------------------
                           869     
                           870     
0391                       871     TIMER2_ACTION   PROC    FAR
0391 50                    872                     PUSH    AX
0392 1E                    873                     PUSH    DS
0393 53                    874                     PUSH    BX
0394 51                    875                     PUSH    CX
                           876     
0395 33C0                  877                     XOR AX, AX
0397 33DB                  878                     XOR BX, BX
                           879                     
                           880                     
                           881     ;----------------------------
                           882                     ;AD0 - AD5 PCS3 CS for 7-segment
                           883                     ;7  6  5  4  3  2  1  0
                           884                     ;x  x  A5 A4 A3 A2 A1 A0
0399 BA8001                885                     MOV DX, PCS3_ADDR
039C A0C200                886                     MOV AL, LED_SELECT
                           887                     ;MOV AL, 00111110B
039F EE                    888                     OUT DX, AL
03A0 D006C200              889                     ROL LED_SELECT, 01H
                           890     
                           891                     ;AD0 - AD7 PCS2
                           892                     ;AD7 - DOT (MSB)
                           893                     
03A4 BA0001                894                     MOV DX, PCS2_ADDR
03A7 8A1ECD00              895                     MOV BL, CURRENT_NUMBER
03AB 8A87CE00              896                     MOV AL, BARCODE[BX]
                           897                     ;MOV AL, 01111111B
03AF EE                    898                     OUT DX, AL
03B0 FE06CD00              899                     INC CURRENT_NUMBER
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    00:34:41  12/05/;2  PAGE   22


LOC  OBJ                  LINE     SOURCE

03B4 803ECD0008            900                     CMP CURRENT_NUMBER, 08H
03B9 7411                  901                     JE RESET_CURRENT
03BB 7523                  902                     JNE T2_NEXT1
                           903     ;---------------------------
03BD FE0EC000              904                     DEC     DS:T2_COUNT
03C1 751D                  905                     JNZ     T2_NEXT1
03C3 A0C100                906                     MOV     AL,DS:T2_COUNT_SET
03C6 A2C000                907                     MOV     DS:T2_COUNT,AL
03C9 BB0000                908                     MOV     BX,0H
                           909                     
03CC                       910     RESET_CURRENT:
03CC C606CD0000            911                     MOV CURRENT_NUMBER, 00H
03D1 FE0EC000              912                     DEC     DS:T2_COUNT
03D5 7509                  913                     JNZ     T2_NEXT1
03D7 A0C100                914                     MOV     AL,DS:T2_COUNT_SET
03DA A2C000                915                     MOV     DS:T2_COUNT,AL
03DD BB0000                916                     MOV     BX,0H
                           917     
03E0                       918     T2_NEXT1:
03E0 59                    919                     POP     CX
03E1 5B                    920                     POP     BX
03E2 1F                    921                     POP     DS
03E3 58                    922                     POP AX
03E4 CB                    923                     RET
                           924     
                           925     TIMER2_ACTION   ENDP
                           926     
                           927     ;--------------------------------------------------------------
                           928     
----                       929     CODE_SEG        ENDS
                           930     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
