8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\USERS\ANGADS~1\DOWNLO~1\ASM\ASM\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; =========================================================================
                             5     
                             6     public  serial_rec_action, timer0_action, timer1_action, timer2_action
                             7     extrn   print_char:far, print_2hex:far, iodefine:far
                             8     extrn   Set_timer0:far, Set_timer1:far, Set_timer2:far, disable_timer0:far
                             9     
----                        10     STACK_SEG       SEGMENT
0000 (256                   11                     DB      256 DUP(?)
     ??
     )
0100                        12             TOS     LABEL   WORD
----                        13     STACK_SEG       ENDS
                            14     
                            15     
                            16     ;----------------------------------------------------------------
                            17     ;--------------------DATA SEGMENT--------------------------------
                            18     ;----------------------------------------------------------------
                            19     
----                        20     DATA_SEG        SEGMENT
                            21     
                            22             ;-- String messages
0000 0A                     23             MAIN_MESS   DB  10,13,'Main Loop           '
0001 0D
0002 4D61696E204C6F
     6F702020202020
     202020202020
0016 0A                     24             TIMER0_MESS     DB      10,13,'TIMER0 INTERRUPT    '
0017 0D
0018 54494D45523020
     494E5445525255
     505420202020
002C 0A                     25             TIMER1_MESS     DB      10,13,'TIMER1 INTERRUPT    '
002D 0D
002E 54494D45523120
     494E5445525255
     505420202020
0042 0A                     26             TIMER2_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0043 0D
0044 54494D45523220
     494E5445525255
     505420202020
0058 0A                     27             KEY_PRESSED DB  10,13,'KEY PRESSED         '
0059 0D
005A 4B455920505245
     53534544202020
     202020202020
                            28     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

006E 0A                     29             REC_MESS        DB  10,13,'INPUT RECEIVED      '
006F 0D
0070 494E5055542052
     45434549564544
     202020202020
                            30     
0084 5F5F4F50454E           31             OPEN_MESS       DB      '__OPEN'
008A 5F5F4954454D           32             ITEM_MESS       DB      '__ITEM'
0090 5F5F424152435F         33             BARCODE_MESS    DB  '__BARC_'
0097 5F5F5155414E5F         34             QUANTITY_MESS   DB      '__QUAN_'
                            35     
009E 00                     36             PRICE_I         DB      00H
009F 00                     37             PRICE_BCD       DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00A0 00
00A1 00
00A2 00
00A3 00
00A4 00
00A5 00
00A6 00
00A7 00                     38             PRICE_DEC       DB  00H
                            39             
00A8 69313030333634         40             PRODUCT1        DB      'i100364,1'
     2C31
00B1 69313233343537         41             PRODUCT2        DB      'i123457,1'     
     2C31
                            42             
00BA 0000                   43             DI_INC  DW 0000H
                            44     
                            45             ; -- Timers counters
                            46     
00BC 2F                     47             T0_COUNT                DB      2FH
00BD 2F                     48             T0_COUNT_SET    DB      2FH
00BE 2F                     49             T1_COUNT                DB      2FH
00BF 2F                     50             T1_COUNT_SET    DB      2FH
00C0 2F                     51             T2_COUNT                DB      2FH
00C1 2F                     52             T2_COUNT_SET    DB      2FH
                            53     
                            54             ; -- BCD and Keypad
                            55     
00C2 FE                     56             LED_SELECT  DB  0FEH
00C3 3F                     57             NUMBERS         DB      03FH, 006H, 05BH, 04FH, 066H, 06DH, 07DH, 007H, 07FH,
                                    06FH
00C4 06
00C5 5B
00C6 4F
00C7 66
00C8 6D
00C9 7D
00CA 07
00CB 7F
00CC 6F
00CD 00                     58             CURRENT_NUMBER DB 00H
00CE 00                     59             BARCODE         DB  00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00CF 00
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

00D0 00
00D1 00
00D2 00
00D3 00
00D4 00
00D5 00
00D6 00
00D7 00
                            60             ;BARCODE                DB  03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 0
                                   3FH, 03FH
00D8 00                     61             BARCODE_DEC     DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00D9 00
00DA 00
00DB 00
00DC 00
00DD 00
00DE 00
00DF 00
00E0 00
00E1 00
00E2 00                     62             BARCODE_I       DB 00H
  0006                      63             BARCODE_LEN             EQU 6
00E3 (6                     64             BARCODE_BUFFER  DB BARCODE_LEN DUP(?)
     ??
     )
  0000                      65             BARCODE_TAIL    EQU 0
                            66             ;BARCODE_TAIL   EQU 0
                            67     
                            68     
00E9 00                     69                     QUANTITY                DB  00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 0
                                   0H, 00H
00EA 00
00EB 00
00EC 00
00ED 00
00EE 00
00EF 00
00F0 00
00F1 00
00F2 00
00F3 00                     70             QUANTITY_DEC    DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00F4 00
00F5 00
00F6 00
00F7 00
00F8 00
00F9 00
00FA 00
00FB 00
00FC 00
00FD 00                     71             QUANTITY_I              DB      00H
00FE 00                     72             QUANTITY_FLAG   DB      00H
00FF 00                     73             TEMP_FLAG               DB      00H
                            74     
0100 (8                     75             TRANSMIT_ARR    DB      8 DUP(?)
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

     ??
     )
0108 00                     76             TRANSMIT_C              DB      0
                            77     
                            78             ;-- TODO: Add BCD Mappings
0109 7F                     79             ENTER_BARCODE DB        07FH, 07FH, 07FH, 07FH, 07FH, 07FH
010A 7F
010B 7F
010C 7F
010D 7F
010E 7F
010F 6F                     80             ENTER_QUANTITY  DB      06FH, 06FH, 06FH, 06FH, 06FH, 06FH 
0110 6F
0111 6F
0112 6F
0113 6F
0114 6F
                            81             
                            82             
0115 00                     83             KEYPAD_CURRENT_ROW DB 00H
0116 FE                     84             KEYPAD_ROW      DB 0FEH; 
0117 FC                     85             KEYPAD1_HASH            DB      0FCH, 0F3H, 0F5H, 0F6H, 0FBH, 0F9H, 0FAH, 0F9
                                   H, 0FDH, 0FCH, 0FAH
0118 F3
0119 F5
011A F6
011B FB
011C F9
011D FA
011E F9
011F FD
0120 FC
0121 FA
0122 EE                     86             KEYPAD2_HASH    DB      0EEH, 0D7H, 0E7H, 0F7H, 0DBH, 0EBH, 0F3H, 0DDH, 0EDH,
                                    0F5H, 0DEH
0123 D7
0124 E7
0125 F7
0126 DB
0127 EB
0128 F3
0129 DD
012A ED
012B F5
012C DE
                            87     
                            88             ; -- Voice
                            89     
012D E703                   90             DESIRED_SOUND DW 999
012F 00000000               91             SOUND_ADDR                      DD      0
0133 0000                   92             SOUND_LEFT                      DW      0
0135 00000000               93             SOUND_BASE_ADDR         DD      0, 4713, 8481, 11945, 15315, 18317, 21614, 26
                                   120, 30013, 31809
0139 69120000
013D 21210000
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

0141 A92E0000
0145 D33B0000
0149 8D470000
014D 6E540000
0151 08660000
0155 3D750000
0159 417C0000
015D 0B8D0000               94                                                     DD      36107, 39110, 43768, 47646, 5
                                   1847, 56124, 60775, 66907, 73225
0161 C6980000
0165 F8AA0000
0169 1EBA0000
016D 87CA0000
0171 3CDB0000
0175 67ED0000
0179 5B050100
017D 091E0100
0181 B8320100               95                                                     DD      78520, 84565, 87674, 90326, 9
                                   3756, 96907, 101370, 106075, 109155
0185 554A0100
0189 7A560100
018D D6600100
0191 3C6E0100
0195 8B7A0100
0199 FA8B0100
019D 5B9E0100
01A1 63AA0100
01A5 D6B80100               96                                                     DD      112854, 115703, 118631, 12186
                                   7, 126347, 129602, 133161, 134469
01A9 F7C30100
01AD 67CF0100
01B1 0BDC0100
01B5 8BED0100
01B9 42FA0100
01BD 29080200
01C1 450D0200
01C5 87180200               97                                                     DD      137351, 141625, 146695, 15250
                                   3, 159103, 162214, 166331, 170638
01C9 39290200
01CD 073D0200
01D1 B7530200
01D5 7F6D0200
01D9 A6790200
01DD BB890200
01E1 8E9A0200
01E5 99AE0200               98                                                     DD      175769, 178219, 181435, 18339
                                   1, 187071, 191560, 196299, 198222
01E9 2BB80200
01ED BBC40200
01F1 5FCC0200
01F5 BFDA0200
01F9 48EC0200
01FD CBFE0200
0201 4E060300
0205 81120300               99                                                     DD      201345, 205826, 210477, 21377
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    6


LOC  OBJ                  LINE     SOURCE

                                   0, 216003, 219454, 225267, 229879
0209 02240300
020D 2D360300
0211 0A430300
0215 C34B0300
0219 3E590300
021D F36F0300
0221 F7810300
0225 98950300              100                                                     DD      234904, 242475, 249711, 25986
                                   2, 260667
0229 2BB30300
022D 6FCF0300
0231 16F70300
0235 3BFA0300
0239 6912                  101             SOUND_SIZE                      DW      4713, 3768, 3464, 3370, 3002, 3297, 4
                                   506, 3893, 1796, 4298
023B B80E
023D 880D
023F 2A0D
0241 BA0B
0243 E10C
0245 9A11
0247 350F
0249 0407
024B CA10
024D BB0B                  102                                                     DW      3003, 4658, 3878, 4201, 4277,
                                    4651, 6132, 6318, 5295, 6045
024F 3212
0251 260F
0253 6910
0255 B510
0257 2B12
0259 F417
025B AE18
025D AF14
025F 9D17
0261 250C                  103                                                     DW      3109, 2652, 3430, 3151, 4463,
                                    4705, 3080, 3699, 2849, 2928
0263 5C0A
0265 660D
0267 4F0C
0269 6F11
026B 6112
026D 080C
026F 730E
0271 210B
0273 700B
0275 A40C                  104                                                     DW      3236, 4480, 3255, 3559, 1308,
                                    2882, 4274, 5070, 5808, 6600
0277 8011
0279 B70C
027B E70D
027D 1C05
027F 420B
0281 B210
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    7


LOC  OBJ                  LINE     SOURCE

0283 CE13
0285 B016
0287 C819
0289 270C                  105                                                     DW      3111, 4117, 4307, 5131, 2450,
                                    3216, 1956, 3680, 4489, 4739
028B 1510
028D D310
028F 0B14
0291 9209
0293 900C
0295 A407
0297 600E
0299 8911
029B 8312
029D 8307                  106                                                     DW      1923, 3123, 4481, 4651, 3293,
                                    2233, 3451, 5813, 4612, 5025
029F 330C
02A1 8111
02A3 2B12
02A5 DD0C
02A7 B908
02A9 7B0D
02AB B516
02AD 0412
02AF A113
02B1 931D                  107                                                     DW      7571, 7236, 10151, 805, 800
02B3 441C
02B5 A727
02B7 2503
02B9 2003
  0000                     108             SOUND_INIT                      EQU 0
  001C                     109             SOUND_HUNDRED           EQU     28
  001D                     110             SOUND_THOUSAND          EQU     29
  001E                     111             SOUND_PRODUCT           EQU     30
  0032                     112             SOUND_AND                       EQU     50
  0034                     113             SOUND_COST                      EQU     52
  0035                     114             SOUND_DOLLAR            EQU     53
  0036                     115             SOUND_CENT                      EQU     54
  0037                     116             SOUND_GREETING          EQU     55
  0038                     117             SOUND_MORNING           EQU     56
  0039                     118             SOUND_AFTERNOON         EQU     57
  003A                     119             SOUND_EVENING           EQU     58
  003B                     120             SOUND_PAY                       EQU     59
  003C                     121             SOUND_PURCHASE          EQU     60
  003D                     122             SOUND_CHANGE            EQU     61
  003E                     123             SOUND_EXIT                      EQU     62
  003F                     124             SOUND_BEEP                      EQU     63
  0040                     125             SOUND_SILENCE           EQU     64
  0020                     126             SOUND_QUEUE_LEN         EQU     32
02BB (32                   127             SOUND_QUEUE                     DB      SOUND_QUEUE_LEN DUP(?)
     ??
     )
02DB 00                    128             SOUND_HEAD                      DB      0
02DC 00                    129             SOUND_TAIL                      DB      0
02DD 00                    130             SOUND_TEST_LEFT         DB      0
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    8


LOC  OBJ                  LINE     SOURCE

                           131             
                           132     
----                       133     DATA_SEG        ENDS
                           134     
                           135     ;----------------------------------------------------------------
                           136     ;--------------------DATA SEGMENT END----------------------------
                           137     ;----------------------------------------------------------------
                           138     
                           139     
                           140     ;----------------------------------------------------------------
                           141     ;--------------------CHIP SELECTS--------------------------------
                           142     ;----------------------------------------------------------------
                           143     ; 8255 register addresses
                           144     ; PCS1
  0080                     145     IC8255_PORTA_ADDR EQU 80H;
  0081                     146     IC8255_PORTB_ADDR EQU 81H;
  0082                     147     IC8255_PORTC_ADDR EQU 82H;
  0083                     148     IC8255_CW_ADDR    EQU 83H;
                           149     
  0100                     150     PCS2_ADDR EQU 100H
  0180                     151     PCS3_ADDR EQU 180H
  0200                     152     PCS4_ADDR EQU 200H
                           153     
  FFA6                     154     MMCS EQU 0FFA6H
  FFA8                     155     MPCS EQU 0FFA8H
                           156     
                           157     ;----------------------------------------------------------------
                           158     ;-------------------CHIP SELECT END------------------------------
                           159     ;----------------------------------------------------------------
                           160     
                           161     
                           162     ;----------------------------------------------------------------
                           163     ;--------------------CODE SEGMENT--------------------------------
                           164     ;----------------------------------------------------------------
                           165     
----                       166     CODE_SEG        SEGMENT
                           167             PUBLIC          START
                           168     ASSUME          CS:CODE_SEG, SS:STACK_SEG, DS:DATA_SEG
                           169     
0000                       170     START:
                           171     
                           172     ;-----------------------STACK AREA INIT--------------------------
0000 B8----         R      173             MOV     AX, STACK_SEG           
0003 8ED0                  174             MOV     SS, AX
0005 368B260001            175             MOV     SP, TOS
                           176     
000A B8----         R      177             MOV AX, DATA_SEG
000D 8ED8                  178             MOV DS, AX
                           179     ;----------------------------------------------------------------
                           180     
                           181     ;--------------ON-CHIP PERIPEHRALS--------------------------------
000F 9A0000----     E      182             CALL    FAR PTR IODEFINE
                           183             
                           184             ;IC8255 - Control Word
0014 BA8300                185             MOV DX, IC8255_CW_ADDR
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE    9


LOC  OBJ                  LINE     SOURCE

                           186     
                           187             ;CW Register 
                           188             ;Port C Lower Input, Port C Upper Output 
                           189             ;Port B input, Port A output
                           190             ;1 0 0 0 0 0 1 0
0017 B082                  191             MOV AL, 82H
0019 EE                    192             OUT DX, AL
                           193     
                           194     ; Initialize MCS
                           195     
001A BAA6FF                196             MOV DX, MMCS
001D B80380                197             MOV     AX, 8003H
0020 EF                    198             OUT     DX, AX
                           199     
0021 BAA8FF                200             MOV DX, MPCS
0024 B88440                201             MOV AX, 4084H
0027 EF                    202             OUT DX, AX
                           203     
                           204     ;----------------------------------------------------------------
                           205     
                           206     ;This procedure generates 10ms delay at 5MHz
                           207     ;operating frequency, which corresponds to 
                           208     ;50,000 clock cycles.
                           209     ;DEBOUNCE PROC  NEAR
                           210     ;       PUSH    CX
                           211     ;       MOV CX, 094Ch ; 2380 dec
                           212     ;       BACK:           
                           213     ;               NOP       ; 3 clocks
                           214     ;       LOOP BACK; 18 clocks
                           215     ;       POP CX
                           216     ;       RET
                           217     ;DEBOUNCE ENDP
                           218     
                           219     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                           220     
                           221     ;------------------------Setting the timers---------------------
                           222         ;call Set_timer0
                           223             ;call Set_timer1
0028 9A0000----     E      224             call Set_timer2
002D FB                    225           STI
                           226     ;---------------------------------------------------------------
                           227     
002E                       228     NEXT:
                           229     ;----------------------------------------------------------------
                           230     ;--------------------MAIN LOOP INIT------------------------------
                           231     ;----------------------------------------------------------------
                           232     
                           233             ;slowing down the main loop
002E B9FF5F                234             MOV CX, 05FFFH ; 2380 dec
0031                       235             SLEEP:
0031 90                    236                     NOP
0032 E2FD                  237             LOOP SLEEP; 18 clocks
                           238     
                           239     ;----------------------------------------------------------------
                           240     ;--------------------START KEYPAD----------------------------------
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   10


LOC  OBJ                  LINE     SOURCE

                           241     ;----------------------------------------------------------------
0034 33C0                  242             XOR AX, AX
0036 D0061601              243             ROL KEYPAD_ROW, 01H
003A 803E160177            244             CMP KEYPAD_ROW, 77H
003F 7402                  245             JE RESET_KEYPAD_ROW
0041 7505                  246             JNZ CHECK_KEYPAD_ROW
                           247     
0043                       248     RESET_KEYPAD_ROW:
0043 C60616010E            249             MOV KEYPAD_ROW, 0EH
                           250     
0048                       251     CHECK_KEYPAD_ROW:
0048 A01601                252             MOV AL, KEYPAD_ROW
004B BA8200                253             MOV DX, IC8255_PORTC_ADDR       ;DX = Port B Address
004E EE                    254             OUT DX, AL                                      ;
004F BA8100                255             MOV DX, IC8255_PORTB_ADDR       ;
                           256     
0052                       257     CHECK_KEY_CLOSED:                               ;Check when key is pressed. Keep loop
                                   ing here
0052 EC                    258             IN AL, DX                                       ;Move to AL, value in Port B.
                                    
                           259             
                           260             ;--TODO: Get rid of these compares
0053 3C00                  261             CMP AL, 00H
0055 74D7                  262             JE NEXT
0057 3C3F                  263             CMP AL, 03FH
0059 74D3                  264             JE NEXT
005B 3CFF                  265             CMP AL, 0FFH
005D 74CF                  266             JE NEXT
005F 3CBF                  267             CMP AL, 0BFH
0061 74CB                  268             JE NEXT
0063 3C7F                  269             CMP AL, 07FH
0065 74C7                  270             JE NEXT
0067 3C0F                  271             CMP AL, 0FH
0069 74C3                  272             JE NEXT
006B 3C08                  273             CMP AL, 08H
006D 74BF                  274             JE NEXT
                           275     
                           276             ;ANGAD'S SMARTASS HASHING ALGO
006F 22061601              277             AND AL, KEYPAD_ROW
0073 8A261601              278             MOV AH, KEYPAD_ROW
                           279     
0077 E80200                280             CALL NEAR PTR KEYPAD_PROCESS
                           281     
                           282     
                           283     ;----------------------------------------------------------------
                           284     ;--------------------END KEYPAD----------------------------------
                           285     ;----------------------------------------------------------------
007A EBB2                  286     JMP NEXT
                           287     
                           288     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
007C                       289     KEYPAD_PROCESS PROC NEAR
007C 50                    290             PUSH AX
007D 53                    291             PUSH BX
007E 51                    292             PUSH CX
007F 52                    293             PUSH DX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   11


LOC  OBJ                  LINE     SOURCE

0080 1E                    294             PUSH DS
                           295     
0081 BA----         R      296             MOV     DX, DATA_SEG
0084 8EDA                  297             MOV     DS, DX
                           298     
                           299             ;-------Keypad 1------------
                           300     
0086 B90A00                301             MOV CX, 10
0089                       302             FIND_KEY:
0089 8BD9                  303                     MOV BX, CX
008B 8AA71701              304                     MOV AH, KEYPAD1_HASH[BX]
008F 3AE0                  305                     CMP AH, AL
0091 7404                  306                     JE RESOLVE_COLLISION
0093 E2F4                  307             LOOP FIND_KEY
                           308     
0095 7569                  309             JNE KEYPAD2
                           310     
0097                       311             RESOLVE_COLLISION:
0097 A01601                312                     MOV AL, KEYPAD_ROW
                           313     
                           314                     ;PUSH AX
                           315                     ;CALL FAR PTR PRINT_2HEX
                           316                     ;MOV AL, 0AH ;NEW LINE
                           317                     ;CALL   FAR PTR PRINT_CHAR
                           318                     ;MOV AL, 0DH ;CARRIAGE RETURN
                           319                     ;CALL   FAR PTR PRINT_CHAR
                           320                     ;POP AX
                           321     
009A 83F90A                322                     CMP CX, 10
009D 742A                  323                     JE COLLISION_6_STAR
009F 83F907                324                     CMP CX, 7
00A2 742E                  325                     JE COLLISION_7_5
00A4 83F909                326                     CMP CX, 9
00A7 7432                  327                     JE COLLISION_9_0
                           328     
00A9                       329             ADD_BARCODE:
00A9 8BD9                  330                     MOV BX, CX
00AB 8A87C300              331                     MOV AL, NUMBERS[BX]
00AF 8BCB                  332                     MOV CX, BX
00B1 8A1EE200              333                     MOV BL, BARCODE_I
00B5 8887CE00              334                     MOV BARCODE[BX], AL
00B9 888FD800              335                     MOV BARCODE_DEC[BX], CL
00BD FE06E200              336                     INC BARCODE_I
00C1 B03F                  337                     MOV AL, SOUND_BEEP
00C3 E8A501                338                     CALL VOICE_ON_QUEUE
00C6 E95201                339                     JMP KEYPAD_EXIT
                           340     
00C9                       341             COLLISION_6_STAR:
00C9 3CFE                  342                     CMP AL, 0FEH
00CB 7417                  343                     JE CLEAR
00CD B90600                344                     MOV CX, 6
00D0 EBD7                  345                     JMP ADD_BARCODE
                           346     
00D2                       347             COLLISION_7_5:
00D2 3CFB                  348                     CMP AL, 0FBH
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   12


LOC  OBJ                  LINE     SOURCE

00D4 75D3                  349                     JNE ADD_BARCODE
00D6 B90500                350                     MOV CX, 5
00D9 EBCE                  351                     JMP ADD_BARCODE
                           352     
00DB                       353             COLLISION_9_0:
00DB 3CFE                  354                     CMP AL, 0FEH
00DD 75CA                  355                     JNE ADD_BARCODE
00DF B90000                356                     MOV CX, 0
00E2 EBC5                  357                     JMP ADD_BARCODE
                           358     
00E4                       359             CLEAR:
00E4 33DB                  360                     XOR BX, BX
00E6 B90800                361                     MOV CX, 08H
00E9                       362                     CLEAR_BARCODE:
00E9 8BD9                  363                             MOV BX, CX
00EB 4B                    364                             DEC BX
00EC C687CE0000            365                             MOV BARCODE[BX], 00H
00F1 C687D80000            366                             MOV BARCODE_DEC[BX], 00H
00F6 E2F1                  367                     LOOP CLEAR_BARCODE
00F8 C606E20000            368                     MOV BARCODE_I, 00H
00FD E91B01                369                     JMP KEYPAD_EXIT
                           370     
0100                       371             KEYPAD2:
0100 B90A00                372                     MOV CX, 10
0103                       373                     FIND_KEY2:
0103 8BD9                  374                             MOV BX, CX
0105 8AA72201              375                             MOV AH, KEYPAD2_HASH[BX]
0109 3AE0                  376                             CMP AH, AL
010B 7402                  377                             JE PROCESS_COMMAND
010D E2F4                  378                     LOOP FIND_KEY2
                           379     
010F                       380                     PROCESS_COMMAND:
010F 83F901                381                             CMP CX, 1
0112 7437                  382                             JE NEW_TRANSACTION
0114 83F902                383                             CMP CX, 2
0117 7450                  384                             JE NEW_ITEM
0119 83F903                385                             CMP CX, 3
011C 7478                  386                             JE GET_QUANTITY
011E 83F904                387                             CMP CX, 4
0121 7408                  388                             JE DUMMY_PRODUCT
0123 83F90A                389                             CMP CX, 10
0126 7478                  390                             JE SEND_BARCODE
0128 E9F000                391                             JMP KEYPAD_EXIT
                           392                     
                           393     
012B                       394                     DUMMY_PRODUCT:
012B 33DB                  395                             XOR BX, BX
012D 33C9                  396                             XOR CX, CX
012F B90900                397                             MOV CX,9
0132                       398                             PRINT_DUMMY_PRODUCT:
0132 BB0900                399                                     MOV BX, 9
0135 2BD9                  400                                     SUB BX, CX
0137 8A87A800              401                                     MOV AL, PRODUCT1[BX]
013B 9A0000----     E      402                                     CALL FAR PTR PRINT_CHAR
0140 E2F0                  403                             LOOP PRINT_DUMMY_PRODUCT
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   13


LOC  OBJ                  LINE     SOURCE

0142 B00A                  404                             MOV AL, 0AH
0144 9A0000----     E      405                             CALL FAR PTR PRINT_CHAR
                           406                             ;MOV AL, 0DH
                           407                             ;CALL FAR PTR PRINT_CHAR
                           408     
0149 EB99                  409                             JMP CLEAR
                           410     
                           411     
                           412                     ; New transaction
                           413                     ; Send [OP]EN to shop pc
                           414                     ; Play greeting
014B                       415                     NEW_TRANSACTION:
014B C606FE0000            416                             MOV QUANTITY_FLAG, 00H
0150 C606FF0000            417                             MOV TEMP_FLAG, 00H
                           418     
0155 B05F                  419                             MOV AL, '_'
0157 9A0000----     E      420                             CALL FAR PTR PRINT_CHAR
                           421     
                           422                             ;MOV    CX,6
                           423                             ;MOV    BX,0H
                           424                             ;PRINT_OPEN:
                           425                             ;       MOV     AL,DS:OPEN_MESS[BX]
                           426                             ;       INC     BX
                           427                             ;       CALL    FAR PTR PRINT_CHAR
                           428                             ;LOOP   PRINT_OPEN
                           429                             
015C B037                  430                             MOV AL, SOUND_GREETING
015E E80A01                431                             CALL NEAR PTR VOICE_ON_QUEUE
0161 B039                  432                             MOV AL, SOUND_AFTERNOON
0163 E80501                433                             CALL NEAR PTR VOICE_ON_QUEUE
0166 E9B200                434                             JMP KEYPAD_EXIT
                           435     
                           436                     ; New item
                           437                     ; Send [IT]EM to shop pc
                           438                     ; Clear BCD
                           439                     ; Wait for user to input Barcode
0169                       440                     NEW_ITEM:
0169 C606FE0000            441                             MOV QUANTITY_FLAG, 00H
016E C606FF0000            442                             MOV TEMP_FLAG, 00H
                           443                             
                           444                             ;MOV AL, '!'
                           445                             ;CALL FAR PTR PRINT_CHAR
                           446                             ;CALL NEAR PTR TRANSMIT_POPULATE
                           447     
0173 B03F                  448                             MOV AL, SOUND_BEEP
0175 E8F300                449                             CALL NEAR PTR VOICE_ON_QUEUE
                           450     
0178 B90600                451                             MOV     CX,6
017B BB0000                452                             MOV     BX,0H
017E                       453                             PRINT_ITEM:
017E 8A878A00              454                                     MOV     AL,DS:ITEM_MESS[BX]
0182 43                    455                                     INC     BX
                           456                                     ;CALL   NEAR PTR TRANSMIT_POPULATE
0183 9A0000----     E      457                                     CALL    FAR PTR PRINT_CHAR
0188 E2F4                  458                             LOOP    PRINT_ITEM
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   14


LOC  OBJ                  LINE     SOURCE

                           459     
                           460     
                           461     ;                       MOV CX, 6
                           462     ;                       FILL_BCD_BARCODE_PROMPT:
                           463     ;                               MOV BX, 6
                           464     ;                               SUB BX, 6
                           465     ;                               MOV AL, ENTER_BARCODE[BX]
                           466     ;                               MOV BARCODE[BX], AL
                           467     ;                       LOOP FILL_BCD_BARCODE_PROMPT
018A E957FF                468                             JMP CLEAR
018D E98B00                469                             JMP KEYPAD_EXIT
                           470     
                           471                     ;Wait for user to input Quantity
0190                       472                     GET_BARCODE:
0190 E951FF                473                             JMP CLEAR
0193 E98500                474                             JMP KEYPAD_EXIT
                           475     
0196                       476                     GET_QUANTITY:
                           477                             ;MOV AL, 'q'
                           478                             ;CALL FAR PTR PRINT_CHAR
0196 B03F                  479                             MOV AL, SOUND_BEEP
0198 E8D000                480                             CALL NEAR PTR VOICE_ON_QUEUE
019B C606FF0001            481                             MOV TEMP_FLAG, 01H
                           482     
                           483                     ; Send Barcode and Quantity to shop pc
                           484                     ; Send [BA]rcode and [QU]andtity to shop pc
01A0                       485                     SEND_BARCODE:
01A0 803EFE0001            486                             CMP QUANTITY_FLAG, 01H
01A5 7465                  487                             JE SEND_QUANTITY
                           488     
                           489                             ;MOV AL, 'b'
                           490                             ;CALL FAR PTR PRINT_CHAR
                           491     
                           492                             ;MOV    CX,6
                           493                             ;MOV    BX,0H
                           494                             ;PRINT_BARCODE:
                           495                             ;       MOV     AL,DS:BARCODE_MESS[BX]
                           496                             ;       INC     BX
                           497                             ;       ;CALL NEAR PTR TRANSMIT_POPULATE
                           498                             ;       ;CALL   FAR PTR PRINT_CHAR
                           499                             ;LOOP   PRINT_BARCODE
                           500     
01A7 33C9                  501                             XOR CX, CX
01A9 33DB                  502                             XOR BX, BX
01AB 8A0EE200              503                             MOV CL, BARCODE_I
01AF                       504                             SEND_BARCODE_LOOP:
01AF 8A1EE200              505                                     MOV BL, BARCODE_I
01B3 2BD9                  506                                     SUB BX, CX
01B5 8A87D800              507                                     MOV AL, BARCODE_DEC[BX]
01B9 0430                  508                                     ADD AL, 48
01BB E86300                509                                     CALL NEAR PTR TRANSMIT_POPULATE
                           510                                     ;CALL FAR PTR PRINT_CHAR
01BE E2EF                  511                             LOOP SEND_BARCODE_LOOP
                           512     
01C0 B02C                  513                             MOV AL, ','
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   15


LOC  OBJ                  LINE     SOURCE

01C2 E85C00                514                             CALL NEAR PTR TRANSMIT_POPULATE
                           515     
01C5 803EFF0001            516                             CMP TEMP_FLAG, 01H
01CA 7435                  517                             JE SET_QUANTITY_FLAG
                           518     
                           519     
01CC                       520                             SEND_TRANSMIT:
01CC 33C9                  521                             XOR CX, CX
01CE 33DB                  522                             XOR BX, BX
01D0 8A0E0801              523                             MOV CL, TRANSMIT_C
01D4 A00801                524                             MOV AL, TRANSMIT_C
01D7 9A0000----     E      525                             CALL FAR PTR PRINT_2HEX
01DC                       526                             SEND_TRANSMIT_LOOP:
01DC 8A1E0801              527                                     MOV BL, TRANSMIT_C
01E0 32FF                  528                                     XOR BH,BH
01E2 2BD9                  529                                     SUB BX, CX
                           530                                     ;MOV BX, CX
01E4 8A870001              531                                     MOV AL, TRANSMIT_ARR[BX]
                           532                                     ;ADD AL, 48
01E8 9A0000----     E      533                                     CALL FAR PTR PRINT_CHAR
01ED E2ED                  534                             LOOP SEND_TRANSMIT_LOOP
                           535     
01EF B00A                  536                             MOV AL, 0AH ;NEW LINE
01F1 9A0000----     E      537                             CALL    FAR PTR PRINT_CHAR
                           538     
                           539     
01F6 C606080100            540                             MOV TRANSMIT_C, 0
                           541     
01FB E9E6FE                542                             JMP CLEAR
01FE EB1B90                543                             JMP KEYPAD_EXIT
                           544     
0201                       545                     SET_QUANTITY_FLAG:
0201 C606FE0001            546                             MOV QUANTITY_FLAG, 01H
0206 E9DBFE                547                             JMP CLEAR
0209 EB1090                548                             JMP KEYPAD_EXIT
                           549     
020C                       550                     SEND_QUANTITY:
                           551                             ;MOV CX, 6
                           552                             ;MOV BX, 0H
                           553                             ;PRINT_QUANTITY:
                           554                             ;       MOV     AL,DS:QUANTITY_MESS[BX]
                           555                             ;       INC     BX
                           556                             ;       CALL NEAR PTR TRANSMIT_POPULATE
                           557                             ;       ;CALL   FAR PTR PRINT_CHAR
                           558                             ;LOOP   PRINT_QUANTITY
                           559     
020C 33C9                  560                             XOR CX, CX
020E 32DB                  561                             XOR BL, BL
0210 8A0EE200              562                             MOV CL, BARCODE_I
                           563                             ;MOV AL, BARCODE_I
                           564                             ;CALL FAR PTR PRINT_2HEX
                           565                             ;SEND_QUANTITY_LOOP:
                           566                             ;       ;MOV BL, BARCODE_I
                           567                             ;       ;SUB BX, CX
                           568                             ;       MOV BX, CX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   16


LOC  OBJ                  LINE     SOURCE

                           569                             ;       DEC BX
                           570                             ;       MOV AL, BARCODE_DEC[BX]
                           571                             ;       ;ADD AL, 48
                           572                             ;       CALL NEAR PTR TRANSMIT_POPULATE
                           573                             ;       ;CALL FAR PTR PRINT_CHAR
                           574                             ;LOOP SEND_QUANTITY_LOOP
                           575     
0214 B031                  576                             MOV AL, '1'
0216 E80800                577                             CALL NEAR PTR TRANSMIT_POPULATE
                           578     
0219 EBB1                  579                             JMP SEND_TRANSMIT
                           580     
                           581                             ;JMP CLEAR
                           582                             ;JMP KEYPAD_EXIT
                           583     
021B                       584     KEYPAD_EXIT:
021B 1F                    585             POP     DS
021C 5A                    586             POP DX
021D 59                    587             POP CX
021E 5B                    588             POP BX
021F 58                    589             POP AX
                           590     
0220 C3                    591             RET
                           592     KEYPAD_PROCESS ENDP
                           593     
                           594     
0221                       595     TRANSMIT_POPULATE PROC NEAR
0221 50                    596             PUSH AX
0222 53                    597             PUSH BX
0223 51                    598             PUSH CX
0224 52                    599             PUSH DX
                           600             
0225 BA----         R      601             MOV     DX, DATA_SEG
0228 8EDA                  602             MOV     DS, DX
                           603     
022A 33DB                  604             XOR BX, BX
022C 8A1E0801              605             MOV BL, TRANSMIT_C
0230 88870001              606             MOV TRANSMIT_ARR[BX], AL
0234 80C301                607             ADD BL, 1
0237 32FF                  608             XOR BH,BH
0239 881E0801              609             MOV TRANSMIT_C, BL
                           610             ;MOV AL, 'i'
                           611             ;CALL FAR PTR PRINT_CHAR
                           612     
023D 5A                    613             POP DX
023E 59                    614             POP CX
023F 5B                    615             POP BX
0240 58                    616             POP AX
0241 C3                    617             RET
                           618     TRANSMIT_POPULATE ENDP
                           619     
                           620     
0242                       621     TRANSACTION PROC NEAR
0242 50                    622             PUSH AX
0243 53                    623             PUSH BX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   17


LOC  OBJ                  LINE     SOURCE

0244 51                    624             PUSH CX
0245 52                    625             PUSH DX
                           626     
0246 B037                  627             MOV AL, SOUND_GREETING
0248 E82000                628             CALL VOICE_ON_QUEUE
024B B039                  629             MOV AL, SOUND_AFTERNOON
024D E81B00                630             CALL VOICE_ON_QUEUE
                           631     
0250 5A                    632             POP DX
0251 59                    633             POP CX
0252 5B                    634             POP BX
0253 58                    635             POP AX
0254 C3                    636             RET
                           637     TRANSACTION ENDP
                           638     
0255                       639     ITEM PROC NEAR
0255 50                    640             PUSH AX
0256 53                    641             PUSH BX
0257 51                    642             PUSH CX
0258 52                    643             PUSH DX
                           644     
0259 BA----         R      645             MOV     DX, DATA_SEG
025C 8EDA                  646             MOV     DS, DX
                           647     
025E 5A                    648             POP DX
025F 59                    649             POP CX
0260 5B                    650             POP BX
0261 58                    651             POP AX
0262 C3                    652             RET
                           653     ITEM ENDP
                           654     
                           655     
0263                       656     QTY PROC NEAR
0263 50                    657             PUSH AX
0264 53                    658             PUSH BX
0265 51                    659             PUSH CX
0266 52                    660             PUSH DX
                           661     
0267 5A                    662             POP DX
0268 59                    663             POP CX
0269 5B                    664             POP BX
026A 58                    665             POP AX
                           666     QTY ENDP
                           667     
                           668     ;------------------VOICE-------------------------
026B                       669     VOICE_ON_QUEUE PROC NEAR
026B 50                    670             PUSH AX
026C 53                    671             PUSH BX
026D 52                    672             PUSH DX
026E 1E                    673             PUSH DS
                           674             
026F BA----         R      675             MOV     DX, DATA_SEG
0272 8EDA                  676             MOV     DS, DX
                           677     
0274 B700                  678             MOV BH, 0
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   18


LOC  OBJ                  LINE     SOURCE

0276 8A1EDB02              679             MOV BL, BYTE PTR SOUND_HEAD
027A 8887BB02              680             MOV BYTE PTR SOUND_QUEUE[BX], AL
027E FEC3                  681             INC BL
                           682     
0280 80FB20                683             CMP BL, SOUND_QUEUE_LEN
0283 7502                  684             JNE VOICE_ON_QUEUE_STALL
                           685             
0285 B300                  686             MOV BL, 0
                           687             
0287                       688     VOICE_ON_QUEUE_STALL:
                           689                     
0287 881EDB02              690             MOV BYTE PTR SOUND_HEAD, BL
028B 9A0000----     E      691             CALL    FAR PTR Set_timer0
                           692             
0290 1F                    693             POP     DS
0291 5A                    694             POP DX
0292 5B                    695             POP BX
0293 58                    696             POP AX
                           697             
0294 C3                    698             RET
                           699     VOICE_ON_QUEUE ENDP
                           700     
                           701     
0295                       702     SERIAL_REC_ACTION       PROC    FAR
0295 51                    703                     PUSH    CX
0296 53                    704                     PUSH    BX
0297 1E                    705                     PUSH    DS
                           706     
0298 BB----         R      707                     MOV     BX,DATA_SEG             ;initialize data segment register
029B 8EDB                  708                     MOV     DS,BX
                           709     
029D 3C30                  710                     CMP     AL, '0'
029F 7C4A                  711                     JL S_RET
                           712                     ;PUSH AX
                           713                     ;MOV AL, SOUND_BEEP
                           714                     ;CALL NEAR PTR VOICE_ON_QUEUE
                           715                     ;POP AX
                           716     
                           717                     ;JNE    S_FAST
                           718     
02A1 FE06BD00              719                     INC     DS:T0_COUNT_SET
02A5 FE06BD00              720                     INC     DS:T0_COUNT_SET
                           721                     
                           722                     ;MOV DX, IC8255_PORTA_ADDR
                           723                     ;MOV AL, 0FFH
                           724                     ;OUT DX, AL
                           725     
02A9                       726     DISP_PRICE:
                           727     
02A9 33DB                  728             XOR BX, BX
02AB 8AD8                  729             MOV BL, AL
02AD 80EB30                730             SUB BL, 48
02B0 8A87C300              731             MOV AL, NUMBERS[BX]
02B4 8BCB                  732             MOV CX, BX
02B6 8A1EE200              733             MOV BL, BARCODE_I
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   19


LOC  OBJ                  LINE     SOURCE

02BA 8887CE00              734             MOV BARCODE[BX], AL
02BE 888FD800              735             MOV BARCODE_DEC[BX], CL
02C2 FE06E200              736             INC BARCODE_I
                           737             ;PUSH AX
                           738             ;MOV AL, SOUND_BEEP
                           739             ;CALL NEAR PTR VOICE_ON_QUEUE
                           740             ;POP AX
                           741     
02C6 EB2390                742             JMP S_RET
                           743     
02C9                       744     S_FAST:
02C9 3C01                  745                     CMP     AL,01H
02CB 751E                  746                     JNE     S_RET
                           747     
02CD FE0EBD00              748                     DEC     DS:T0_COUNT_SET
02D1 FE0EBD00              749                     DEC     DS:T0_COUNT_SET
                           750     
02D5                       751     S_NEXT0:
02D5 B90F00                752                     MOV     CX,15                   ;initialize counter for message
02D8 BB0000                753                     MOV     BX,0
                           754     
02DB                       755     S_NEXT1:        
02DB 8A476E                756                     MOV     AL,DS:REC_MESS[BX]      ;print message
02DE 9A0000----     E      757                     call    FAR ptr print_char
02E3 43                    758                     INC     BX
02E4 E2F5                  759                     LOOP    S_NEXT1
02E6 B037                  760                     MOV AL, SOUND_GREETING
02E8 E880FF                761                     CALL NEAR PTR VOICE_ON_QUEUE
                           762     
02EB                       763     S_RET:
02EB 1F                    764                     POP     DS
02EC 5B                    765                     POP     BX
02ED 59                    766                     POP     CX
02EE CB                    767                     RET
                           768     SERIAL_REC_ACTION       ENDP
                           769     
                           770     
                           771     ;--------------------------------------------------------------
                           772     
                           773     ;--------------------TIMER 0 ----------------------------------
                           774     
02EF                       775     TIMER0_ACTION   PROC    FAR
02EF 50                    776                     PUSH    AX
02F0 1E                    777                     PUSH    DS
02F1 53                    778                     PUSH    BX
02F2 51                    779                     PUSH    CX
                           780     
02F3 33C0                  781             XOR AX,AX
02F5 33DB                  782             XOR BX,BX
02F7 33C9                  783             XOR CX,CX
02F9 33D2                  784             XOR DX,DX
                           785     
02FB B8----         R      786             MOV     AX,DATA_SEG
02FE 8ED8                  787             MOV     DS,AX
                           788             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   20


LOC  OBJ                  LINE     SOURCE

                           789             ;slowing down the timer 
                           790             ;MOV CX, 04FFFH ; 2380 dec
                           791             ;SLEEP_TIMER:
                           792             ;       NOP
                           793             ;LOOP SLEEP_TIMER; 18 clocks
                           794     
                           795     ;----------------------------------------------------
                           796             ; SOUND_LEFT: Number of bytes left in the queue
0300 833E330100            797             CMP WORD PTR SOUND_LEFT, 0
0305 7544                  798             JNE timer0_ACTION_PROCEED
                           799             
                           800             ; Reload with next item in the queue
0307 B700                  801             MOV BH, 0
0309 8A1EDC02              802             MOV BL, BYTE PTR SOUND_TAIL
                           803             
030D 381EDB02              804             CMP BYTE PTR SOUND_HEAD, BL
0311 7508                  805             JNE timer0_ACTION_RELOAD
                           806             
                           807             ;disable timer 0, freeing up resources
0313 9A0000----     E      808             call disable_timer0
                           809      
0318 EB6690                810             JMP T0_NEXT1
                           811             
031B                       812     timer0_ACTION_RELOAD:
                           813             
031B 8A9FBB02              814             MOV BL, BYTE PTR SOUND_QUEUE[BX]
031F BE3501                815             MOV SI, OFFSET SOUND_BASE_ADDR
                           816                     
0322 C1E302                817             SHL BX, 2
0325 8B00                  818             MOV AX, WORD PTR [BX][SI]
                           819      
0327 A32F01                820             MOV WORD PTR SOUND_ADDR[0], AX
                           821             
032A 8B4002                822             MOV AX, WORD PTR 2[BX][SI]      
032D A33101                823             MOV WORD PTR SOUND_ADDR[2], AX
                           824             
0330 D1EB                  825             SHR BX, 1
0332 BE3902                826             MOV SI, OFFSET SOUND_SIZE
0335 8B00                  827             MOV AX, WORD PTR [BX][SI]
0337 A33301                828             MOV WORD PTR SOUND_LEFT, AX
033A A0DC02                829             MOV AL, BYTE PTR SOUND_TAIL
033D FEC0                  830             INC AL
033F 3C20                  831             CMP AL, SOUND_QUEUE_LEN
0341 7502                  832             JNE timer0_QUEUE_NO_OVERFLOW
                           833             
0343 B000                  834             MOV AL, 0
                           835             
0345                       836     timer0_QUEUE_NO_OVERFLOW:
                           837     
0345 A2DC02                838             MOV BYTE PTR SOUND_TAIL, AL
0348 EB3690                839             JMP T0_NEXT1
                           840             
034B                       841     timer0_ACTION_PROCEED:
                           842     
034B FF0E3301              843             DEC WORD PTR SOUND_LEFT
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   21


LOC  OBJ                  LINE     SOURCE

                           844             
034F 8B362F01              845             MOV SI, WORD PTR SOUND_ADDR[0]
0353 8B3E3101              846             MOV DI, WORD PTR SOUND_ADDR[2]
                           847     
                           848             ; SI - Intra-segment address, DI - Segment address
0357 83C708                849             ADD DI, 8H
035A C1E70C                850             SHL DI, 12
                           851     
                           852             ; Set extra segment to point to 8000H, the starting segment of the EEPROM
035D 8EDF                  853             MOV DS, DI
                           854              
                           855             ; Get byte from EEPROM address space
035F 8A04                  856             MOV AL, [SI]
                           857             
                           858             ; Put byte to DAC
0361 BA0002                859             MOV DX, PCS4_ADDR
0364 EE                    860             OUT DX, AL
                           861             
                           862             ; Increment EEPROM address to move to the next sample
0365 B8----         R      863             MOV AX, DATA_SEG
0368 8ED8                  864             MOV DS, AX
                           865     
036A FF062F01              866             INC WORD PTR SOUND_ADDR[0]
036E 7510                  867             JNZ T0_NEXT1
                           868     
                           869             ; Increment memory segment
0370 FF063101              870             INC WORD PTR SOUND_ADDR[2]
                           871     
                           872     ;---------------------------------------------
                           873     
                           874     
0374 FE0EBC00              875             DEC     DS:T0_COUNT
0378 7506                  876             JNZ     T0_NEXT1
037A A0BD00                877             MOV     AL,DS:T0_COUNT_SET
037D A2BC00                878             MOV     DS:T0_COUNT,AL
                           879     
0380                       880     T0_NEXT1:
                           881     ;T0_NEXT1:
0380 59                    882             POP     CX
0381 5B                    883             POP     BX
0382 1F                    884             POP     DS
0383 58                    885             POP AX
0384 CB                    886             RET
                           887     TIMER0_ACTION   ENDP
                           888     
                           889     ;--------------------------------------------------------------
                           890     
                           891     ;--------------------TIMER 1 ----------------------------------
                           892     
0385                       893     TIMER1_ACTION   PROC    FAR
0385 50                    894                     PUSH    AX
0386 1E                    895                     PUSH    DS
0387 53                    896                     PUSH    BX
0388 51                    897                     PUSH    CX
                           898     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   22


LOC  OBJ                  LINE     SOURCE

0389 B8----         R      899                     MOV     AX,DATA_SEG
038C 8ED8                  900                     MOV     DS,AX
                           901             
038E FE0EBE00              902                     DEC     DS:T1_COUNT
0392 7517                  903                     JNZ     T1_NEXT1
0394 A0BF00                904                     MOV     AL,DS:T1_COUNT_SET
0397 A2BE00                905                     MOV     DS:T1_COUNT,AL
                           906     
039A B91400                907                     MOV     CX,20
039D BB0000                908                     MOV     BX,0H
03A0                       909     T1_NEXT0:
03A0 8A472C                910                     MOV     AL,DS:TIMER1_MESS[BX]
03A3 43                    911                     INC     BX
03A4 9A0000----     E      912                     CALL    FAR PTR PRINT_CHAR
03A9 E2F5                  913                     LOOP    T1_NEXT0
                           914     
03AB                       915     T1_NEXT1:       
03AB 59                    916                     POP     CX
03AC 5B                    917                     POP     BX
03AD 1F                    918                     POP     DS
03AE 58                    919                     POP     AX
03AF CB                    920                     RET
                           921     TIMER1_ACTION   ENDP
                           922     
                           923     ;--------------------------------------------------------------
                           924     
                           925     ;--------------------TIMER 2 ----------------------------------
                           926     
                           927     
03B0                       928     TIMER2_ACTION   PROC    FAR
03B0 50                    929                     PUSH    AX
03B1 1E                    930                     PUSH    DS
03B2 53                    931                     PUSH    BX
03B3 51                    932                     PUSH    CX
                           933     
03B4 33C0                  934                     XOR AX, AX
03B6 33DB                  935                     XOR BX, BX
                           936                     
                           937                     
                           938     ;----------------------------
                           939                     ;AD0 - AD5 PCS3 CS for 7-segment
                           940                     ;7  6  5  4  3  2  1  0
                           941                     ;x  x  A5 A4 A3 A2 A1 A0
03B8 BA8001                942                     MOV DX, PCS3_ADDR
03BB A0C200                943                     MOV AL, LED_SELECT
                           944                     ;MOV AL, 00111110B
03BE EE                    945                     OUT DX, AL
03BF D006C200              946                     ROL LED_SELECT, 01H
                           947     
                           948                     ;AD0 - AD7 PCS2
                           949                     ;AD7 - DOT (MSB)
                           950                     
03C3 BA0001                951                     MOV DX, PCS2_ADDR
03C6 8A1ECD00              952                     MOV BL, CURRENT_NUMBER
03CA 8A87CE00              953                     MOV AL, BARCODE[BX]
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    05:12:16  12/04/;2  PAGE   23


LOC  OBJ                  LINE     SOURCE

                           954                     ;MOV AL, 01111111B
03CE EE                    955                     OUT DX, AL
03CF FE06CD00              956                     INC CURRENT_NUMBER
03D3 803ECD0008            957                     CMP CURRENT_NUMBER, 08H
03D8 7411                  958                     JE RESET_CURRENT
03DA 7523                  959                     JNE T2_NEXT1
                           960     ;---------------------------
03DC FE0EC000              961                     DEC     DS:T2_COUNT
03E0 751D                  962                     JNZ     T2_NEXT1
03E2 A0C100                963                     MOV     AL,DS:T2_COUNT_SET
03E5 A2C000                964                     MOV     DS:T2_COUNT,AL
03E8 BB0000                965                     MOV     BX,0H
                           966                     
03EB                       967     RESET_CURRENT:
03EB C606CD0000            968                     MOV CURRENT_NUMBER, 00H
03F0 FE0EC000              969                     DEC     DS:T2_COUNT
03F4 7509                  970                     JNZ     T2_NEXT1
03F6 A0C100                971                     MOV     AL,DS:T2_COUNT_SET
03F9 A2C000                972                     MOV     DS:T2_COUNT,AL
03FC BB0000                973                     MOV     BX,0H
                           974     
03FF                       975     T2_NEXT1:
03FF 59                    976                     POP     CX
0400 5B                    977                     POP     BX
0401 1F                    978                     POP     DS
0402 58                    979                     POP AX
0403 CB                    980                     RET
                           981     
                           982     TIMER2_ACTION   ENDP
                           983     
                           984     ;--------------------------------------------------------------
                           985     
----                       986     CODE_SEG        ENDS
                           987     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
