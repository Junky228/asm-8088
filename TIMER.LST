8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\USERS\ANGADS~1\DOWNLO~1\ASM\ASM\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; =========================================================================
                             5     
                             6     public  serial_rec_action, timer0_action, timer1_action, timer2_action
                             7     extrn   print_char:far, print_2hex:far, iodefine:far
                             8     extrn   Set_timer0:far, Set_timer1:far, Set_timer2:far, disable_timer0:far, disable_s
                                   erial:far, enable_serial:far
                             9     
----                        10     STACK_SEG       SEGMENT
0000 (256                   11                     DB      256 DUP(?)
     ??
     )
0100                        12             TOS     LABEL   WORD
----                        13     STACK_SEG       ENDS
                            14     
                            15     
                            16     ;----------------------------------------------------------------
                            17     ;--------------------DATA SEGMENT--------------------------------
                            18     ;----------------------------------------------------------------
                            19     
----                        20     DATA_SEG        SEGMENT
                            21     
                            22             ;-- String messages
0000 0A                     23             MAIN_MESS   DB  10,13,'Main Loop           '
0001 0D
0002 4D61696E204C6F
     6F702020202020
     202020202020
0016 0A                     24             TIMER0_MESS     DB      10,13,'TIMER0 INTERRUPT    '
0017 0D
0018 54494D45523020
     494E5445525255
     505420202020
002C 0A                     25             TIMER1_MESS     DB      10,13,'TIMER1 INTERRUPT    '
002D 0D
002E 54494D45523120
     494E5445525255
     505420202020
0042 0A                     26             TIMER2_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0043 0D
0044 54494D45523220
     494E5445525255
     505420202020
0058 0A                     27             KEY_PRESSED DB  10,13,'KEY PRESSED         '
0059 0D
005A 4B455920505245
     53534544202020
     202020202020
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

                            28     
006E 0A                     29             REC_MESS        DB  10,13,'INPUT RECEIVED      '
006F 0D
0070 494E5055542052
     45434549564544
     202020202020
                            30     
0084 5F5F4F50454E           31             OPEN_MESS       DB      '__OPEN'
008A 5F5F4954454D           32             ITEM_MESS       DB      '__ITEM'
0090 5F5F424152435F         33             BARCODE_MESS    DB  '__BARC_'
0097 5F5F5155414E5F         34             QUANTITY_MESS   DB      '__QUAN_'
                            35     
009E 00                     36             PRICE_I         DB      00H
009F 00                     37             PRICE_BCD       DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00A0 00
00A1 00
00A2 00
00A3 00
00A4 00
00A5 00
00A6 00
00A7 00                     38             PRICE_DEC       DB  00H
                            39             
00A8 69313030333634         40             PRODUCT1        DB      'i100364,1'
     2C31
00B1 69313233343537         41             PRODUCT2        DB      'i123457,1'     
     2C31
                            42             
00BA 0000                   43             DI_INC  DW 0000H
                            44     
                            45             ; -- Timers counters
                            46     
00BC 2F                     47             T0_COUNT                DB      2FH
00BD 2F                     48             T0_COUNT_SET    DB      2FH
00BE 2F                     49             T1_COUNT                DB      2FH
00BF 2F                     50             T1_COUNT_SET    DB      2FH
00C0 2F                     51             T2_COUNT                DB      2FH
00C1 2F                     52             T2_COUNT_SET    DB      2FH
                            53     
                            54             ; -- BCD and Keypad
                            55     
00C2 FE                     56             LED_SELECT  DB  0FEH
00C3 3F                     57             NUMBERS         DB      03FH, 006H, 05BH, 04FH, 066H, 06DH, 07DH, 007H, 07FH,
                                    06FH
00C4 06
00C5 5B
00C6 4F
00C7 66
00C8 6D
00C9 7D
00CA 07
00CB 7F
00CC 6F
00CD 00                     58             CURRENT_NUMBER DB 00H
00CE 00                     59             BARCODE         DB  00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

00CF 00
00D0 00
00D1 00
00D2 00
00D3 00
00D4 00
00D5 00
00D6 00
00D7 00
                            60             ;BARCODE                DB  03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 0
                                   3FH, 03FH
00D8 00                     61             BARCODE_DEC     DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00D9 00
00DA 00
00DB 00
00DC 00
00DD 00
00DE 00
00DF 00
00E0 00
00E1 00
00E2 00                     62             BARCODE_I       DB 00H
  0006                      63             BARCODE_LEN             EQU 6
00E3 (6                     64             BARCODE_BUFFER  DB BARCODE_LEN DUP(?)
     ??
     )
  0000                      65             BARCODE_TAIL    EQU 0
                            66             ;BARCODE_TAIL   EQU 0
                            67     
                            68     
00E9 00                     69             QUANTITY                DB  00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00EA 00
00EB 00
00EC 00
00ED 00
00EE 00
00EF 00
00F0 00
00F1 00
00F2 00
00F3 00                     70             QUANTITY_DEC    DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00F4 00
00F5 00
00F6 00
00F7 00
00F8 00
00F9 00
00FA 00
00FB 00
00FC 00
00FD 00                     71             QUANTITY_I              DB      00H
00FE 00                     72             QUANTITY_FLAG   DB      00H
00FF 00                     73             TEMP_FLAG               DB      00H
                            74     
                            75             ;TRANSMIT_ARR   DB      30 DUP(?)
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

                            76             ;TRANSMIT_C             DB      00H
                            77     
                            78             ;-- TODO: Add BCD Mappings
0100 7F                     79             ENTER_BARCODE DB        07FH, 07FH, 07FH, 07FH, 07FH, 07FH
0101 7F
0102 7F
0103 7F
0104 7F
0105 7F
0106 6F                     80             ENTER_QUANTITY  DB      06FH, 06FH, 06FH, 06FH, 06FH, 06FH 
0107 6F
0108 6F
0109 6F
010A 6F
010B 6F
                            81             
                            82             
010C 00                     83             KEYPAD_CURRENT_ROW DB 00H
010D FE                     84             KEYPAD_ROW      DB 0FEH; 
010E FC                     85             KEYPAD1_HASH            DB      0FCH, 0F3H, 0F5H, 0F6H, 0FBH, 0F9H, 0FAH, 0F9
                                   H, 0FDH, 0FCH, 0FAH
010F F3
0110 F5
0111 F6
0112 FB
0113 F9
0114 FA
0115 F9
0116 FD
0117 FC
0118 FA
0119 EE                     86             KEYPAD2_HASH    DB      0EEH, 0D7H, 0E7H, 0F7H, 0DBH, 0EBH, 0F3H, 0DDH, 0EDH,
                                    0F5H, 0DEH
011A D7
011B E7
011C F7
011D DB
011E EB
011F F3
0120 DD
0121 ED
0122 F5
0123 DE
                            87     
                            88             ; -- Voice
                            89     
0124 E703                   90             DESIRED_SOUND DW 999
0126 00000000               91             SOUND_ADDR                      DD      0
012A 0000                   92             SOUND_LEFT                      DW      0
012C 00000000               93             SOUND_BASE_ADDR         DD      0, 4713, 8481, 11945, 15315, 18317, 21614, 26
                                   120, 30013, 31809
0130 69120000
0134 21210000
0138 A92E0000
013C D33B0000
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

0140 8D470000
0144 6E540000
0148 08660000
014C 3D750000
0150 417C0000
0154 0B8D0000               94                                                     DD      36107, 39110, 43768, 47646, 5
                                   1847, 56124, 60775, 66907, 73225
0158 C6980000
015C F8AA0000
0160 1EBA0000
0164 87CA0000
0168 3CDB0000
016C 67ED0000
0170 5B050100
0174 091E0100
0178 B8320100               95                                                     DD      78520, 84565, 87674, 90326, 9
                                   3756, 96907, 101370, 106075, 109155
017C 554A0100
0180 7A560100
0184 D6600100
0188 3C6E0100
018C 8B7A0100
0190 FA8B0100
0194 5B9E0100
0198 63AA0100
019C D6B80100               96                                                     DD      112854, 115703, 118631, 12186
                                   7, 126347, 129602, 133161, 134469
01A0 F7C30100
01A4 67CF0100
01A8 0BDC0100
01AC 8BED0100
01B0 42FA0100
01B4 29080200
01B8 450D0200
01BC 87180200               97                                                     DD      137351, 141625, 146695, 15250
                                   3, 159103, 162214, 166331, 170638
01C0 39290200
01C4 073D0200
01C8 B7530200
01CC 7F6D0200
01D0 A6790200
01D4 BB890200
01D8 8E9A0200
01DC 99AE0200               98                                                     DD      175769, 178219, 181435, 18339
                                   1, 187071, 191560, 196299, 198222
01E0 2BB80200
01E4 BBC40200
01E8 5FCC0200
01EC BFDA0200
01F0 48EC0200
01F4 CBFE0200
01F8 4E060300
01FC 81120300               99                                                     DD      201345, 205826, 210477, 21377
                                   0, 216003, 219454, 225267, 229879
0200 02240300
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    6


LOC  OBJ                  LINE     SOURCE

0204 2D360300
0208 0A430300
020C C34B0300
0210 3E590300
0214 F36F0300
0218 F7810300
021C 98950300              100                                                     DD      234904, 242475, 249711, 25986
                                   2, 260667
0220 2BB30300
0224 6FCF0300
0228 16F70300
022C 3BFA0300
0230 6912                  101             SOUND_SIZE                      DW      4713, 3768, 3464, 3370, 3002, 3297, 4
                                   506, 3893, 1796, 4298
0232 B80E
0234 880D
0236 2A0D
0238 BA0B
023A E10C
023C 9A11
023E 350F
0240 0407
0242 CA10
0244 BB0B                  102                                                     DW      3003, 4658, 3878, 4201, 4277,
                                    4651, 6132, 6318, 5295, 6045
0246 3212
0248 260F
024A 6910
024C B510
024E 2B12
0250 F417
0252 AE18
0254 AF14
0256 9D17
0258 250C                  103                                                     DW      3109, 2652, 3430, 3151, 4463,
                                    4705, 3080, 3699, 2849, 2928
025A 5C0A
025C 660D
025E 4F0C
0260 6F11
0262 6112
0264 080C
0266 730E
0268 210B
026A 700B
026C A40C                  104                                                     DW      3236, 4480, 3255, 3559, 1308,
                                    2882, 4274, 5070, 5808, 6600
026E 8011
0270 B70C
0272 E70D
0274 1C05
0276 420B
0278 B210
027A CE13
027C B016
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    7


LOC  OBJ                  LINE     SOURCE

027E C819
0280 270C                  105                                                     DW      3111, 4117, 4307, 5131, 2450,
                                    3216, 1956, 3680, 4489, 4739
0282 1510
0284 D310
0286 0B14
0288 9209
028A 900C
028C A407
028E 600E
0290 8911
0292 8312
0294 8307                  106                                                     DW      1923, 3123, 4481, 4651, 3293,
                                    2233, 3451, 5813, 4612, 5025
0296 330C
0298 8111
029A 2B12
029C DD0C
029E B908
02A0 7B0D
02A2 B516
02A4 0412
02A6 A113
02A8 931D                  107                                                     DW      7571, 7236, 10151, 805, 800
02AA 441C
02AC A727
02AE 2503
02B0 2003
  0000                     108             SOUND_INIT                      EQU 0
  001C                     109             SOUND_HUNDRED           EQU     28
  001D                     110             SOUND_THOUSAND          EQU     29
  001E                     111             SOUND_PRODUCT           EQU     30
  0032                     112             SOUND_AND                       EQU     50
  0034                     113             SOUND_COST                      EQU     52
  0035                     114             SOUND_DOLLAR            EQU     53
  0036                     115             SOUND_CENT                      EQU     54
  0037                     116             SOUND_GREETING          EQU     55
  0038                     117             SOUND_MORNING           EQU     56
  0039                     118             SOUND_AFTERNOON         EQU     57
  003A                     119             SOUND_EVENING           EQU     58
  003B                     120             SOUND_PAY                       EQU     59
  003C                     121             SOUND_PURCHASE          EQU     60
  003D                     122             SOUND_CHANGE            EQU     61
  003E                     123             SOUND_EXIT                      EQU     62
  003F                     124             SOUND_BEEP                      EQU     63
  0040                     125             SOUND_SILENCE           EQU     64
  0020                     126             SOUND_QUEUE_LEN         EQU     32
02B2 (32                   127             SOUND_QUEUE                     DB      SOUND_QUEUE_LEN DUP(?)
     ??
     )
02D2 00                    128             SOUND_HEAD                      DB      0
02D3 00                    129             SOUND_TAIL                      DB      0
02D4 00                    130             SOUND_TEST_LEFT         DB      0
                           131             
                           132     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    8


LOC  OBJ                  LINE     SOURCE

----                       133     DATA_SEG        ENDS
                           134     
                           135     ;----------------------------------------------------------------
                           136     ;--------------------DATA SEGMENT END----------------------------
                           137     ;----------------------------------------------------------------
                           138     
                           139     
                           140     ;----------------------------------------------------------------
                           141     ;--------------------CHIP SELECTS--------------------------------
                           142     ;----------------------------------------------------------------
                           143     ; 8255 register addresses
                           144     ; PCS1
  0080                     145     IC8255_PORTA_ADDR EQU 80H;
  0081                     146     IC8255_PORTB_ADDR EQU 81H;
  0082                     147     IC8255_PORTC_ADDR EQU 82H;
  0083                     148     IC8255_CW_ADDR    EQU 83H;
                           149     
  0100                     150     PCS2_ADDR EQU 100H
  0180                     151     PCS3_ADDR EQU 180H
  0200                     152     PCS4_ADDR EQU 200H
                           153     
  FFA6                     154     MMCS EQU 0FFA6H
  FFA8                     155     MPCS EQU 0FFA8H
                           156     
                           157     ;----------------------------------------------------------------
                           158     ;-------------------CHIP SELECT END------------------------------
                           159     ;----------------------------------------------------------------
                           160     
                           161     
                           162     ;----------------------------------------------------------------
                           163     ;--------------------CODE SEGMENT--------------------------------
                           164     ;----------------------------------------------------------------
                           165     
----                       166     CODE_SEG        SEGMENT
                           167             PUBLIC          START
                           168     ASSUME          CS:CODE_SEG, SS:STACK_SEG, DS:DATA_SEG
                           169     
0000                       170     START:
                           171     
                           172     ;-----------------------STACK AREA INIT--------------------------
0000 B8----         R      173             MOV     AX, STACK_SEG           
0003 8ED0                  174             MOV     SS, AX
0005 368B260001            175             MOV     SP, TOS
                           176     
000A B8----         R      177             MOV AX, DATA_SEG
000D 8ED8                  178             MOV DS, AX
                           179     ;----------------------------------------------------------------
                           180     
                           181     ;--------------ON-CHIP PERIPEHRALS--------------------------------
000F 9A0000----     E      182             CALL    FAR PTR IODEFINE
                           183             
                           184             ;IC8255 - Control Word
0014 BA8300                185             MOV DX, IC8255_CW_ADDR
                           186     
                           187             ;CW Register 
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE    9


LOC  OBJ                  LINE     SOURCE

                           188             ;Port C Lower Input, Port C Upper Output 
                           189             ;Port B input, Port A output
                           190             ;1 0 0 0 0 0 1 0
0017 B082                  191             MOV AL, 82H
0019 EE                    192             OUT DX, AL
                           193     
                           194     ; Initialize MCS
                           195     
001A BAA6FF                196             MOV DX, MMCS
001D B80380                197             MOV     AX, 8003H
0020 EF                    198             OUT     DX, AX
                           199     
0021 BAA8FF                200             MOV DX, MPCS
0024 B88440                201             MOV AX, 4084H
0027 EF                    202             OUT DX, AX
                           203     
                           204     ;----------------------------------------------------------------
                           205     
                           206     ;This procedure generates 10ms delay at 5MHz
                           207     ;operating frequency, which corresponds to 
                           208     ;50,000 clock cycles.
                           209     ;DEBOUNCE PROC  NEAR
                           210     ;       PUSH    CX
                           211     ;       MOV CX, 094Ch ; 2380 dec
                           212     ;       BACK:           
                           213     ;               NOP       ; 3 clocks
                           214     ;       LOOP BACK; 18 clocks
                           215     ;       POP CX
                           216     ;       RET
                           217     ;DEBOUNCE ENDP
                           218     
                           219     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                           220     
                           221     ;------------------------Setting the timers---------------------
                           222         ;call Set_timer0
                           223             ;call Set_timer1
0028 9A0000----     E      224             call Set_timer2
002D FB                    225           STI
                           226     ;---------------------------------------------------------------
                           227     
002E                       228     NEXT:
                           229     ;----------------------------------------------------------------
                           230     ;--------------------MAIN LOOP INIT------------------------------
                           231     ;----------------------------------------------------------------
                           232     
                           233             ;slowing down the main loop
002E B9FF5F                234             MOV CX, 05FFFH ; 2380 dec
0031                       235             SLEEP:
0031 90                    236                     NOP
0032 E2FD                  237             LOOP SLEEP; 18 clocks
                           238     
                           239     ;----------------------------------------------------------------
                           240     ;--------------------START KEYPAD----------------------------------
                           241     ;----------------------------------------------------------------
0034 33C0                  242             XOR AX, AX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   10


LOC  OBJ                  LINE     SOURCE

0036 D0060D01              243             ROL KEYPAD_ROW, 01H
003A 803E0D0177            244             CMP KEYPAD_ROW, 77H
003F 7402                  245             JE RESET_KEYPAD_ROW
0041 7505                  246             JNZ CHECK_KEYPAD_ROW
                           247     
0043                       248     RESET_KEYPAD_ROW:
0043 C6060D010E            249             MOV KEYPAD_ROW, 0EH
                           250     
0048                       251     CHECK_KEYPAD_ROW:
0048 A00D01                252             MOV AL, KEYPAD_ROW
004B BA8200                253             MOV DX, IC8255_PORTC_ADDR       ;DX = Port B Address
004E EE                    254             OUT DX, AL                                      ;
004F BA8100                255             MOV DX, IC8255_PORTB_ADDR       ;
                           256     
0052                       257     CHECK_KEY_CLOSED:                               ;Check when key is pressed. Keep loop
                                   ing here
0052 EC                    258             IN AL, DX                                       ;Move to AL, value in Port B.
                                    
                           259             
                           260             ;--TODO: Get rid of these compares
0053 3C00                  261             CMP AL, 00H
0055 74D7                  262             JE NEXT
0057 3C3F                  263             CMP AL, 03FH
0059 74D3                  264             JE NEXT
005B 3CFF                  265             CMP AL, 0FFH
005D 74CF                  266             JE NEXT
005F 3CBF                  267             CMP AL, 0BFH
0061 74CB                  268             JE NEXT
0063 3C7F                  269             CMP AL, 07FH
0065 74C7                  270             JE NEXT
0067 3C0F                  271             CMP AL, 0FH
0069 74C3                  272             JE NEXT
006B 3C08                  273             CMP AL, 08H
006D 74BF                  274             JE NEXT
                           275     
                           276             ;ANGAD'S SMARTASS HASHING ALGO
006F 22060D01              277             AND AL, KEYPAD_ROW
0073 8A260D01              278             MOV AH, KEYPAD_ROW
                           279     
0077 E80200                280             CALL NEAR PTR KEYPAD_PROCESS
                           281     
                           282     
                           283     ;----------------------------------------------------------------
                           284     ;--------------------END KEYPAD----------------------------------
                           285     ;----------------------------------------------------------------
007A EBB2                  286     JMP NEXT
                           287     
                           288     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
007C                       289     KEYPAD_PROCESS PROC NEAR
007C 50                    290             PUSH AX
007D 53                    291             PUSH BX
007E 51                    292             PUSH CX
007F 52                    293             PUSH DX
0080 1E                    294             PUSH DS
                           295     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   11


LOC  OBJ                  LINE     SOURCE

0081 BA----         R      296             MOV     DX, DATA_SEG
0084 8EDA                  297             MOV     DS, DX
                           298     
                           299             ;-------Keypad 1------------
                           300     
0086 B90A00                301             MOV CX, 10
0089                       302             FIND_KEY:
0089 8BD9                  303                     MOV BX, CX
008B 8AA70E01              304                     MOV AH, KEYPAD1_HASH[BX]
008F 3AE0                  305                     CMP AH, AL
0091 7404                  306                     JE RESOLVE_COLLISION
0093 E2F4                  307             LOOP FIND_KEY
                           308     
0095 7574                  309             JNE KEYPAD2
                           310     
0097                       311             RESOLVE_COLLISION:
0097 A00D01                312                     MOV AL, KEYPAD_ROW
                           313     
                           314                     ;PUSH AX
                           315                     ;CALL FAR PTR PRINT_2HEX
                           316                     ;MOV AL, 0AH ;NEW LINE
                           317                     ;CALL   FAR PTR PRINT_CHAR
                           318                     ;MOV AL, 0DH ;CARRIAGE RETURN
                           319                     ;CALL   FAR PTR PRINT_CHAR
                           320                     ;POP AX
                           321     
009A 83F90A                322                     CMP CX, 10
009D 7435                  323                     JE COLLISION_6_STAR
009F 83F907                324                     CMP CX, 7
00A2 7439                  325                     JE COLLISION_7_5
00A4 83F909                326                     CMP CX, 9
00A7 743D                  327                     JE COLLISION_9_0
                           328     
00A9                       329             ADD_BARCODE:
00A9 8BD9                  330                     MOV BX, CX
00AB 8A87C300              331                     MOV AL, NUMBERS[BX]
00AF 8BCB                  332                     MOV CX, BX
00B1 8A1EE200              333                     MOV BL, BARCODE_I
00B5 8887CE00              334                     MOV BARCODE[BX], AL
00B9 888FD800              335                     MOV BARCODE_DEC[BX], CL
00BD FE06E200              336                     INC BARCODE_I
00C1 8A87D800              337                     MOV AL, BARCODE_DEC[BX]
00C5 0430                  338                     ADD AL, 48
00C7 9A0000----     E      339                     CALL FAR PTR PRINT_CHAR
00CC B03F                  340                     MOV AL, SOUND_BEEP
00CE E8D600                341                     CALL VOICE_ON_QUEUE
00D1 E9CD00                342                     JMP KEYPAD_EXIT
                           343     
00D4                       344             COLLISION_6_STAR:
00D4 3CFE                  345                     CMP AL, 0FEH
00D6 7417                  346                     JE CLEAR
00D8 B90600                347                     MOV CX, 6
00DB EBCC                  348                     JMP ADD_BARCODE
                           349     
00DD                       350             COLLISION_7_5:
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   12


LOC  OBJ                  LINE     SOURCE

00DD 3CFB                  351                     CMP AL, 0FBH
00DF 75C8                  352                     JNE ADD_BARCODE
00E1 B90500                353                     MOV CX, 5
00E4 EBC3                  354                     JMP ADD_BARCODE
                           355     
00E6                       356             COLLISION_9_0:
00E6 3CFE                  357                     CMP AL, 0FEH
00E8 75BF                  358                     JNE ADD_BARCODE
00EA B90000                359                     MOV CX, 0
00ED EBBA                  360                     JMP ADD_BARCODE
                           361     
00EF                       362             CLEAR:
00EF 33DB                  363                     XOR BX, BX
00F1 B90800                364                     MOV CX, 08H
00F4                       365                     CLEAR_BARCODE:
00F4 8BD9                  366                             MOV BX, CX
00F6 4B                    367                             DEC BX
00F7 C687CE0000            368                             MOV BARCODE[BX], 00H
00FC C687D80000            369                             MOV BARCODE_DEC[BX], 00H
0101 E2F1                  370                     LOOP CLEAR_BARCODE
0103 C606E20000            371                     MOV BARCODE_I, 00H
0108 E99600                372                     JMP KEYPAD_EXIT
                           373     
010B                       374             KEYPAD2:
010B B90A00                375                     MOV CX, 10
010E                       376                     FIND_KEY2:
010E 8BD9                  377                             MOV BX, CX
0110 8AA71901              378                             MOV AH, KEYPAD2_HASH[BX]
0114 3AE0                  379                             CMP AH, AL
0116 7402                  380                             JE PROCESS_COMMAND
0118 E2F4                  381                     LOOP FIND_KEY2
                           382     
011A                       383                     PROCESS_COMMAND:
011A 83F901                384                             CMP CX, 1
011D 7437                  385                             JE NEW_TRANSACTION
011F 83F902                386                             CMP CX, 2
0122 7446                  387                             JE NEW_ITEM
0124 83F903                388                             CMP CX, 3
0127 7453                  389                             JE SEND_BARCODE
0129 83F904                390                             CMP CX, 4
012C 7408                  391                             JE DUMMY_PRODUCT
012E 83F90A                392                             CMP CX, 10
0131 7462                  393                             JE SEND_QUANTITY
0133 EB6C90                394                             JMP KEYPAD_EXIT
                           395                     
                           396     
0136                       397                     DUMMY_PRODUCT:
0136 33DB                  398                             XOR BX, BX
0138 33C9                  399                             XOR CX, CX
013A B90900                400                             MOV CX,9
013D                       401                             PRINT_DUMMY_PRODUCT:
013D BB0900                402                                     MOV BX, 9
0140 2BD9                  403                                     SUB BX, CX
0142 8A87A800              404                                     MOV AL, PRODUCT1[BX]
0146 9A0000----     E      405                                     CALL FAR PTR PRINT_CHAR
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   13


LOC  OBJ                  LINE     SOURCE

014B E2F0                  406                             LOOP PRINT_DUMMY_PRODUCT
014D B00A                  407                             MOV AL, 0AH
014F 9A0000----     E      408                             CALL FAR PTR PRINT_CHAR
                           409                             ;MOV AL, 0DH
                           410                             ;CALL FAR PTR PRINT_CHAR
0154 EB99                  411                             JMP CLEAR
                           412     
                           413     
                           414                     ; New transaction
                           415                     ; Send [OP]EN to shop pc
                           416                     ; Play greeting
0156                       417                     NEW_TRANSACTION:
0156 B05F                  418                             MOV AL, '_'
0158 9A0000----     E      419                             CALL FAR PTR PRINT_CHAR
015D B037                  420                             MOV AL, SOUND_GREETING
015F E84500                421                             CALL NEAR PTR VOICE_ON_QUEUE
0162 B039                  422                             MOV AL, SOUND_AFTERNOON
0164 E84000                423                             CALL NEAR PTR VOICE_ON_QUEUE
0167 EB3890                424                             JMP KEYPAD_EXIT
                           425     
                           426                     ; New item
                           427                     ; Send [IT]EM to shop pc
                           428                     ; Clear BCD
                           429                     ; Wait for user to input Barcode
016A                       430                     NEW_ITEM:
016A B062                  431                             MOV AL, 'b'
016C 9A0000----     E      432                             CALL FAR PTR PRINT_CHAR
0171 B03F                  433                             MOV AL, SOUND_BEEP
0173 E83100                434                             CALL NEAR PTR VOICE_ON_QUEUE
0176 E976FF                435                             JMP CLEAR
0179 EB2690                436                             JMP KEYPAD_EXIT
                           437     
017C                       438                     SEND_BARCODE:
017C B03F                  439                             MOV AL, SOUND_BEEP
017E E82600                440                             CALL NEAR PTR VOICE_ON_QUEUE
0181 B00A                  441                             MOV AL, 0AH
0183 9A0000----     E      442                             CALL FAR PTR PRINT_CHAR
0188 B071                  443                             MOV AL, 'q'
018A 9A0000----     E      444                             CALL FAR PTR PRINT_CHAR
018F E95DFF                445                             JMP CLEAR
0192 EB0D90                446                             JMP KEYPAD_EXIT
                           447     
0195                       448                     SEND_QUANTITY:
0195 B03F                  449                             MOV AL, SOUND_BEEP
0197 E80D00                450                             CALL NEAR PTR VOICE_ON_QUEUE
019A B00A                  451                             MOV AL, 0AH
019C 9A0000----     E      452                             CALL FAR PTR PRINT_CHAR
                           453     
                           454     
01A1                       455     KEYPAD_EXIT:
01A1 1F                    456             POP     DS
01A2 5A                    457             POP DX
01A3 59                    458             POP CX
01A4 5B                    459             POP BX
01A5 58                    460             POP AX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   14


LOC  OBJ                  LINE     SOURCE

                           461     
01A6 C3                    462             RET
                           463     KEYPAD_PROCESS ENDP
                           464     
                           465     ;------------------VOICE-------------------------
01A7                       466     VOICE_ON_QUEUE PROC NEAR
01A7 50                    467             PUSH AX
01A8 53                    468             PUSH BX
01A9 52                    469             PUSH DX
01AA 1E                    470             PUSH DS
                           471             
01AB BA----         R      472             MOV     DX, DATA_SEG
01AE 8EDA                  473             MOV     DS, DX
                           474     
01B0 B700                  475             MOV BH, 0
01B2 8A1ED202              476             MOV BL, BYTE PTR SOUND_HEAD
01B6 8887B202              477             MOV BYTE PTR SOUND_QUEUE[BX], AL
01BA FEC3                  478             INC BL
                           479     
01BC 80FB20                480             CMP BL, SOUND_QUEUE_LEN
01BF 7502                  481             JNE VOICE_ON_QUEUE_STALL
                           482             
01C1 B300                  483             MOV BL, 0
                           484             
01C3                       485     VOICE_ON_QUEUE_STALL:
                           486                     
01C3 881ED202              487             MOV BYTE PTR SOUND_HEAD, BL
01C7 9A0000----     E      488             CALL    FAR PTR Set_timer0
                           489             
01CC 1F                    490             POP     DS
01CD 5A                    491             POP DX
01CE 5B                    492             POP BX
01CF 58                    493             POP AX
                           494             
01D0 C3                    495             RET
                           496     VOICE_ON_QUEUE ENDP
                           497     
                           498     
01D1                       499     SERIAL_REC_ACTION       PROC    FAR
01D1 51                    500                     PUSH    CX
01D2 53                    501                     PUSH    BX
01D3 1E                    502                     PUSH    DS
                           503     
01D4 BB----         R      504                     MOV     BX,DATA_SEG             ;initialize data segment register
01D7 8EDB                  505                     MOV     DS,BX
                           506     
01D9 3C30                  507                     CMP     AL, '0'
01DB 7C4A                  508                     JL S_RET
                           509                     ;PUSH AX
                           510                     ;MOV AL, SOUND_BEEP
                           511                     ;CALL NEAR PTR VOICE_ON_QUEUE
                           512                     ;POP AX
                           513     
                           514                     ;JNE    S_FAST
                           515     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   15


LOC  OBJ                  LINE     SOURCE

01DD FE06BD00              516                     INC     DS:T0_COUNT_SET
01E1 FE06BD00              517                     INC     DS:T0_COUNT_SET
                           518                     
                           519                     ;MOV DX, IC8255_PORTA_ADDR
                           520                     ;MOV AL, 0FFH
                           521                     ;OUT DX, AL
                           522     
01E5                       523     DISP_PRICE:
                           524     
01E5 33DB                  525             XOR BX, BX
01E7 8AD8                  526             MOV BL, AL
01E9 80EB30                527             SUB BL, 48
01EC 8A87C300              528             MOV AL, NUMBERS[BX]
01F0 8BCB                  529             MOV CX, BX
01F2 8A1EE200              530             MOV BL, BARCODE_I
01F6 8887CE00              531             MOV BARCODE[BX], AL
01FA 888FD800              532             MOV BARCODE_DEC[BX], CL
01FE FE06E200              533             INC BARCODE_I
                           534             ;PUSH AX
                           535             ;MOV AL, SOUND_BEEP
                           536             ;CALL NEAR PTR VOICE_ON_QUEUE
                           537             ;POP AX
                           538     
0202 EB2390                539             JMP S_RET
                           540     
0205                       541     S_FAST:
0205 3C01                  542                     CMP     AL,01H
0207 751E                  543                     JNE     S_RET
                           544     
0209 FE0EBD00              545                     DEC     DS:T0_COUNT_SET
020D FE0EBD00              546                     DEC     DS:T0_COUNT_SET
                           547     
0211                       548     S_NEXT0:
0211 B90F00                549                     MOV     CX,15                   ;initialize counter for message
0214 BB0000                550                     MOV     BX,0
                           551     
0217                       552     S_NEXT1:        
0217 8A476E                553                     MOV     AL,DS:REC_MESS[BX]      ;print message
021A 9A0000----     E      554                     call    FAR ptr print_char
021F 43                    555                     INC     BX
0220 E2F5                  556                     LOOP    S_NEXT1
0222 B037                  557                     MOV AL, SOUND_GREETING
0224 E880FF                558                     CALL NEAR PTR VOICE_ON_QUEUE
                           559     
0227                       560     S_RET:
0227 1F                    561                     POP     DS
0228 5B                    562                     POP     BX
0229 59                    563                     POP     CX
022A CB                    564                     RET
                           565     SERIAL_REC_ACTION       ENDP
                           566     
                           567     
                           568     ;--------------------------------------------------------------
                           569     
                           570     ;--------------------TIMER 0 ----------------------------------
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   16


LOC  OBJ                  LINE     SOURCE

                           571     
022B                       572     TIMER0_ACTION   PROC    FAR
022B 50                    573                     PUSH    AX
022C 1E                    574                     PUSH    DS
022D 53                    575                     PUSH    BX
022E 51                    576                     PUSH    CX
                           577     
022F 33C0                  578             XOR AX,AX
0231 33DB                  579             XOR BX,BX
0233 33C9                  580             XOR CX,CX
0235 33D2                  581             XOR DX,DX
                           582     
0237 B8----         R      583             MOV     AX,DATA_SEG
023A 8ED8                  584             MOV     DS,AX
                           585             
                           586             ;slowing down the timer 
                           587             ;MOV CX, 04FFFH ; 2380 dec
                           588             ;SLEEP_TIMER:
                           589             ;       NOP
                           590             ;LOOP SLEEP_TIMER; 18 clocks
                           591     
                           592     ;----------------------------------------------------
                           593             ; SOUND_LEFT: Number of bytes left in the queue
023C 833E2A0100            594             CMP WORD PTR SOUND_LEFT, 0
0241 7544                  595             JNE timer0_ACTION_PROCEED
                           596             
                           597             ; Reload with next item in the queue
0243 B700                  598             MOV BH, 0
0245 8A1ED302              599             MOV BL, BYTE PTR SOUND_TAIL
                           600             
0249 381ED202              601             CMP BYTE PTR SOUND_HEAD, BL
024D 7508                  602             JNE timer0_ACTION_RELOAD
                           603             
                           604             ;disable timer 0, freeing up resources
024F 9A0000----     E      605             call disable_timer0
                           606      
0254 EB6690                607             JMP T0_NEXT1
                           608             
0257                       609     timer0_ACTION_RELOAD:
                           610             
0257 8A9FB202              611             MOV BL, BYTE PTR SOUND_QUEUE[BX]
025B BE2C01                612             MOV SI, OFFSET SOUND_BASE_ADDR
                           613                     
025E C1E302                614             SHL BX, 2
0261 8B00                  615             MOV AX, WORD PTR [BX][SI]
                           616      
0263 A32601                617             MOV WORD PTR SOUND_ADDR[0], AX
                           618             
0266 8B4002                619             MOV AX, WORD PTR 2[BX][SI]      
0269 A32801                620             MOV WORD PTR SOUND_ADDR[2], AX
                           621             
026C D1EB                  622             SHR BX, 1
026E BE3002                623             MOV SI, OFFSET SOUND_SIZE
0271 8B00                  624             MOV AX, WORD PTR [BX][SI]
0273 A32A01                625             MOV WORD PTR SOUND_LEFT, AX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   17


LOC  OBJ                  LINE     SOURCE

0276 A0D302                626             MOV AL, BYTE PTR SOUND_TAIL
0279 FEC0                  627             INC AL
027B 3C20                  628             CMP AL, SOUND_QUEUE_LEN
027D 7502                  629             JNE timer0_QUEUE_NO_OVERFLOW
                           630             
027F B000                  631             MOV AL, 0
                           632             
0281                       633     timer0_QUEUE_NO_OVERFLOW:
                           634     
0281 A2D302                635             MOV BYTE PTR SOUND_TAIL, AL
0284 EB3690                636             JMP T0_NEXT1
                           637             
0287                       638     timer0_ACTION_PROCEED:
                           639     
0287 FF0E2A01              640             DEC WORD PTR SOUND_LEFT
                           641             
028B 8B362601              642             MOV SI, WORD PTR SOUND_ADDR[0]
028F 8B3E2801              643             MOV DI, WORD PTR SOUND_ADDR[2]
                           644     
                           645             ; SI - Intra-segment address, DI - Segment address
0293 83C708                646             ADD DI, 8H
0296 C1E70C                647             SHL DI, 12
                           648     
                           649             ; Set extra segment to point to 8000H, the starting segment of the EEPROM
0299 8EDF                  650             MOV DS, DI
                           651              
                           652             ; Get byte from EEPROM address space
029B 8A04                  653             MOV AL, [SI]
                           654             
                           655             ; Put byte to DAC
029D BA0002                656             MOV DX, PCS4_ADDR
02A0 EE                    657             OUT DX, AL
                           658             
                           659             ; Increment EEPROM address to move to the next sample
02A1 B8----         R      660             MOV AX, DATA_SEG
02A4 8ED8                  661             MOV DS, AX
                           662     
02A6 FF062601              663             INC WORD PTR SOUND_ADDR[0]
02AA 7510                  664             JNZ T0_NEXT1
                           665     
                           666             ; Increment memory segment
02AC FF062801              667             INC WORD PTR SOUND_ADDR[2]
                           668     
                           669     ;---------------------------------------------
                           670     
                           671     
02B0 FE0EBC00              672             DEC     DS:T0_COUNT
02B4 7506                  673             JNZ     T0_NEXT1
02B6 A0BD00                674             MOV     AL,DS:T0_COUNT_SET
02B9 A2BC00                675             MOV     DS:T0_COUNT,AL
                           676     
02BC                       677     T0_NEXT1:
                           678     ;T0_NEXT1:
02BC 59                    679             POP     CX
02BD 5B                    680             POP     BX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   18


LOC  OBJ                  LINE     SOURCE

02BE 1F                    681             POP     DS
02BF 58                    682             POP AX
02C0 CB                    683             RET
                           684     TIMER0_ACTION   ENDP
                           685     
                           686     ;--------------------------------------------------------------
                           687     
                           688     ;--------------------TIMER 1 ----------------------------------
                           689     
02C1                       690     TIMER1_ACTION   PROC    FAR
02C1 50                    691                     PUSH    AX
02C2 1E                    692                     PUSH    DS
02C3 53                    693                     PUSH    BX
02C4 51                    694                     PUSH    CX
                           695     
02C5 B8----         R      696                     MOV     AX,DATA_SEG
02C8 8ED8                  697                     MOV     DS,AX
                           698             
02CA FE0EBE00              699                     DEC     DS:T1_COUNT
02CE 7517                  700                     JNZ     T1_NEXT1
02D0 A0BF00                701                     MOV     AL,DS:T1_COUNT_SET
02D3 A2BE00                702                     MOV     DS:T1_COUNT,AL
                           703     
02D6 B91400                704                     MOV     CX,20
02D9 BB0000                705                     MOV     BX,0H
02DC                       706     T1_NEXT0:
02DC 8A472C                707                     MOV     AL,DS:TIMER1_MESS[BX]
02DF 43                    708                     INC     BX
02E0 9A0000----     E      709                     CALL    FAR PTR PRINT_CHAR
02E5 E2F5                  710                     LOOP    T1_NEXT0
                           711     
02E7                       712     T1_NEXT1:       
02E7 59                    713                     POP     CX
02E8 5B                    714                     POP     BX
02E9 1F                    715                     POP     DS
02EA 58                    716                     POP     AX
02EB CB                    717                     RET
                           718     TIMER1_ACTION   ENDP
                           719     
                           720     ;--------------------------------------------------------------
                           721     
                           722     ;--------------------TIMER 2 ----------------------------------
                           723     
                           724     
02EC                       725     TIMER2_ACTION   PROC    FAR
02EC 50                    726                     PUSH    AX
02ED 1E                    727                     PUSH    DS
02EE 53                    728                     PUSH    BX
02EF 51                    729                     PUSH    CX
                           730     
02F0 33C0                  731                     XOR AX, AX
02F2 33DB                  732                     XOR BX, BX
                           733                     
                           734                     
                           735     ;----------------------------
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    19:27:08  12/04/;2  PAGE   19


LOC  OBJ                  LINE     SOURCE

                           736                     ;AD0 - AD5 PCS3 CS for 7-segment
                           737                     ;7  6  5  4  3  2  1  0
                           738                     ;x  x  A5 A4 A3 A2 A1 A0
02F4 BA8001                739                     MOV DX, PCS3_ADDR
02F7 A0C200                740                     MOV AL, LED_SELECT
                           741                     ;MOV AL, 00111110B
02FA EE                    742                     OUT DX, AL
02FB D006C200              743                     ROL LED_SELECT, 01H
                           744     
                           745                     ;AD0 - AD7 PCS2
                           746                     ;AD7 - DOT (MSB)
                           747                     
02FF BA0001                748                     MOV DX, PCS2_ADDR
0302 8A1ECD00              749                     MOV BL, CURRENT_NUMBER
0306 8A87CE00              750                     MOV AL, BARCODE[BX]
                           751                     ;MOV AL, 01111111B
030A EE                    752                     OUT DX, AL
030B FE06CD00              753                     INC CURRENT_NUMBER
030F 803ECD0008            754                     CMP CURRENT_NUMBER, 08H
0314 7411                  755                     JE RESET_CURRENT
0316 7523                  756                     JNE T2_NEXT1
                           757     ;---------------------------
0318 FE0EC000              758                     DEC     DS:T2_COUNT
031C 751D                  759                     JNZ     T2_NEXT1
031E A0C100                760                     MOV     AL,DS:T2_COUNT_SET
0321 A2C000                761                     MOV     DS:T2_COUNT,AL
0324 BB0000                762                     MOV     BX,0H
                           763                     
0327                       764     RESET_CURRENT:
0327 C606CD0000            765                     MOV CURRENT_NUMBER, 00H
032C FE0EC000              766                     DEC     DS:T2_COUNT
0330 7509                  767                     JNZ     T2_NEXT1
0332 A0C100                768                     MOV     AL,DS:T2_COUNT_SET
0335 A2C000                769                     MOV     DS:T2_COUNT,AL
0338 BB0000                770                     MOV     BX,0H
                           771     
033B                       772     T2_NEXT1:
033B 59                    773                     POP     CX
033C 5B                    774                     POP     BX
033D 1F                    775                     POP     DS
033E 58                    776                     POP AX
033F CB                    777                     RET
                           778     
                           779     TIMER2_ACTION   ENDP
                           780     
                           781     ;--------------------------------------------------------------
                           782     
----                       783     CODE_SEG        ENDS
                           784     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
