8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\USERS\ANGADS~1\DOWNLO~1\ASM\ASM\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer0_action, timer1_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   Set_timer0:far, Set_timer1:far, Set_timer2:far
                            20     
----                        21     STACK_SEG       SEGMENT
0000 (256                   22                     DB      256 DUP(?)
     ??
     )
0100                        23             TOS     LABEL   WORD
----                        24     STACK_SEG       ENDS
                            25     
                            26     
----                        27     DATA_SEG        SEGMENT
0000 0A                     28             MAIN_MESS   DB  10,13,'Main Loop           '
0001 0D
0002 4D61696E204C6F
     6F702020202020
     202020202020
0016 0A                     29             TIMER0_MESS     DB      10,13,'TIMER0 INTERRUPT    '
0017 0D
0018 54494D45523020
     494E5445525255
     505420202020
002C 0A                     30             TIMER1_MESS     DB      10,13,'TIMER1 INTERRUPT    '
002D 0D
002E 54494D45523120
     494E5445525255
     505420202020
0042 0A                     31             TIMER2_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0043 0D
0044 54494D45523220
     494E5445525255
     505420202020
0058 0A                     32             KEY_PRESSED DB  10,13,'KEY PRESSED         '
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

0059 0D
005A 4B455920505245
     53534544202020
     202020202020
                            33             
                            34             ; -- define messages for other timers
                            35     
006E 2F                     36             T0_COUNT                DB      2FH
006F 2F                     37             T0_COUNT_SET    DB      2FH
0070 2F                     38             T1_COUNT                DB      2FH
0071 2F                     39             T1_COUNT_SET    DB      2FH
0072 2F                     40             T2_COUNT                DB      2FH
0073 2F                     41             T2_COUNT_SET    DB      2FH
                            42     
0074 FE                     43             LED_SELECT  DB  0FEH
0075 3F                     44             NUMBERS         DB      03FH, 006H, 05BH, 04FH, 066H, 06DH, 07DH, 007H, 07FH,
                                    06FH
0076 06
0077 5B
0078 4F
0079 66
007A 6D
007B 7D
007C 07
007D 7F
007E 6F
007F 00                     45             CURRENT_NUMBER DB 00H
0080 00                     46             BARCODE         DB  00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
0081 00
0082 00
0083 00
0084 00
0085 00
0086 00
0087 00
0088 00
0089 00
                            47             ;BARCODE                DB  03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 0
                                   3FH, 03FH
008A 00                     48             BARCODE_I       DB 00H
008B 0A                     49             REC_MESS        DB      10,13,'Period of timer0 =     '
008C 0D
008D 506572696F6420
     6F662074696D65
     7230203D202020
     2020
                            50     
                            51              ;****Keypad******
00A4 (24                    52       KEY_DECODE    DB 24 DUP(0)
     00
     )
00BC 00                     53       LAST_FOUND    DB 0H ; 0 NO KEY FOUND, 1 KEY FOUND
00BD 21                     54       KEYPAD_INPUT  DB 33 
                            55       ;**********
                            56     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

                            57     
----                        58     DATA_SEG        ENDS
                            59     
                            60     ;------------------------------------------
                            61     ;--CHIP SELECTS
                            62     ; 8255 register addresses
                            63     ; PCS1
  0080                      64     IC8255_PORTA_ADDR EQU 80H;
  0081                      65     IC8255_PORTB_ADDR EQU 81H;
  0082                      66     IC8255_PORTC_ADDR EQU 82H;
  0083                      67     IC8255_CW_ADDR    EQU 83H;
                            68     
  0100                      69     PCS2_ADDR EQU 100H
  0180                      70     PCS3_ADDR EQU 180H
  0200                      71     PCS4_ADDR EQU 200H
                            72             
                            73     
                            74     
                            75     ;-------------------------------------------
                            76     
----                        77     CODE_SEG        SEGMENT
                            78     
                            79             PUBLIC          START
                            80     
                            81     ASSUME  CS:CODE_SEG, SS:STACK_SEG, DS:DATA_SEG
                            82     
0000                        83     START:
                            84     
                            85     ;initialize stack area
0000 B8----         R       86                     MOV     AX, STACK_SEG           
0003 8ED0                   87                     MOV     SS, AX
0005 368B260001             88                     MOV     SP, TOS
                            89     
000A B8----         R       90                     MOV AX, DATA_SEG
000D 8ED8                   91                     MOV DS, AX
                            92     
                            93     ; Initialize the on-chip pheripherals
000F 9A0000----     E       94                     CALL    FAR PTR IODEFINE
                            95                     
                            96             ;KEYPAD INIT
                            97     
0014 BA8300                 98             MOV DX, IC8255_CW_ADDR
                            99     
                           100             ;CW Register 
                           101             ;Port C Lower Input, Port C Upper Output 
                           102             ;Port B input, Port A output
                           103             ;1 0 0 0 0 0 1 0
                           104     
0017 B082                  105             MOV AL, 82H
0019 EE                    106             OUT DX, AL
                           107     
                           108     ; Initialize MCS
                           109     
                           110     
                           111     ;This procedure generates 10ms delay at 5MHz
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           112     ;operating frequency, which corresponds to 
                           113     ;50,000 clock cycles.
                           114     ;DEBOUNCE PROC  NEAR
                           115     ;       PUSH    CX
                           116     ;       MOV CX, 094Ch ; 2380 dec
                           117     ;       BACK:           
                           118     ;               NOP       ; 3 clocks
                           119     ;       LOOP BACK; 18 clocks
                           120     ;       POP CX
                           121     ;       RET
                           122     ;DEBOUNCE ENDP
                           123     
                           124     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                           125         ;call Set_timer0
                           126             ;call Set_timer1
001A 9A0000----     E      127             call Set_timer2
001F FB                    128           STI
                           129     
0020                       130     NEXT:     
                           131     ;BEGIN MAIN LOOP
                           132             ;slowing down the main loop
0020 B9FFFF                133             MOV CX, 0FFFFH ; 2380 dec
0023                       134             SLEEP:
0023 90                    135                     NOP
0024 E2FD                  136             LOOP SLEEP; 18 clocks
                           137     
                           138             ;MOV AL, 01H ;Printing 1 to check the start of main loop
                           139             ;CALL FAR PTR PRINT_2HEX
0026 B00A                  140             MOV AL, 0AH ;NEW LINE
0028 9A0000----     E      141             CALL    FAR PTR PRINT_CHAR
002D B00D                  142             MOV AL, 0DH ;CARRIAGE RETURN
002F 9A0000----     E      143             CALL    FAR PTR PRINT_CHAR
                           144     
0034 BA8200                145             MOV DX, IC8255_PORTC_ADDR       ;DX = Port B Address
0037 EE                    146             OUT DX, AL                                      ;
0038 BA8100                147             MOV DX, IC8255_PORTB_ADDR       ;
                           148     
003B                       149     CHECK_KEY_CLOSED:                               ;Check when key is pressed. Keep loop
                                   ing here
003B EC                    150             IN AL, DX                                       ;Move to AL, value in Port B.
                                    
003C 50                    151             PUSH AX
003D 9A0000----     E      152             CALL    FAR PTR PRINT_2HEX
0042 58                    153             POP AX
                           154             ;Since PB6-PB7 pins are floating,
                           155             ;the input can be anything from the below given values
0043 3C3F                  156             CMP AL, 03FH
0045 74D9                  157             JE NEXT
0047 3CFF                  158             CMP AL, 0FFH
0049 74D5                  159             JE NEXT
004B 3CBF                  160             CMP AL, 0BFH
004D 74D1                  161             JE NEXT
004F 3C7F                  162             CMP AL, 07FH
0051 74CD                  163             JE NEXT
0053 3C0F                  164             CMP AL, 0FH
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

0055 74C9                  165             JE NEXT
                           166     
0057 3C3E                  167             CMP AL, 03EH
0059 7426                  168             JZ K13
005B 3CFE                  169             CMP AL, 0FEH
005D 7422                  170             JZ K13
                           171     
005F 3C3D                  172             CMP AL, 03DH
0061 7443                  173             JZ K12
0063 3CFD                  174             CMP AL, 0FDH
0065 743F                  175             JZ K12
                           176     
0067 3C3B                  177             CMP AL, 03BH
0069 7460                  178             JZ K11
006B 3CFB                  179             CMP AL, 0FBH
006D 745C                  180             JZ K11
                           181     
006F 3C37                  182             CMP AL, 037H
0071 747D                  183             JZ K23
0073 3CF7                  184             CMP AL, 0F7H
0075 7479                  185             JZ K23
                           186     
0077 3CEF                  187             CMP AL, 0EFH
0079 7475                  188             JZ K23
007B 3C2F                  189             CMP AL, 02FH
007D 7471                  190             JZ K23
                           191     
007F 759F                  192             JNZ NEXT
                           193     
                           194     ;Column 3 of keypad
0081                       195     K13:
                           196             ;Debounce
0081 B9FFFF                197             MOV CX, 0FFFFH ; 2380 dec
0084                       198             BACK13:         
0084 90                    199                     NOP     
0085 E2FD                  200             LOOP BACK13; 18 clocks
                           201             
0087 50                    202             PUSH AX
0088 B003                  203             MOV AL,03H ;print 2 to check if the key was pressed
008A 9A0000----     E      204             CALL FAR PTR PRINT_2HEX
008F 58                    205             POP AX
                           206     
0090 33DB                  207             XOR BX, BX
0092 B303                  208             MOV BL, 03H
0094 8A4775                209             MOV AL, NUMBERS[BX]
0097 8A1E8A00              210             MOV BL, BARCODE_I
009B 88878000              211             MOV BARCODE[BX], AL
009F FE068A00              212             INC BARCODE_I
00A3 E97AFF                213             JMP NEXT
                           214     
                           215     ;Column 2 of Keypad
00A6                       216     K12:
                           217             ;Debounce
00A6 B9FFFF                218             MOV CX, 0FFFFH ; 2380 dec
00A9                       219             BACK12:         
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    6


LOC  OBJ                  LINE     SOURCE

00A9 90                    220                     NOP     
00AA E2FD                  221             LOOP BACK12; 18 clocks
                           222             
00AC 50                    223             PUSH AX
00AD B002                  224             MOV AL,02H ;print 2 to check if the key was pressed
00AF 9A0000----     E      225             CALL FAR PTR PRINT_2HEX
00B4 58                    226             POP AX
                           227     
00B5 33DB                  228             XOR BX, BX
00B7 B302                  229             MOV BL, 02H
00B9 8A4775                230             MOV AL, NUMBERS[BX]
00BC 8A1E8A00              231             MOV BL, BARCODE_I
00C0 88878000              232             MOV BARCODE[BX], AL
00C4 FE068A00              233             INC BARCODE_I
00C8 E955FF                234             JMP NEXT
                           235     
                           236     ;Column 1 of Keypad
00CB                       237     K11:
                           238             ;Debounce
00CB B9FFFF                239             MOV CX, 0FFFFH ; 2380 dec
00CE                       240             BACK11:         
00CE 90                    241                     NOP     
00CF E2FD                  242             LOOP BACK11; 18 clocks
                           243             
00D1 50                    244             PUSH AX
00D2 B001                  245             MOV AL,01H ;print 2 to check if the key was pressed
00D4 9A0000----     E      246             CALL FAR PTR PRINT_2HEX
00D9 58                    247             POP AX
                           248     
00DA 33DB                  249             XOR BX, BX
00DC B301                  250             MOV BL, 01H
00DE 8A4775                251             MOV AL, NUMBERS[BX]
00E1 8A1E8A00              252             MOV BL, BARCODE_I
00E5 88878000              253             MOV BARCODE[BX], AL
00E9 FE068A00              254             INC BARCODE_I
00ED E930FF                255             JMP NEXT
                           256     
                           257     ;Column 3 of Keypad 2
00F0                       258     K23:
                           259             ;Debounce
00F0 B9FFFF                260             MOV CX, 0FFFFH ; 2380 dec
00F3                       261             BACK23:         
00F3 90                    262                     NOP     
00F4 E2FD                  263             LOOP BACK23; 18 clocks
                           264             
00F6 50                    265             PUSH AX
00F7 B003                  266             MOV AL,03H ;print 2 to check if the key was pressed
00F9 9A0000----     E      267             CALL FAR PTR PRINT_2HEX
00FE 58                    268             POP AX
                           269     
00FF B90800                270             MOV CX, 08H
0102                       271             CLEAR_BARCODE:
0102 8BD9                  272                     MOV BX, CX
0104 4B                    273                     DEC BX
0105 C687800000            274                     MOV BARCODE[BX], 00H
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    7


LOC  OBJ                  LINE     SOURCE

010A E2F6                  275             LOOP CLEAR_BARCODE
010C C6068A0000            276             MOV BARCODE_I, 00H
0111 E90CFF                277             JMP NEXT
                           278     
0114                       279     K22:
                           280             ;Debounce
0114 B9FFFF                281             MOV CX, 0FFFFH ; 2380 dec
0117                       282             BACK22:         
0117 90                    283                     NOP     
0118 E2FD                  284             LOOP BACK22; 18 clocks
                           285             
011A 50                    286             PUSH AX
011B B003                  287             MOV AL,03H ;print 2 to check if the key was pressed
011D 9A0000----     E      288             CALL FAR PTR PRINT_2HEX
0122 58                    289             POP AX
                           290     
0123 B90800                291             MOV CX, 08H
0126                       292             SET_BARCODE_1:
0126 8BD9                  293                     MOV BX, CX
0128 C68780007F            294                     MOV BARCODE[BX], 07FH
012D E2F7                  295             LOOP SET_BARCODE_1
012F C6068A0000            296             MOV BARCODE_I, 00H
                           297     
0134 E9E9FE                298     JMP NEXT
                           299     
                           300     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
                           301     
                           302     
0137                       303     SERIAL_REC_ACTION       PROC    FAR
0137 51                    304                     PUSH    CX
0138 53                    305                     PUSH    BX
0139 1E                    306                     PUSH    DS
                           307     
013A BB----         R      308                     MOV     BX,DATA_SEG             ;initialize data segment register
013D 8EDB                  309                     MOV     DS,BX
                           310     
013F 3C3C                  311                     CMP     AL,'<'
0141 750B                  312                     JNE     S_FAST
                           313     
0143 FE066F00              314                     INC     DS:T0_COUNT_SET
0147 FE066F00              315                     INC     DS:T0_COUNT_SET
                           316                     
                           317                     ;MOV DX, IC8255_PORTA_ADDR
                           318                     ;MOV AL, 0FFH
                           319                     ;OUT DX, AL
                           320     
014B EB0D90                321                     JMP     S_NEXT0
014E                       322     S_FAST:
014E 3C3E                  323                     CMP     AL,'>'
0150 7522                  324                     JNE     S_RET
                           325     
0152 FE0E6F00              326                     DEC     DS:T0_COUNT_SET
0156 FE0E6F00              327                     DEC     DS:T0_COUNT_SET
                           328     
015A                       329     S_NEXT0:
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    8


LOC  OBJ                  LINE     SOURCE

015A B91600                330                     MOV     CX,22                   ;initialize counter for message
015D BB0000                331                     MOV     BX,0
                           332     
0160 8A878B00              333     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
0164 9A0000----     E      334                     call    FAR ptr print_char
0169 43                    335                     INC     BX
016A E2F4                  336                     LOOP    S_NEXT1
                           337     
016C A06F00                338                     MOV     AL,DS:T0_COUNT_SET      ;print current period of timer0
016F 9A0000----     E      339                     CALL    FAR PTR PRINT_2HEX
0174                       340     S_RET:
0174 1F                    341                     POP     DS
0175 5B                    342                     POP     BX
0176 59                    343                     POP     CX
0177 CB                    344                     RET
                           345     SERIAL_REC_ACTION       ENDP
                           346     
                           347     
                           348     ;--------------------------------------------------------------
                           349     
                           350     ;--------------------TIMER 0 ----------------------------------
                           351     
0178                       352     TIMER0_ACTION   PROC    FAR
0178 50                    353                     PUSH    AX
0179 1E                    354                     PUSH    DS
017A 53                    355                     PUSH    BX
017B 51                    356                     PUSH    CX
                           357     
017C 33C0                  358             XOR AX,AX
017E 33DB                  359             XOR BX,BX
                           360     
0180 B8----         R      361             MOV     AX,DATA_SEG
0183 8ED8                  362             MOV     DS,AX
                           363             
0185 FE0E6E00              364             DEC     DS:T0_COUNT
0189 750C                  365             JNZ     T0_NEXT1
018B A06F00                366             MOV     AL,DS:T0_COUNT_SET
018E A26E00                367             MOV     DS:T0_COUNT,AL
                           368     
0191 B91400                369             MOV     CX,20
0194 BB0000                370             MOV     BX,0H
                           371     
                           372     
0197                       373     T0_NEXT1:       
0197 59                    374                     POP     CX
0198 5B                    375                     POP     BX
0199 1F                    376                     POP     DS
019A 58                    377                     POP     AX
019B CB                    378                     RET
                           379     TIMER0_ACTION   ENDP
                           380     
                           381     ;--------------------------------------------------------------
                           382     
                           383     ;--------------------TIMER 1 ----------------------------------
                           384     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE    9


LOC  OBJ                  LINE     SOURCE

                           385     
019C                       386     TIMER1_ACTION   PROC    FAR
019C 50                    387                     PUSH    AX
019D 1E                    388                     PUSH    DS
019E 53                    389                     PUSH    BX
019F 51                    390                     PUSH    CX
                           391     
01A0 B8----         R      392                     MOV     AX,DATA_SEG
01A3 8ED8                  393                     MOV     DS,AX
                           394             
01A5 FE0E7000              395                     DEC     DS:T1_COUNT
01A9 7517                  396                     JNZ     T1_NEXT1
01AB A07100                397                     MOV     AL,DS:T1_COUNT_SET
01AE A27000                398                     MOV     DS:T1_COUNT,AL
                           399     
01B1 B91400                400                     MOV     CX,20
01B4 BB0000                401                     MOV     BX,0H
01B7                       402     T1_NEXT0:
01B7 8A472C                403                     MOV     AL,DS:TIMER1_MESS[BX]
01BA 43                    404                     INC     BX
01BB 9A0000----     E      405                     CALL    FAR PTR PRINT_CHAR
01C0 E2F5                  406                     LOOP    T1_NEXT0
                           407     
01C2                       408     T1_NEXT1:       
01C2 59                    409                     POP     CX
01C3 5B                    410                     POP     BX
01C4 1F                    411                     POP     DS
01C5 58                    412                     POP     AX
01C6 CB                    413                     RET
                           414     TIMER1_ACTION   ENDP
                           415     
                           416     ;--------------------------------------------------------------
                           417     
                           418     ;--------------------TIMER 2 ----------------------------------
                           419     
                           420     
01C7                       421     TIMER2_ACTION   PROC    FAR
01C7 50                    422                     PUSH    AX
01C8 1E                    423                     PUSH    DS
01C9 53                    424                     PUSH    BX
01CA 51                    425                     PUSH    CX
                           426     
                           427     
                           428     
01CB 33C0                  429                     XOR AX, AX
01CD 33DB                  430                     XOR BX, BX
                           431                     
                           432                     
                           433     ;----------------------------
                           434                     ;AD0 - AD5 PCS3 CS for 7-segment
                           435                     ;7  6  5  4  3  2  1  0
                           436                     ;x  x  A5 A4 A3 A2 A1 A0
01CF BA8001                437                     MOV DX, PCS3_ADDR
01D2 A07400                438                     MOV AL, LED_SELECT
                           439                     ;MOV AL, 00111110B
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    04:58:33  11/10/;2  PAGE   10


LOC  OBJ                  LINE     SOURCE

01D5 EE                    440                     OUT DX, AL
01D6 D0067400              441                     ROL LED_SELECT, 01H
                           442     
                           443                     ;AD0 - AD7 PCS2
                           444                     ;AD7 - DOT (MSB)
                           445                     
01DA BA0001                446                     MOV DX, PCS2_ADDR
01DD 8A1E7F00              447                     MOV BL, CURRENT_NUMBER
01E1 8A878000              448                     MOV AL, BARCODE[BX]
                           449                     ;MOV AL, 01111111B
01E5 EE                    450                     OUT DX, AL
01E6 FE067F00              451                     INC CURRENT_NUMBER
01EA 803E7F0008            452                     CMP CURRENT_NUMBER, 08H
01EF 7411                  453                     JE RESET_CURRENT
01F1 7523                  454                     JNE T2_NEXT1
                           455     ;---------------------------
01F3 FE0E7200              456                     DEC     DS:T2_COUNT
01F7 751D                  457                     JNZ     T2_NEXT1
01F9 A07300                458                     MOV     AL,DS:T2_COUNT_SET
01FC A27200                459                     MOV     DS:T2_COUNT,AL
01FF BB0000                460                     MOV     BX,0H
                           461                     
0202                       462     RESET_CURRENT:
0202 C6067F0000            463                     MOV CURRENT_NUMBER, 00H
0207 FE0E7200              464                     DEC     DS:T2_COUNT
020B 7509                  465                     JNZ     T2_NEXT1
020D A07300                466                     MOV     AL,DS:T2_COUNT_SET
0210 A27200                467                     MOV     DS:T2_COUNT,AL
0213 BB0000                468                     MOV     BX,0H
                           469     
0216                       470     T2_NEXT1:
0216 59                    471                     POP     CX
0217 5B                    472                     POP     BX
0218 1F                    473                     POP     DS
0219 58                    474                     POP AX
021A CB                    475                     RET
                           476     
                           477     TIMER2_ACTION   ENDP
                           478     
                           479     ;--------------------------------------------------------------
                           480     
----                       481     CODE_SEG        ENDS
                           482     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
