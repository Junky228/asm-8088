8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\USERS\ANGADS~1\DOWNLO~1\ASM\ASM\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; =========================================================================
                             5     
                             6     public  serial_rec_action, timer0_action, timer1_action, timer2_action
                             7     extrn   print_char:far, print_2hex:far, iodefine:far
                             8     extrn   Set_timer0:far, Set_timer1:far, Set_timer2:far, disable_timer0:far
                             9     
----                        10     STACK_SEG       SEGMENT
0000 (256                   11                     DB      256 DUP(?)
     ??
     )
0100                        12             TOS     LABEL   WORD
----                        13     STACK_SEG       ENDS
                            14     
                            15     
                            16     ;----------------------------------------------------------------
                            17     ;--------------------DATA SEGMENT--------------------------------
                            18     ;----------------------------------------------------------------
                            19     
----                        20     DATA_SEG        SEGMENT
                            21     
                            22             ;-- String messages
0000 0A                     23             MAIN_MESS   DB  10,13,'Main Loop           '
0001 0D
0002 4D61696E204C6F
     6F702020202020
     202020202020
0016 0A                     24             TIMER0_MESS     DB      10,13,'TIMER0 INTERRUPT    '
0017 0D
0018 54494D45523020
     494E5445525255
     505420202020
002C 0A                     25             TIMER1_MESS     DB      10,13,'TIMER1 INTERRUPT    '
002D 0D
002E 54494D45523120
     494E5445525255
     505420202020
0042 0A                     26             TIMER2_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0043 0D
0044 54494D45523220
     494E5445525255
     505420202020
0058 0A                     27             KEY_PRESSED DB  10,13,'KEY PRESSED         '
0059 0D
005A 4B455920505245
     53534544202020
     202020202020
                            28     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

006E 0A                     29             REC_MESS        DB  10,13,'INPUT RECEIVED      '
006F 0D
0070 494E5055542052
     45434549564544
     202020202020
                            30             
0084 0000                   31             DI_INC  DW 0000H
                            32     
                            33             ; -- Timers counters
                            34     
0086 2F                     35             T0_COUNT                DB      2FH
0087 2F                     36             T0_COUNT_SET    DB      2FH
0088 2F                     37             T1_COUNT                DB      2FH
0089 2F                     38             T1_COUNT_SET    DB      2FH
008A 2F                     39             T2_COUNT                DB      2FH
008B 2F                     40             T2_COUNT_SET    DB      2FH
                            41     
                            42             ; -- BCD and Keypad
                            43     
008C FE                     44             LED_SELECT  DB  0FEH
008D 3F                     45             NUMBERS         DB      03FH, 006H, 05BH, 04FH, 066H, 06DH, 07DH, 007H, 07FH,
                                    06FH
008E 06
008F 5B
0090 4F
0091 66
0092 6D
0093 7D
0094 07
0095 7F
0096 6F
0097 00                     46             CURRENT_NUMBER DB 00H
0098 00                     47             BARCODE         DB  00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
0099 00
009A 00
009B 00
009C 00
009D 00
009E 00
009F 00
00A0 00
00A1 00
                            48             ;BARCODE                DB  03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 03FH, 0
                                   3FH, 03FH
00A2 00                     49             BARCODE_DEC     DB      00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H, 00H
00A3 00
00A4 00
00A5 00
00A6 00
00A7 00
00A8 00
00A9 00
00AA 00
00AB 00
00AC 00                     50             BARCODE_I       DB 00H
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

  0006                      51             BARCODE_LEN             EQU 6
00AD (6                     52             BARCODE_BUFFER  DB BARCODE_LEN DUP(?)
     ??
     )
  0000                      53             BARCODE_TAIL    EQU 0
                            54             ;BARCODE_TAIL   EQU 0
                            55     
                            56     
                            57             ;-- TODO: Add BCD Mappings
00B3 7F                     58             ENTER_BARCODE DB        07FH, 07FH, 07FH, 07FH, 07FH, 07FH
00B4 7F
00B5 7F
00B6 7F
00B7 7F
00B8 7F
00B9 6F                     59             ENTER_QUANTITY  DB      06FH, 06FH, 06FH, 06FH, 06FH, 06FH 
00BA 6F
00BB 6F
00BC 6F
00BD 6F
00BE 6F
                            60             
                            61             
00BF 00                     62             KEYPAD_CURRENT_ROW DB 00H
00C0 FE                     63             KEYPAD_ROW      DB 0FEH; 
00C1 FC                     64             KEYPAD1_HASH            DB      0FCH, 0F3H, 0F5H, 0F6H, 0FBH, 0F9H, 0FAH, 0F9
                                   H, 0FDH, 0FCH, 0FAH
00C2 F3
00C3 F5
00C4 F6
00C5 FB
00C6 F9
00C7 FA
00C8 F9
00C9 FD
00CA FC
00CB FA
00CC EE                     65             KEYPAD2_HASH    DB      0EEH, 0D7H, 0E7H, 0F7H, 0DBH, 0EBH, 0F3H, 0DDH, 0EDH,
                                    0F5H, 0DEH
00CD D7
00CE E7
00CF F7
00D0 DB
00D1 EB
00D2 F3
00D3 DD
00D4 ED
00D5 F5
00D6 DE
                            66     
                            67             ; -- Voice
                            68     
00D7 E703                   69             DESIRED_SOUND DW 999
00D9 00000000               70             SOUND_ADDR                      DD      0
00DD 0000                   71             SOUND_LEFT                      DW      0
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

00DF 00000000               72             SOUND_BASE_ADDR         DD      0, 4713, 8481, 11945, 15315, 18317, 21614, 26
                                   120, 30013, 31809
00E3 69120000
00E7 21210000
00EB A92E0000
00EF D33B0000
00F3 8D470000
00F7 6E540000
00FB 08660000
00FF 3D750000
0103 417C0000
0107 0B8D0000               73                                                     DD      36107, 39110, 43768, 47646, 5
                                   1847, 56124, 60775, 66907, 73225
010B C6980000
010F F8AA0000
0113 1EBA0000
0117 87CA0000
011B 3CDB0000
011F 67ED0000
0123 5B050100
0127 091E0100
012B B8320100               74                                                     DD      78520, 84565, 87674, 90326, 9
                                   3756, 96907, 101370, 106075, 109155
012F 554A0100
0133 7A560100
0137 D6600100
013B 3C6E0100
013F 8B7A0100
0143 FA8B0100
0147 5B9E0100
014B 63AA0100
014F D6B80100               75                                                     DD      112854, 115703, 118631, 12186
                                   7, 126347, 129602, 133161, 134469
0153 F7C30100
0157 67CF0100
015B 0BDC0100
015F 8BED0100
0163 42FA0100
0167 29080200
016B 450D0200
016F 87180200               76                                                     DD      137351, 141625, 146695, 15250
                                   3, 159103, 162214, 166331, 170638
0173 39290200
0177 073D0200
017B B7530200
017F 7F6D0200
0183 A6790200
0187 BB890200
018B 8E9A0200
018F 99AE0200               77                                                     DD      175769, 178219, 181435, 18339
                                   1, 187071, 191560, 196299, 198222
0193 2BB80200
0197 BBC40200
019B 5FCC0200
019F BFDA0200
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

01A3 48EC0200
01A7 CBFE0200
01AB 4E060300
01AF 81120300               78                                                     DD      201345, 205826, 210477, 21377
                                   0, 216003, 219454, 225267, 229879
01B3 02240300
01B7 2D360300
01BB 0A430300
01BF C34B0300
01C3 3E590300
01C7 F36F0300
01CB F7810300
01CF 98950300               79                                                     DD      234904, 242475, 249711, 25986
                                   2, 260667
01D3 2BB30300
01D7 6FCF0300
01DB 16F70300
01DF 3BFA0300
01E3 6912                   80             SOUND_SIZE                      DW      4713, 3768, 3464, 3370, 3002, 3297, 4
                                   506, 3893, 1796, 4298
01E5 B80E
01E7 880D
01E9 2A0D
01EB BA0B
01ED E10C
01EF 9A11
01F1 350F
01F3 0407
01F5 CA10
01F7 BB0B                   81                                                     DW      3003, 4658, 3878, 4201, 4277,
                                    4651, 6132, 6318, 5295, 6045
01F9 3212
01FB 260F
01FD 6910
01FF B510
0201 2B12
0203 F417
0205 AE18
0207 AF14
0209 9D17
020B 250C                   82                                                     DW      3109, 2652, 3430, 3151, 4463,
                                    4705, 3080, 3699, 2849, 2928
020D 5C0A
020F 660D
0211 4F0C
0213 6F11
0215 6112
0217 080C
0219 730E
021B 210B
021D 700B
021F A40C                   83                                                     DW      3236, 4480, 3255, 3559, 1308,
                                    2882, 4274, 5070, 5808, 6600
0221 8011
0223 B70C
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    6


LOC  OBJ                  LINE     SOURCE

0225 E70D
0227 1C05
0229 420B
022B B210
022D CE13
022F B016
0231 C819
0233 270C                   84                                                     DW      3111, 4117, 4307, 5131, 2450,
                                    3216, 1956, 3680, 4489, 4739
0235 1510
0237 D310
0239 0B14
023B 9209
023D 900C
023F A407
0241 600E
0243 8911
0245 8312
0247 8307                   85                                                     DW      1923, 3123, 4481, 4651, 3293,
                                    2233, 3451, 5813, 4612, 5025
0249 330C
024B 8111
024D 2B12
024F DD0C
0251 B908
0253 7B0D
0255 B516
0257 0412
0259 A113
025B 931D                   86                                                     DW      7571, 7236, 10151, 805, 800
025D 441C
025F A727
0261 2503
0263 2003
  0000                      87             SOUND_INIT                      EQU 0
  001C                      88             SOUND_HUNDRED           EQU     28
  001D                      89             SOUND_THOUSAND          EQU     29
  001E                      90             SOUND_PRODUCT           EQU     30
  0032                      91             SOUND_AND                       EQU     50
  0034                      92             SOUND_COST                      EQU     52
  0035                      93             SOUND_DOLLAR            EQU     53
  0036                      94             SOUND_CENT                      EQU     54
  0037                      95             SOUND_GREETING          EQU     55
  0038                      96             SOUND_MORNING           EQU     56
  0039                      97             SOUND_AFTERNOON         EQU     57
  003A                      98             SOUND_EVENING           EQU     58
  003B                      99             SOUND_PAY                       EQU     59
  003C                     100             SOUND_PURCHASE          EQU     60
  003D                     101             SOUND_CHANGE            EQU     61
  003E                     102             SOUND_EXIT                      EQU     62
  003F                     103             SOUND_BEEP                      EQU     63
  0040                     104             SOUND_SILENCE           EQU     64
  0020                     105             SOUND_QUEUE_LEN         EQU     32
0265 (32                   106             SOUND_QUEUE                     DB      SOUND_QUEUE_LEN DUP(?)
     ??
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    7


LOC  OBJ                  LINE     SOURCE

     )
0285 00                    107             SOUND_HEAD                      DB      0
0286 00                    108             SOUND_TAIL                      DB      0
0287 00                    109             SOUND_TEST_LEFT         DB      0
                           110             
                           111     
----                       112     DATA_SEG        ENDS
                           113     
                           114     ;----------------------------------------------------------------
                           115     ;--------------------DATA SEGMENT END----------------------------
                           116     ;----------------------------------------------------------------
                           117     
                           118     
                           119     ;----------------------------------------------------------------
                           120     ;--------------------CHIP SELECTS--------------------------------
                           121     ;----------------------------------------------------------------
                           122     ; 8255 register addresses
                           123     ; PCS1
  0080                     124     IC8255_PORTA_ADDR EQU 80H;
  0081                     125     IC8255_PORTB_ADDR EQU 81H;
  0082                     126     IC8255_PORTC_ADDR EQU 82H;
  0083                     127     IC8255_CW_ADDR    EQU 83H;
                           128     
  0100                     129     PCS2_ADDR EQU 100H
  0180                     130     PCS3_ADDR EQU 180H
  0200                     131     PCS4_ADDR EQU 200H
                           132     
  FFA6                     133     MMCS EQU 0FFA6H
  FFA8                     134     MPCS EQU 0FFA8H
                           135     
                           136     ;----------------------------------------------------------------
                           137     ;-------------------CHIP SELECT END------------------------------
                           138     ;----------------------------------------------------------------
                           139     
                           140     
                           141     ;----------------------------------------------------------------
                           142     ;--------------------CODE SEGMENT--------------------------------
                           143     ;----------------------------------------------------------------
                           144     
----                       145     CODE_SEG        SEGMENT
                           146             PUBLIC          START
                           147     ASSUME          CS:CODE_SEG, SS:STACK_SEG, DS:DATA_SEG
                           148     
0000                       149     START:
                           150     
                           151     ;-----------------------STACK AREA INIT--------------------------
0000 B8----         R      152             MOV     AX, STACK_SEG           
0003 8ED0                  153             MOV     SS, AX
0005 368B260001            154             MOV     SP, TOS
                           155     
000A B8----         R      156             MOV AX, DATA_SEG
000D 8ED8                  157             MOV DS, AX
                           158     ;----------------------------------------------------------------
                           159     
                           160     ;--------------ON-CHIP PERIPEHRALS--------------------------------
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    8


LOC  OBJ                  LINE     SOURCE

000F 9A0000----     E      161             CALL    FAR PTR IODEFINE
                           162             
                           163             ;IC8255 - Control Word
0014 BA8300                164             MOV DX, IC8255_CW_ADDR
                           165     
                           166             ;CW Register 
                           167             ;Port C Lower Input, Port C Upper Output 
                           168             ;Port B input, Port A output
                           169             ;1 0 0 0 0 0 1 0
0017 B082                  170             MOV AL, 82H
0019 EE                    171             OUT DX, AL
                           172     
                           173     ; Initialize MCS
                           174     
001A BAA6FF                175             MOV DX, MMCS
001D B80380                176             MOV     AX, 8003H
0020 EF                    177             OUT     DX, AX
                           178     
0021 BAA8FF                179             MOV DX, MPCS
0024 B88440                180             MOV AX, 4084H
0027 EF                    181             OUT DX, AX
                           182     
                           183     ;----------------------------------------------------------------
                           184     
                           185     ;This procedure generates 10ms delay at 5MHz
                           186     ;operating frequency, which corresponds to 
                           187     ;50,000 clock cycles.
                           188     ;DEBOUNCE PROC  NEAR
                           189     ;       PUSH    CX
                           190     ;       MOV CX, 094Ch ; 2380 dec
                           191     ;       BACK:           
                           192     ;               NOP       ; 3 clocks
                           193     ;       LOOP BACK; 18 clocks
                           194     ;       POP CX
                           195     ;       RET
                           196     ;DEBOUNCE ENDP
                           197     
                           198     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                           199     
                           200     ;------------------------Setting the timers---------------------
                           201         ;call Set_timer0
                           202             ;call Set_timer1
0028 9A0000----     E      203             call Set_timer2
002D FB                    204           STI
                           205     ;---------------------------------------------------------------
                           206     
002E                       207     NEXT:
                           208     ;----------------------------------------------------------------
                           209     ;--------------------MAIN LOOP INIT------------------------------
                           210     ;----------------------------------------------------------------
                           211     
                           212             ;slowing down the main loop
002E B9FF5F                213             MOV CX, 05FFFH ; 2380 dec
0031                       214             SLEEP:
0031 90                    215                     NOP
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE    9


LOC  OBJ                  LINE     SOURCE

0032 E2FD                  216             LOOP SLEEP; 18 clocks
                           217     
                           218     ;----------------------------------------------------------------
                           219     ;--------------------START KEYPAD----------------------------------
                           220     ;----------------------------------------------------------------
0034 33C0                  221             XOR AX, AX
0036 D006C000              222             ROL KEYPAD_ROW, 01H
003A 803EC00077            223             CMP KEYPAD_ROW, 77H
003F 7402                  224             JE RESET_KEYPAD_ROW
0041 7505                  225             JNZ CHECK_KEYPAD_ROW
                           226     
0043                       227     RESET_KEYPAD_ROW:
0043 C606C0000E            228             MOV KEYPAD_ROW, 0EH
                           229     
0048                       230     CHECK_KEYPAD_ROW:
0048 A0C000                231             MOV AL, KEYPAD_ROW
004B BA8200                232             MOV DX, IC8255_PORTC_ADDR       ;DX = Port B Address
004E EE                    233             OUT DX, AL                                      ;
004F BA8100                234             MOV DX, IC8255_PORTB_ADDR       ;
                           235     
0052                       236     CHECK_KEY_CLOSED:                               ;Check when key is pressed. Keep loop
                                   ing here
0052 EC                    237             IN AL, DX                                       ;Move to AL, value in Port B.
                                    
                           238             
                           239             ;--TODO: Get rid of these compares
0053 3C00                  240             CMP AL, 00H
0055 74D7                  241             JE NEXT
0057 3C3F                  242             CMP AL, 03FH
0059 74D3                  243             JE NEXT
005B 3CFF                  244             CMP AL, 0FFH
005D 74CF                  245             JE NEXT
005F 3CBF                  246             CMP AL, 0BFH
0061 74CB                  247             JE NEXT
0063 3C7F                  248             CMP AL, 07FH
0065 74C7                  249             JE NEXT
0067 3C0F                  250             CMP AL, 0FH
0069 74C3                  251             JE NEXT
006B 3C08                  252             CMP AL, 08H
006D 74BF                  253             JE NEXT
                           254     
                           255             ;ANGAD'S SMARTASS HASHING ALGO
006F 2206C000              256             AND AL, KEYPAD_ROW
0073 8A26C000              257             MOV AH, KEYPAD_ROW
                           258     
0077 E80200                259             CALL NEAR PTR KEYPAD_PROCESS
                           260     
                           261     
                           262     ;----------------------------------------------------------------
                           263     ;--------------------END KEYPAD----------------------------------
                           264     ;----------------------------------------------------------------
007A EBB2                  265     JMP NEXT
                           266     
                           267     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
007C                       268     KEYPAD_PROCESS PROC NEAR
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   10


LOC  OBJ                  LINE     SOURCE

007C 50                    269             PUSH AX
007D 53                    270             PUSH BX
007E 52                    271             PUSH DX
007F 1E                    272             PUSH DS
                           273     
0080 BA----         R      274             MOV     DX, DATA_SEG
0083 8EDA                  275             MOV     DS, DX
                           276     
                           277             ;-------Keypad 1------------
                           278     
0085 B90A00                279             MOV CX, 10
0088                       280             FIND_KEY:
0088 8BD9                  281                     MOV BX, CX
008A 8AA7C100              282                     MOV AH, KEYPAD1_HASH[BX]
008E 3AE0                  283                     CMP AH, AL
0090 7404                  284                     JE RESOLVE_COLLISION
0092 E2F4                  285             LOOP FIND_KEY
                           286     
0094 7569                  287             JNE KEYPAD2
                           288     
0096                       289             RESOLVE_COLLISION:
0096 A0C000                290                     MOV AL, KEYPAD_ROW
                           291     
                           292                     ;PUSH AX
                           293                     ;CALL FAR PTR PRINT_2HEX
                           294                     ;MOV AL, 0AH ;NEW LINE
                           295                     ;CALL   FAR PTR PRINT_CHAR
                           296                     ;MOV AL, 0DH ;CARRIAGE RETURN
                           297                     ;CALL   FAR PTR PRINT_CHAR
                           298                     ;POP AX
                           299     
0099 83F90A                300                     CMP CX, 10
009C 742A                  301                     JE COLLISION_6_STAR
009E 83F907                302                     CMP CX, 7
00A1 742E                  303                     JE COLLISION_7_5
00A3 83F909                304                     CMP CX, 9
00A6 7432                  305                     JE COLLISION_9_0
                           306     
00A8                       307             ADD_BARCODE:
00A8 8BD9                  308                     MOV BX, CX
00AA 8A878D00              309                     MOV AL, NUMBERS[BX]
00AE 8BCB                  310                     MOV CX, BX
00B0 8A1EAC00              311                     MOV BL, BARCODE_I
00B4 88879800              312                     MOV BARCODE[BX], AL
00B8 888FA200              313                     MOV BARCODE_DEC[BX], CL
00BC FE06AC00              314                     INC BARCODE_I
00C0 B03F                  315                     MOV AL, SOUND_BEEP
00C2 E8FF00                316                     CALL VOICE_ON_QUEUE
00C5 E9CE00                317                     JMP KEYPAD_EXIT
                           318     
00C8                       319             COLLISION_6_STAR:
00C8 3CFE                  320                     CMP AL, 0FEH
00CA 7417                  321                     JE CLEAR
00CC B90600                322                     MOV CX, 6
00CF EBD7                  323                     JMP ADD_BARCODE
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   11


LOC  OBJ                  LINE     SOURCE

                           324     
00D1                       325             COLLISION_7_5:
00D1 3CFB                  326                     CMP AL, 0FBH
00D3 75D3                  327                     JNE ADD_BARCODE
00D5 B90500                328                     MOV CX, 5
00D8 EBCE                  329                     JMP ADD_BARCODE
                           330     
00DA                       331             COLLISION_9_0:
00DA 3CFE                  332                     CMP AL, 0FEH
00DC 75CA                  333                     JNE ADD_BARCODE
00DE B90000                334                     MOV CX, 0
00E1 EBC5                  335                     JMP ADD_BARCODE
                           336     
00E3                       337             CLEAR:
00E3 33DB                  338                     XOR BX, BX
00E5 B90800                339                     MOV CX, 08H
00E8                       340                     CLEAR_BARCODE:
00E8 8BD9                  341                             MOV BX, CX
00EA 4B                    342                             DEC BX
00EB C687980000            343                             MOV BARCODE[BX], 00H
00F0 C687A20000            344                             MOV BARCODE_DEC[BX], 00H
00F5 E2F1                  345                     LOOP CLEAR_BARCODE
00F7 C606AC0000            346                     MOV BARCODE_I, 00H
00FC E99700                347                     JMP KEYPAD_EXIT
                           348     
00FF                       349             KEYPAD2:
00FF B90A00                350                     MOV CX, 10
0102                       351                     FIND_KEY2:
0102 8BD9                  352                             MOV BX, CX
0104 8AA7CC00              353                             MOV AH, KEYPAD2_HASH[BX]
0108 3AE0                  354                             CMP AH, AL
010A 7402                  355                             JE PROCESS_COMMAND
010C E2F4                  356                     LOOP FIND_KEY2
                           357     
010E                       358                     PROCESS_COMMAND:
010E 83F901                359                             CMP CX, 1
0111 740D                  360                             JE NEW_TRANSACTION
0113 83F902                361                             CMP CX, 2
0116 7423                  362                             JE NEW_ITEM
0118 83F90A                363                             CMP CX, 10
011B 7442                  364                             JE SEND_BARCODE
011D EB7790                365                             JMP KEYPAD_EXIT
                           366                     
0120                       367                     NEW_TRANSACTION:
0120 B04F                  368                             MOV AL, 'O'
0122 9A0000----     E      369                             CALL FAR PTR PRINT_CHAR
0127 B050                  370                             MOV AL, 'P'
0129 9A0000----     E      371                             CALL FAR PTR PRINT_CHAR
                           372     
012E B037                  373                             MOV AL, SOUND_GREETING
0130 E89100                374                             CALL NEAR PTR VOICE_ON_QUEUE
0133 B039                  375                             MOV AL, SOUND_AFTERNOON
0135 E88C00                376                             CALL NEAR PTR VOICE_ON_QUEUE
0138 EB5C90                377                             JMP KEYPAD_EXIT
                           378     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   12


LOC  OBJ                  LINE     SOURCE

013B                       379                     NEW_ITEM:
013B B049                  380                             MOV AL, 'I'
013D 9A0000----     E      381                             CALL FAR PTR PRINT_CHAR
0142 B054                  382                             MOV AL, 'T'
0144 9A0000----     E      383                             CALL FAR PTR PRINT_CHAR
0149 B90600                384                             MOV CX, 6
014C                       385                             FILL_BCD_BARCODE_PROMPT:
014C BB0600                386                                     MOV BX, 6
014F 83EB06                387                                     SUB BX, 6
0152 8A87B300              388                                     MOV AL, ENTER_BARCODE[BX]
0156 88879800              389                                     MOV BARCODE[BX], AL
015A E2F0                  390                             LOOP FILL_BCD_BARCODE_PROMPT
015C EB3890                391                             JMP KEYPAD_EXIT
                           392     
015F                       393                     SEND_BARCODE:
015F B042                  394                             MOV AL, 'B'
0161 9A0000----     E      395                             CALL FAR PTR PRINT_CHAR
0166 B041                  396                             MOV AL, 'A'
0168 9A0000----     E      397                             CALL FAR PTR PRINT_CHAR
016D B05B                  398                             MOV AL, '['
016F 9A0000----     E      399                             CALL FAR PTR PRINT_CHAR
0174 B90600                400                             MOV CX, 6
0177                       401                             SEND_BARCODE_LOOP:
0177 BB0600                402                                     MOV BX, 6
017A 2BD9                  403                                     SUB BX, CX
017C 8A87A200              404                                     MOV AL, BARCODE_DEC[BX]
0180 0430                  405                                     ADD AL, 48
0182 9A0000----     E      406                                     CALL FAR PTR PRINT_CHAR
0187 E2EE                  407                             LOOP SEND_BARCODE_LOOP
0189 B05D                  408                             MOV AL, ']'
018B 9A0000----     E      409                             CALL FAR PTR PRINT_CHAR
0190 E950FF                410                             JMP CLEAR
0193 EB0190                411                             JMP KEYPAD_EXIT
                           412     
0196                       413     KEYPAD_EXIT:
0196 1F                    414             POP     DS
0197 5A                    415             POP DX
0198 5B                    416             POP BX
0199 58                    417             POP AX
                           418     
019A C3                    419             RET
                           420     KEYPAD_PROCESS ENDP
                           421     
                           422     
019B                       423     TRANSACTION PROC NEAR
019B 50                    424             PUSH AX
019C 53                    425             PUSH BX
019D 51                    426             PUSH CX
019E 52                    427             PUSH DX
                           428     
019F B037                  429             MOV AL, SOUND_GREETING
01A1 E82000                430             CALL VOICE_ON_QUEUE
01A4 B039                  431             MOV AL, SOUND_AFTERNOON
01A6 E81B00                432             CALL VOICE_ON_QUEUE
                           433     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   13


LOC  OBJ                  LINE     SOURCE

01A9 5A                    434             POP DX
01AA 59                    435             POP CX
01AB 5B                    436             POP BX
01AC 58                    437             POP AX
01AD C3                    438             RET
                           439     TRANSACTION ENDP
                           440     
01AE                       441     ITEM PROC NEAR
01AE 50                    442             PUSH AX
01AF 53                    443             PUSH BX
01B0 51                    444             PUSH CX
01B1 52                    445             PUSH DX
                           446     
01B2 BA----         R      447             MOV     DX, DATA_SEG
01B5 8EDA                  448             MOV     DS, DX
                           449     
01B7 5A                    450             POP DX
01B8 59                    451             POP CX
01B9 5B                    452             POP BX
01BA 58                    453             POP AX
01BB C3                    454             RET
                           455     ITEM ENDP
                           456     
                           457     
01BC                       458     QTY PROC NEAR
01BC 50                    459             PUSH AX
01BD 53                    460             PUSH BX
01BE 51                    461             PUSH CX
01BF 52                    462             PUSH DX
                           463     
01C0 5A                    464             POP DX
01C1 59                    465             POP CX
01C2 5B                    466             POP BX
01C3 58                    467             POP AX
                           468     QTY ENDP
                           469     
                           470     ;------------------VOICE-------------------------
01C4                       471     VOICE_ON_QUEUE PROC NEAR
01C4 50                    472             PUSH AX
01C5 53                    473             PUSH BX
01C6 52                    474             PUSH DX
01C7 1E                    475             PUSH DS
                           476             
01C8 BA----         R      477             MOV     DX, DATA_SEG
01CB 8EDA                  478             MOV     DS, DX
                           479     
01CD B700                  480             MOV BH, 0
01CF 8A1E8502              481             MOV BL, BYTE PTR SOUND_HEAD
01D3 88876502              482             MOV BYTE PTR SOUND_QUEUE[BX], AL
01D7 FEC3                  483             INC BL
                           484     
01D9 80FB20                485             CMP BL, SOUND_QUEUE_LEN
01DC 7502                  486             JNE VOICE_ON_QUEUE_STALL
                           487             
01DE B300                  488             MOV BL, 0
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   14


LOC  OBJ                  LINE     SOURCE

                           489             
01E0                       490     VOICE_ON_QUEUE_STALL:
                           491                     
01E0 881E8502              492             MOV BYTE PTR SOUND_HEAD, BL
01E4 9A0000----     E      493             CALL    FAR PTR Set_timer0
                           494             
01E9 1F                    495             POP     DS
01EA 5A                    496             POP DX
01EB 5B                    497             POP BX
01EC 58                    498             POP AX
                           499             
01ED C3                    500             RET
                           501     VOICE_ON_QUEUE ENDP
                           502     
                           503     
01EE                       504     SERIAL_REC_ACTION       PROC    FAR
01EE 51                    505                     PUSH    CX
01EF 53                    506                     PUSH    BX
01F0 1E                    507                     PUSH    DS
                           508     
01F1 BB----         R      509                     MOV     BX,DATA_SEG             ;initialize data segment register
01F4 8EDB                  510                     MOV     DS,BX
                           511     
01F6 3C61                  512                     CMP     AL,'a'
01F8 750B                  513                     JNE     S_FAST
                           514     
01FA FE068700              515                     INC     DS:T0_COUNT_SET
01FE FE068700              516                     INC     DS:T0_COUNT_SET
                           517                     
                           518                     ;MOV DX, IC8255_PORTA_ADDR
                           519                     ;MOV AL, 0FFH
                           520                     ;OUT DX, AL
                           521     
0202 EB0D90                522                     JMP     S_NEXT0
0205                       523     S_FAST:
0205 3C01                  524                     CMP     AL,01H
0207 751E                  525                     JNE     S_RET
                           526     
0209 FE0E8700              527                     DEC     DS:T0_COUNT_SET
020D FE0E8700              528                     DEC     DS:T0_COUNT_SET
                           529     
0211                       530     S_NEXT0:
0211 B90F00                531                     MOV     CX,15                   ;initialize counter for message
0214 BB0000                532                     MOV     BX,0
                           533     
0217                       534     S_NEXT1:        
0217 8A476E                535                     MOV     AL,DS:REC_MESS[BX]      ;print message
021A 9A0000----     E      536                     call    FAR ptr print_char
021F 43                    537                     INC     BX
0220 E2F5                  538                     LOOP    S_NEXT1
0222 B037                  539                     MOV AL, SOUND_GREETING
0224 E89DFF                540                     CALL NEAR PTR VOICE_ON_QUEUE
                           541     
0227                       542     S_RET:
0227 1F                    543                     POP     DS
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   15


LOC  OBJ                  LINE     SOURCE

0228 5B                    544                     POP     BX
0229 59                    545                     POP     CX
022A CB                    546                     RET
                           547     SERIAL_REC_ACTION       ENDP
                           548     
                           549     
                           550     ;--------------------------------------------------------------
                           551     
                           552     ;--------------------TIMER 0 ----------------------------------
                           553     
022B                       554     TIMER0_ACTION   PROC    FAR
022B 50                    555                     PUSH    AX
022C 1E                    556                     PUSH    DS
022D 53                    557                     PUSH    BX
022E 51                    558                     PUSH    CX
                           559     
022F 33C0                  560             XOR AX,AX
0231 33DB                  561             XOR BX,BX
0233 33C9                  562             XOR CX,CX
0235 33D2                  563             XOR DX,DX
                           564     
0237 B8----         R      565             MOV     AX,DATA_SEG
023A 8ED8                  566             MOV     DS,AX
                           567             
                           568             ;slowing down the timer 
                           569             ;MOV CX, 04FFFH ; 2380 dec
                           570             ;SLEEP_TIMER:
                           571             ;       NOP
                           572             ;LOOP SLEEP_TIMER; 18 clocks
                           573     
                           574     ;----------------------------------------------------
                           575             ; SOUND_LEFT: Number of bytes left in the queue
023C 833EDD0000            576             CMP WORD PTR SOUND_LEFT, 0
0241 7544                  577             JNE timer0_ACTION_PROCEED
                           578             
                           579             ; Reload with next item in the queue
0243 B700                  580             MOV BH, 0
0245 8A1E8602              581             MOV BL, BYTE PTR SOUND_TAIL
                           582             
0249 381E8502              583             CMP BYTE PTR SOUND_HEAD, BL
024D 7508                  584             JNE timer0_ACTION_RELOAD
                           585             
                           586             ;disable timer 0, freeing up resources
024F 9A0000----     E      587             call disable_timer0
                           588      
0254 EB6690                589             JMP T0_NEXT1
                           590             
0257                       591     timer0_ACTION_RELOAD:
                           592             
0257 8A9F6502              593             MOV BL, BYTE PTR SOUND_QUEUE[BX]
025B BEDF00                594             MOV SI, OFFSET SOUND_BASE_ADDR
                           595                     
025E C1E302                596             SHL BX, 2
0261 8B00                  597             MOV AX, WORD PTR [BX][SI]
                           598      
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   16


LOC  OBJ                  LINE     SOURCE

0263 A3D900                599             MOV WORD PTR SOUND_ADDR[0], AX
                           600             
0266 8B4002                601             MOV AX, WORD PTR 2[BX][SI]      
0269 A3DB00                602             MOV WORD PTR SOUND_ADDR[2], AX
                           603             
026C D1EB                  604             SHR BX, 1
026E BEE301                605             MOV SI, OFFSET SOUND_SIZE
0271 8B00                  606             MOV AX, WORD PTR [BX][SI]
0273 A3DD00                607             MOV WORD PTR SOUND_LEFT, AX
0276 A08602                608             MOV AL, BYTE PTR SOUND_TAIL
0279 FEC0                  609             INC AL
027B 3C20                  610             CMP AL, SOUND_QUEUE_LEN
027D 7502                  611             JNE timer0_QUEUE_NO_OVERFLOW
                           612             
027F B000                  613             MOV AL, 0
                           614             
0281                       615     timer0_QUEUE_NO_OVERFLOW:
                           616     
0281 A28602                617             MOV BYTE PTR SOUND_TAIL, AL
0284 EB3690                618             JMP T0_NEXT1
                           619             
0287                       620     timer0_ACTION_PROCEED:
                           621     
0287 FF0EDD00              622             DEC WORD PTR SOUND_LEFT
                           623             
028B 8B36D900              624             MOV SI, WORD PTR SOUND_ADDR[0]
028F 8B3EDB00              625             MOV DI, WORD PTR SOUND_ADDR[2]
                           626     
                           627             ; SI - Intra-segment address, DI - Segment address
0293 83C708                628             ADD DI, 8H
0296 C1E70C                629             SHL DI, 12
                           630     
                           631             ; Set extra segment to point to 8000H, the starting segment of the EEPROM
0299 8EDF                  632             MOV DS, DI
                           633              
                           634             ; Get byte from EEPROM address space
029B 8A04                  635             MOV AL, [SI]
                           636             
                           637             ; Put byte to DAC
029D BA0002                638             MOV DX, PCS4_ADDR
02A0 EE                    639             OUT DX, AL
                           640             
                           641             ; Increment EEPROM address to move to the next sample
02A1 B8----         R      642             MOV AX, DATA_SEG
02A4 8ED8                  643             MOV DS, AX
                           644     
02A6 FF06D900              645             INC WORD PTR SOUND_ADDR[0]
02AA 7510                  646             JNZ T0_NEXT1
                           647     
                           648             ; Increment memory segment
02AC FF06DB00              649             INC WORD PTR SOUND_ADDR[2]
                           650     
                           651     ;---------------------------------------------
                           652     
                           653     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   17


LOC  OBJ                  LINE     SOURCE

02B0 FE0E8600              654             DEC     DS:T0_COUNT
02B4 7506                  655             JNZ     T0_NEXT1
02B6 A08700                656             MOV     AL,DS:T0_COUNT_SET
02B9 A28600                657             MOV     DS:T0_COUNT,AL
                           658     
02BC                       659     T0_NEXT1:
                           660     ;T0_NEXT1:
02BC 59                    661             POP     CX
02BD 5B                    662             POP     BX
02BE 1F                    663             POP     DS
02BF 58                    664             POP AX
02C0 CB                    665             RET
                           666     TIMER0_ACTION   ENDP
                           667     
                           668     ;--------------------------------------------------------------
                           669     
                           670     ;--------------------TIMER 1 ----------------------------------
                           671     
02C1                       672     TIMER1_ACTION   PROC    FAR
02C1 50                    673                     PUSH    AX
02C2 1E                    674                     PUSH    DS
02C3 53                    675                     PUSH    BX
02C4 51                    676                     PUSH    CX
                           677     
02C5 B8----         R      678                     MOV     AX,DATA_SEG
02C8 8ED8                  679                     MOV     DS,AX
                           680             
02CA FE0E8800              681                     DEC     DS:T1_COUNT
02CE 7517                  682                     JNZ     T1_NEXT1
02D0 A08900                683                     MOV     AL,DS:T1_COUNT_SET
02D3 A28800                684                     MOV     DS:T1_COUNT,AL
                           685     
02D6 B91400                686                     MOV     CX,20
02D9 BB0000                687                     MOV     BX,0H
02DC                       688     T1_NEXT0:
02DC 8A472C                689                     MOV     AL,DS:TIMER1_MESS[BX]
02DF 43                    690                     INC     BX
02E0 9A0000----     E      691                     CALL    FAR PTR PRINT_CHAR
02E5 E2F5                  692                     LOOP    T1_NEXT0
                           693     
02E7                       694     T1_NEXT1:       
02E7 59                    695                     POP     CX
02E8 5B                    696                     POP     BX
02E9 1F                    697                     POP     DS
02EA 58                    698                     POP     AX
02EB CB                    699                     RET
                           700     TIMER1_ACTION   ENDP
                           701     
                           702     ;--------------------------------------------------------------
                           703     
                           704     ;--------------------TIMER 2 ----------------------------------
                           705     
                           706     
02EC                       707     TIMER2_ACTION   PROC    FAR
02EC 50                    708                     PUSH    AX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   18


LOC  OBJ                  LINE     SOURCE

02ED 1E                    709                     PUSH    DS
02EE 53                    710                     PUSH    BX
02EF 51                    711                     PUSH    CX
                           712     
02F0 33C0                  713                     XOR AX, AX
02F2 33DB                  714                     XOR BX, BX
                           715                     
                           716                     
                           717     ;----------------------------
                           718                     ;AD0 - AD5 PCS3 CS for 7-segment
                           719                     ;7  6  5  4  3  2  1  0
                           720                     ;x  x  A5 A4 A3 A2 A1 A0
02F4 BA8001                721                     MOV DX, PCS3_ADDR
02F7 A08C00                722                     MOV AL, LED_SELECT
                           723                     ;MOV AL, 00111110B
02FA EE                    724                     OUT DX, AL
02FB D0068C00              725                     ROL LED_SELECT, 01H
                           726     
                           727                     ;AD0 - AD7 PCS2
                           728                     ;AD7 - DOT (MSB)
                           729                     
02FF BA0001                730                     MOV DX, PCS2_ADDR
0302 8A1E9700              731                     MOV BL, CURRENT_NUMBER
0306 8A879800              732                     MOV AL, BARCODE[BX]
                           733                     ;MOV AL, 01111111B
030A EE                    734                     OUT DX, AL
030B FE069700              735                     INC CURRENT_NUMBER
030F 803E970008            736                     CMP CURRENT_NUMBER, 08H
0314 7411                  737                     JE RESET_CURRENT
0316 7523                  738                     JNE T2_NEXT1
                           739     ;---------------------------
0318 FE0E8A00              740                     DEC     DS:T2_COUNT
031C 751D                  741                     JNZ     T2_NEXT1
031E A08B00                742                     MOV     AL,DS:T2_COUNT_SET
0321 A28A00                743                     MOV     DS:T2_COUNT,AL
0324 BB0000                744                     MOV     BX,0H
                           745                     
0327                       746     RESET_CURRENT:
0327 C606970000            747                     MOV CURRENT_NUMBER, 00H
032C FE0E8A00              748                     DEC     DS:T2_COUNT
0330 7509                  749                     JNZ     T2_NEXT1
0332 A08B00                750                     MOV     AL,DS:T2_COUNT_SET
0335 A28A00                751                     MOV     DS:T2_COUNT,AL
0338 BB0000                752                     MOV     BX,0H
                           753     
033B                       754     T2_NEXT1:
033B 59                    755                     POP     CX
033C 5B                    756                     POP     BX
033D 1F                    757                     POP     DS
033E 58                    758                     POP AX
033F CB                    759                     RET
                           760     
                           761     TIMER2_ACTION   ENDP
                           762     
                           763     ;--------------------------------------------------------------
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    23:44:21  12/02/;2  PAGE   19


LOC  OBJ                  LINE     SOURCE

                           764     
----                       765     CODE_SEG        ENDS
                           766     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
