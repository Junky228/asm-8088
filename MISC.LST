8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE MISC
OBJECT MODULE PLACED IN MISC.OBJ
ASSEMBLER INVOKED BY:  C:\USERS\ANGADS~1\DOWNLO~1\ASM\ASM\ASM86.EXE MISC.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $mod186
                             2 +1  $EP
                             3     NAME MISC
                             4     ; Interrupt and misc routines for uPD70208 microcomputer system
                             5     ;
                             6     ; Filename:     MISC.ASM
                             7     ;
                             8     ; Author:       Dr Tay Teng Tiow
                             9     ; Address:      Department of Electrical Engineering 
                            10     ;               National University of Singapore
                            11     ;               10, Kent Ridge Crescent
                            12     ;               Singapore 0511. 
                            13     ; Date:         3rd November 1991
                            14     ;
                            15     ; This file contains proprietory information and cannot be copied 
                            16     ; or distributed without prior permission from the author.
                            17     ;---------------------------------------------------------------------------
                            18     
                            19     public  print_char, print_2hex, iodefine, Set_timer0, Set_timer1, Set_timer2
                            20     extrn   serial_rec_action:far, timer0_action:far, timer1_action:far, timer2_action:fa
                                   r
                            21     
----                        22     INT_VEC_SEG     SEGMENT         AT      0H
                            23     ; Define the interrupt vector locations
                            24     ; System reserved interrupts
0000                        25                     ORG     0000H
0000 ????????               26             DIV_ZERO        DD      ?       ;not defined yet
0004 ????????               27             SINGLE_STEP     DD      ?       ;not defined yet
0008 ????????               28             NMI_INPUT       DD      ?       ;start of downloaded program
000C ????????               29             BRK_3_VEC       DD      ?       ;not defined yet
0010 ????????               30             OVERFLOW        DD      ?       ;not defined yet
0014 ????????               31             ARRAY_BND       DD      ?       ;Array Bounds
0020                        32                     ORG     020H
0020 6901----       R       33             TIMER0_VEC              DD              TIMER0_INTR ; 8 x 4 = 32
                            34          
                            35     ; Interrupt control unit
0030                        36                     ORG     030H
0030 EE00----       R       37             INTP0           DD      SERIAL_INTR
0034 ????????               38             INTP1           DD      ?       ;external, not used yet  
0038 ????????               39             INTP2           DD      ?       ;external, not used yet
003C ????????               40             INTP3           DD      ?       ;external, not used yet
0040 ????????               41         NUMERICS        DD      ?       ;
0044 ????????               42         RSVED           DD      ?       ;system reserved 
0048 7801----       R       43         TIMER1_VEC      DD      TIMER1_INTR       ;route for timer 1
004C 8701----       R       44         TIMER2_VEC      DD      TIMER2_INTR       ;Timer2 Route
                            45                ;Reserved from 050H to 080H     
0080                        46                    ORG     080H
                            47     ;Interrupt Vector addrerss from 080h (type 32) to 3fCH (type 255)
                            48     ;are avaiable for user software interrupt           
                            49     ; Software interrupts
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

0080 ????????               50             SOFT0           DD      ? ;TYPE 32
0084 ????????               51             SOFT1           DD      ? ;TYPE 33
0088 ????????               52             SOFT2           DD      ?
008C ????????               53             SOFT3           DD      ?
0090 ????????               54             SOFT4           DD      ?
0094 ????????               55             SOFT5           DD      ?
0098 ????????               56             SOFT6           DD      ?
009C ????????               57             SOFT7           DD      ?
----                        58     INT_VEC_SEG     ENDS
                            59     
                            60     
                            61     
----                        62     INT_RAM_AREA    SEGMENT
  0080                      63             QUEUE_LEN       EQU     128
                            64     
0000 (128                   65             QUEUE_TRANS     DB      QUEUE_LEN DUP(?)
     ??
     )
0080 0000                   66             QUEUE_HEAD      DW      0H
0082 0000                   67             QUEUE_TAIL      DW      0H
----                        68     INT_RAM_AREA    ENDS
                            69     
                            70     
                            71 +1  $include(80188.inc)
                      =1    72     ;IO Setup for 80C188XL 
                      =1    73     ;By Zhu Shunyu
                      =1    74     
  FFA0                =1    75              UMCR    EQU    0FFA0H ; Upper Memory Control Register
  FFA2                =1    76              LMCR    EQU    0FFA2H ; Lower Memory control Register         
  FFA4                =1    77              PCSBA   EQU    0FFA4H ; Peripheral Chip Select Base Address
  FFA8                =1    78              MPCS    EQU    0FFA8H ; MMCS and PCS Alter Control Register
                      =1    79     
                      =1    80     
                      =1    81     ; Initial 80C188XL UCS Pin
                      =1    82     ; |start address|block size| value for No waits, No Ready   
                      =1    83     ;   FE000H            8K                 3E04H
                      =1    84     ;   FC000H           16K                 3C04H
                      =1    85     ;   F8000H           32K                 3804H
                      =1    86      
                      =1    87              
                      =1    88     ; Initialize Upper Chip Select pin with 8K ROM 
                      =1    89     ;         MOV DX, UMCR
                      =1    90     ;         MOV AX, 03E04H
                      =1    91     ;         OUT DX, AX
                      =1    92     
                      =1    93     ; Initialize Lower Chip Select pin with 8k RAM
                      =1    94     ;         MOV DX, LMCR
                      =1    95     ;         MOV AX, 01C4H  ; Starting address 1FFFH, 8K, No waits, last shoud be 5H for
                                    1 waits      
                      =1    96     ;         OUT DX, AL
                      =1    97     ; Initialize MPCS to MAP peripheral to IO address
0000 BAA8FF           =1    98              MOV DX, MPCS
0003 B88300           =1    99              MOV AX, 0083H
0006 EE               =1   100              OUT DX, AL
                      =1   101     ; PCSBA initial, set the serial port start from 00H
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

0007 BAA4FF           =1   102              MOV DX, PCSBA
000A B80300           =1   103              MOV AX, 0003H ; Peripheral starting address 00H no READY, No Waits
000D EE               =1   104              OUT DX, AL
                      =1   105     
                      =1   106     ;Serial port definition and initialize 
  0000                =1   107              SRB     EQU       00H ; Serial Receiver Buffer Register (R)
  0000                =1   108              STB     EQU       00H ; Serial Transmitter Holding Register(W)  
  0001                =1   109              SIER    EQU       01H ; Serial Interrupte Enable Register (w)
  0002                =1   110              IIR     EQU       02H ; Interrupt Identification Register (R)
  0003                =1   111              SMD     EQU       03H ; Serial Line Control Register
  0005                =1   112              SST     EQU       05H ; Serial Line Status Register
  0000                =1   113              DLL     EQU       00H ; Divisor Latch Least Significant BYTE
  0001                =1   114              DLM     EQU       01H ; Divisor Latch most  Significant BYTE
                      =1   115     
                      =1   116     ;Definition of content of SST register
                      =1   117     ;|Not Use|TE|THRE|BI|FE|PE|OE|DR|
                      =1   118     ;TE Transmitter empty
                      =1   119     ;THRE Transmittor Holding Register Empty
                      =1   120     ;BI Breakr Interrupt
                      =1   121     ;FE Framing Error
                      =1   122     ;PE Parity Error
                      =1   123     ;OE Overrun Error 
                      =1   124     ;DR Data Ready
  0001                =1   125               REC_RDY    EQU   00000001B
  0020                =1   126               TRAN_RDY   EQU   00100000B
  000E                =1   127               ERR_DET    EQU   00001110B
  0010                =1   128               BREAK_DET  EQU   00010000B
                      =1   129     ; Serial Line Control Data
  0007                =1   130             SMD_DATA     EQU    00000111B
  0003                =1   131             S_INT_ENA    EQU    00000011B
  0000                =1   132             S_INT_DIS    EQU    00000000B
                      =1   133        
                      =1   134     ;1st bit set 1 to access the Divisor latch 
                      =1   135     ;2 stop bits, 8 data bits, no parity check
  0087                =1   136             SMD_DATA_DIV EQU    10000111B
                      =1   137     ; Set divisor value        
000E BA0300           =1   138             MOV DX, SMD
0011 B087             =1   139             MOV AL, SMD_DATA_DIV
0013 EE               =1   140             OUT DX, AL
0014 BA0000           =1   141             MOV DX, DLL
0017 B034             =1   142             MOV AL, 52
0019 EE               =1   143             OUT DX, AL
001A BA0100           =1   144             MOV DX, DLM
001D B000             =1   145             MOV AL, 0
001F EE               =1   146             OUT DX, AL
                      =1   147     ;SET SERIAL PORT WORKING MODE
0020 BA0300           =1   148              MOV DX, SMD
0023 B007             =1   149              MOV AL, SMD_DATA
0025 EE               =1   150              OUT DX, AL
                      =1   151     ;DISABLE SERIAL PORT INT
0026 BA0100           =1   152              MOV DX, SIER
0029 B000             =1   153              MOV AL, 0
002B EE               =1   154              OUT DX, AL
                      =1   155     
                      =1   156     
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

                      =1   157     
                      =1   158     ; Timer control Unit
                      =1   159       
  FF66                =1   160              T2_CON    EQU      0FF66H ; Timer 2 Control Register
  FF62                =1   161              T2_CA     EQU      0FF62H ; Timer 2 compare register
  FF60                =1   162              T2_CNT    EQU      0FF60H ;
                      =1   163     
  FF5E                =1   164              T1_CON    EQU      0FF5EH ;
  FF5C                =1   165              T1_CB     EQU      0FF5CH ;
  FF5A                =1   166              T1_CA     EQU      0FF5AH ;
  FF58                =1   167              T1_CNT    EQU      0FF58H
                      =1   168              
  FF56                =1   169              T0_CON    EQU      0FF56H ;
  FF54                =1   170              T0_CB     EQU      0FF54H ;
  FF52                =1   171              T0_CA     EQU      0FF52H ;
  FF50                =1   172              T0_CNT    EQU      0FF50H   
                      =1   173     
  1770                =1   174                      TIMER0_TIME    EQU 6000;
  1388                =1   175                      TIMER1_TIME    EQU     5000;
  1770                =1   176                      TIMER2_TIME    EQU 6000;
                      =1   177              
                      =1   178     ; Timer Control Data
                      =1   179     
                      =1   180     
                      =1   181     ;Interrupt Control Registers
                      =1   182           
                      =1   183     
  FF3E                =1   184             INT3_CTRL       EQU 0FF3EH ;Interrupt 3 Control Register
  FF3C                =1   185             INT2_CTRL       EQU 0FF3CH
  FF3A                =1   186             INT1_CTRL       EQU 0FF3AH
  FF38                =1   187             INT0_CTRL       EQU 0FF38H
  FF32                =1   188             TIMER_CTRL      EQU 0FF32H ;Timer Interrupt Control Register
  FF30                =1   189             ISR             EQU 0FF30H ; Interrupt Status Register
  FF22                =1   190             EOI             EQU 0FF22H ; END OF INTERRUPT REGISTER
                      =1   191             
  FF28                =1   192             IMKW            EQU 0FF28H ; Interrupt Mask 
  FF2A                =1   193             IPMK            EQU 0FF2Ah ; Interrupt Priority Mask 
                      =1   194     
                      =1   195     ;| - | - | - | - |MSK|PM2|PM1|PM0| For TCU INT
                      =1   196     
                      =1   197     ;| - |SFNM|CAS|LVL|MSK|PM2|PM1|PM0| For TCU INT0,1
                      =1   198     
                      =1   199     ;MSK 1-enable, 0-mask int 
                      =1   200     ;pm0-pm1 Priority
                      =1   201     
                      =1   202         
                           203     
                           204     
----                       205     MISC_ROUTINE    SEGMENT
                           206     ASSUME CS:MISC_ROUTINE
                           207     
                           208     ; ---This procdeure initialize the system I/O area and on-chip devices-----
0000                       209     IODEFINE        PROC    FAR
0000 50                    210                     PUSH    AX
0001 52                    211                     PUSH    DX
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

                           212     
                           213     ; Initialize SCU for operation
0002 B007                  214                     MOV     AL,SMD_DATA
0004 E603                  215                     OUT     SMD,AL
                           216     ; Enable serial interrupts
0006 B003                  217                     MOV     AL,S_INT_ENA
0008 E601                  218                     OUT     SIER,AL
                           219     ; =============== INITIALIZATION OF INTERRUPT CONTROL UNIT =============
                           220     ; Initialize ICU for operation
                           221                     
                           222     ; Mask all interrupts except SCU
                           223                     ;disable TX interrupt,ENABLE RX.
000A B001                  224                     MOV     AL,1
000C E601                  225                     OUT     SIER,AL
                           226     ; SCU use INT0, enable INT0             
000E BA38FF                227                     MOV     DX, INT0_CTRL
0011 33C0                  228                     XOR     AX,AX
0013 EE                    229                     OUT     DX,AL
                           230     ; Mask other Int
0014 FA                    231                     CLI
0015 BA28FF                232                     MOV     DX,IMKW
0018 B8EE00                233                     MOV     AX,0EEH
001B EE                    234                     OUT     DX,AL   
001C 5A                    235                     POP     DX
001D 58                    236                     POP     AX
001E CB                    237                     RET
                           238     IODEFINE        ENDP
                           239     
                           240     
                           241     
                           242     
                           243     
                           244     ; ----------------Start of procedure PRINT_2HEX ------------------------
001F                       245     PRINT_2HEX      PROC    FAR
  0000                     246             QUE_BASE        EQU     OFFSET QUEUE_TRANS
                           247     ; The byte to be printed as 2 HEX number is put into AL.
                           248     ; This procedure is then called.
001F 9A6800----     R      249                     CALL    FAR PTR CHAR2HEX
                           250     ; Result is return in AX
0024 50                    251                     PUSH    AX
0025 8AC4                  252                     MOV     AL,AH
0027 9A3300----     R      253                     CALL    FAR PTR PRINT_CHAR
002C 58                    254                     POP     AX
002D 9A3300----     R      255                     CALL    FAR PTR PRINT_CHAR
0032 CB                    256                     RET
                           257     PRINT_2HEX      ENDP
                           258     
                           259     
                           260     
                           261     
                           262     ; ---------------- Start of procedure PRINT_CHAR ------------------------
0033                       263     PRINT_CHAR      PROC    FAR
                           264     ; This procedure is called to put a character into queue for transmission
                           265     ; through the serial port. 
                           266     ; The data to be transmitted is put in AL before the procedure is called.
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           267     ; Data is put at the tail. Queue_tail is then inc to point to next loc.
                           268     ; Data is taken from the head. Queue_head is then inc to point to next data.
                           269             
0033 53                    270                     PUSH    BX                      ;Save BX        
0034 06                    271                     PUSH    ES
                           272     
0035 50                    273                     PUSH    AX
                           274     
0036 BB----         R      275                     MOV     BX,SEG QUEUE_TAIL       ;Init segment register.
0039 8EC3                  276                     MOV     ES,BX                   ;ES now contains seg of INT_RAM_AREA
                           277     
003B E401                  278                     IN      AL,SIER                 ;disable TX interrupt.
003D 24FD                  279                     AND     AL,11111101B
003F E601                  280                     OUT     SIER,AL
                           281     
0041 58                    282                     POP     AX
0042 268B1E8200            283                     MOV     BX,ES:QUEUE_TAIL                
0047 268807                284                     MOV     ES:QUE_BASE[BX],AL      ;Put data to queue_tail.
004A 26FF068200            285                     INC     ES:QUEUE_TAIL           ;Increment queue_tail
004F 26813E82008000        286                     CMP     ES:QUEUE_TAIL,QUEUE_LEN ;and wrap around
0056 7C07                  287                     JL      L_PRINT1                ;to zero if needed.
0058 26C70682000000        288                     MOV     ES:QUEUE_TAIL,0
005F                       289     L_PRINT1:       
005F E401                  290                     IN      AL,SIER                 ;enable TX interrupt
0061 0C02                  291                     OR      AL,00000010B
0063 E601                  292                     OUT     SIER,AL
                           293     
0065 07                    294                     POP     ES
0066 5B                    295                     POP     BX
0067 CB                    296                     RET
                           297     PRINT_CHAR      ENDP
                           298     
                           299     
                           300     
                           301     
                           302     ;------------------Start of Procedure CHAR2HEX ----------------------------
0068                       303     CHAR2HEX        PROC    FAR
                           304     ; Char to be converted to HEX is put in AL before calling this procedure.
                           305     ; HEX version is return in AX.
0068 8AE0                  306                     MOV     AH,AL
006A 240F                  307                     AND     AL,00001111B
006C 3C09                  308                     CMP     AL,9
006E 7F05                  309                     JG      GT9_1
0070 0C30                  310                     OR      AL,00110000B
0072 EB0590                311                     JMP     DIGIT2
0075 2C09                  312     GT9_1:          SUB     AL,9
0077 0C40                  313                     OR      AL,01000000B
0079                       314     DIGIT2:
0079 C0EC04                315                     SHR     AH,4
007C 80FC09                316                     CMP     AH,9
007F 7F06                  317                     JG      GT9_2
0081 80CC30                318                     OR      AH,00110000B
0084 EB0790                319                     JMP     DONE
0087 80EC09                320     GT9_2:          SUB     AH,9
008A 80CC40                321                     OR      AH,01000000B
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    7


LOC  OBJ                  LINE     SOURCE

008D                       322     DONE:
008D CB                    323                     RET
                           324     CHAR2HEX        ENDP
                           325     
                           326     
008E                       327     Set_timer0      proc Far
008E 50                    328             push ax
008F 52                    329             push dx
                           330             ;Initialize Timer0      
0090 B80000                331             mov ax, 0;
0093 BA50FF                332             mov dx, T0_CNT;init timer count register to 0
0096 EE                    333             OUT DX, AL
                           334     
0097 B87017                335             MOV AX, TIMER0_TIME
009A BA52FF                336             MOV DX, T0_CA
009D EE                    337             OUT DX, AL
                           338             
009E B801E0                339             MOV AX,0E001H ;enable counting
00A1 BA56FF                340             MOV DX, T0_CON
00A4 EE                    341             OUT DX, AL
                           342     
00A5 BA32FF                343             MOV DX, TIMER_CTRL;Timer Interrupt Control Register(80188.inc)
00A8 B001                  344             MOV AL, 01H; Serial Interrupte Enable Register (w), Divisor Latch most  Signi
                                   ficant BYTE(80188.inc)
00AA EE                    345             OUT DX, AL
00AB 5A                    346             pop dx
00AC 58                    347             pop ax
                           348     
00AD CB                    349     ret
                           350     Set_timer0 endp
                           351     
00AE                       352     Set_timer1      proc Far
00AE 50                    353             push ax
00AF 52                    354             push dx
                           355             ;Initialize Timer1
00B0 B80000                356             mov ax, 0;
00B3 BA58FF                357             mov dx, T1_CNT;init timer count register to 0
00B6 EE                    358             OUT DX, AL
                           359     
00B7 B88813                360             MOV AX, TIMER1_TIME
00BA BA5AFF                361             MOV DX, T1_CA
00BD EE                    362             OUT DX, AL
                           363             
00BE B801E0                364             MOV AX,0E001H ;enable counting
00C1 BA5EFF                365             MOV DX, T1_CON
00C4 EE                    366             OUT DX, AL
                           367     
00C5 BA32FF                368             MOV DX, TIMER_CTRL;Timer Interrupt Control Register(80188.inc)
00C8 B001                  369             MOV AL, 01H; Serial Interrupte Enable Register (w), Divisor Latch most  Signi
                                   ficant BYTE(80188.inc)
00CA EE                    370             OUT DX, AL
00CB 5A                    371             pop dx
00CC 58                    372             pop ax
                           373     
00CD CB                    374     ret
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    8


LOC  OBJ                  LINE     SOURCE

                           375     Set_timer1 endp
                           376     
                           377     
00CE                       378     Set_timer2      proc Far
00CE 50                    379             push ax
00CF 52                    380             push dx
                           381     
                           382             ;Initialize Timer2 -- LED
00D0 B80000                383             mov ax, 0;
00D3 BA60FF                384             mov dx, T2_CNT;
00D6 EE                    385             OUT DX, AL
                           386     
00D7 B87017                387             MOV AX, TIMER2_TIME;
00DA BA62FF                388             MOV DX, T2_CA;
00DD EE                    389             OUT DX, AL
                           390     
00DE B801E0                391             MOV AX,0E001H
00E1 BA66FF                392             MOV DX, T2_CON
00E4 EE                    393             OUT DX, AL
                           394     
00E5 BA32FF                395             MOV DX, TIMER_CTRL
00E8 B001                  396             MOV AL, 01H
00EA EE                    397             OUT DX, AL
00EB 5A                    398             pop dx
00EC 58                    399             pop ax
                           400     
00ED CB                    401     ret
                           402     Set_timer2 endp
                           403     ; ************************************************************************
                           404     ;                       INTERRUPT ROUTINES                               *
                           405     ; ************************************************************************
                           406     
                           407     ; **************** Start of SERIAL_INTR service routine ******************
                           408     
                           409     ;*****************CAUTION*****************
                           410     ;At the end of interrutp routines, you must write EOI (end of Int) +
                           411     ;with the INT type (INT0-type 12) (timer-type 8)                   +    
                           412     ;comment added by Zhu Shunyu    March,2000                         +            
                                              
                           413     ;Interrupt Routines Modified accordly to fit 80C188XL
                           414     ;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
00EE                       415     SERIAL_INTR:
00EE 50                    416                     PUSH    AX                      ;save registers
00EF 53                    417                     PUSH    BX
00F0 52                    418                     PUSH    DX
                           419     
                           420            
                           421     
                           422                                    
00F1 E402                  423                     IN      AL,IIR                  ;read in serial INT ID
00F3 2407                  424                     AND     AL,00000111B
00F5 3C04                  425                     CMP     AL,00000100B            ;check if rx interrupt
00F7 740F                  426                     JE      RECEIVE_INTR
                           427     
00F9 3C02                  428                     CMP     AL,00000010B            ;check if tx interrupt
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE    9


LOC  OBJ                  LINE     SOURCE

00FB 741D                  429                     JE      TRANSMIT_INTR
                           430     
                           431                     
                           432     ;RESET_INT_CTL
00FD BA22FF                433                     MOV DX, EOI
0100 B80C00                434                     MOV AX, 12
0103 EE                    435                     OUT DX, AL
                           436     
0104 5A                    437                     POP     DX
0105 5B                    438                     POP     BX                      ;false serial interrupt
0106 58                    439                     POP     AX
0107 CF                    440                     IRET                            ;return
                           441     
0108                       442     RECEIVE_INTR:   
                           443                   
0108 E400                  444                     IN      AL,SRB                  
                           445     ; Information received will be used by user routine
                           446     ; Action to be taken will be contained in SERIAL_REC_ACTION
010A 9A0000----     E      447                     CALL    FAR PTR SERIAL_REC_ACTION
                           448                     
010F BA22FF                449                     MOV DX, EOI
0112 B80C00                450                     MOV AX, 12
0115 EE                    451                     OUT DX, AL
0116 5A                    452                     POP     DX
0117 5B                    453                     POP     BX                      ;false serial interrupt
0118 58                    454                     POP     AX
0119 CF                    455                     IRET
                           456     
011A                       457     TRANSMIT_INTR:
                           458                    
011A 06                    459                     PUSH    ES                      ;save ES
011B BB----         R      460                     MOV     BX,SEG QUEUE_TAIL       ;set ES to SERIAL_Q_SEG
011E 8EC3                  461                     MOV     ES,BX
0120 268B1E8200            462                     MOV     BX,ES:QUEUE_TAIL
0125 263B1E8000            463                     CMP     BX,ES:QUEUE_HEAD        ;more data to be transmitted?
012A 742B                  464                     JE      L_TX2
012C 268B1E8000            465                     MOV     BX,ES:QUEUE_HEAD        ;get data from queue
0131 268A07                466                     MOV     AL,ES:QUE_BASE[BX]
0134 E600                  467                     OUT     STB,AL                  ;tx data
0136 26FF068000            468                     INC     ES:QUEUE_HEAD           ;point to next data
013B 26813E80008000        469                     CMP     ES:QUEUE_HEAD,QUEUE_LEN ;wrap around if necessary
0142 7C07                  470                     JL      L_TX1
0144 26C70680000000        471                     MOV     ES:QUEUE_HEAD,0
014B                       472     L_TX1:          
014B 268B1E8200            473                     MOV     BX,ES:QUEUE_TAIL
0150 263B1E8000            474                     CMP     BX,ES:QUEUE_HEAD        ;more data to be transmitted?
0155 7506                  475                     JNE     L_TX3
0157                       476     L_TX2:
0157 E401                  477                     IN      AL,SIER                 ;no more, disable TX interrupt.
0159 24FD                  478                     AND     AL,11111101B
015B E601                  479                     OUT     SIER,AL
015D                       480     L_TX3:
                           481                     
                           482     ;RESET_INT_CTL
015D BA22FF                483                     MOV DX, EOI
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE   10


LOC  OBJ                  LINE     SOURCE

0160 B80C00                484                     MOV AX, 12
0163 EE                    485                     OUT DX, AL
0164 07                    486                     POP     ES                      ;restore original ES(transmit)
                           487                     
0165 5A                    488                     POP     DX 
0166 5B                    489                     POP     BX                      ;return serial interrupt
0167 58                    490                     POP     AX
0168 CF                    491                     IRET
                           492     ; **************** End of SERIAL_INTR service routine ************************
                           493     
                           494     
                           495     
                           496     
                           497     
                           498     
                           499     ; **************** Start of TIMER0_INTR service routine ******************
0169                       500     TIMER0_INTR:
0169 50                    501                     PUSH    AX
                           502                     
                           503     ; Action to be taken on timer0 interrupt to be written by user
016A 9A0000----     E      504                     CALL    FAR PTR TIMER0_ACTION
                           505                   
016F 58                    506                     POP     AX              ;return interrupt
                           507                     ;RESET_INT_CTL  
0170 BA22FF                508                     MOV DX, EOI
0173 B80800                509                     MOV AX, 8
0176 EE                    510                     OUT DX, AL
0177 CF                    511                     IRET
                           512     ; **************** End of TIMER0_INTR service routine ************************
                           513     
                           514     
                           515     ; **************** Start of TIMER1_INTR service routine ******************
0178                       516     TIMER1_INTR:
0178 50                    517                     PUSH    AX
                           518                     
                           519     ; Action to be taken on timer1 interrupt to be written by user
0179 9A0000----     E      520                     CALL    FAR PTR TIMER1_ACTION
                           521                   
017E 58                    522                     POP     AX              ;return interrupt
                           523                     ;RESET_INT_CTL  
017F BA22FF                524                     MOV DX, EOI
0182 B80800                525                     MOV AX, 8
0185 EE                    526                     OUT DX, AL
0186 CF                    527                     IRET
                           528     ; **************** End of TIMER1_INTR service routine ************************
                           529     
                           530     
                           531     ; **************** Start of TIMER2_INTR service routine ******************
0187                       532     TIMER2_INTR:
0187 50                    533                     PUSH    AX
                           534                     
                           535     ; Action to be taken on timer2 interrupt to be written by user
0188 9A0000----     E      536                     CALL    FAR PTR TIMER2_ACTION
                           537                   
018D 58                    538                     POP     AX              ;return interrupt
8086/87/88/186 MACRO ASSEMBLER    MISC                                                     23:32:17  11/09/;2  PAGE   11


LOC  OBJ                  LINE     SOURCE

                           539                     ;RESET_INT_CTL  
018E BA22FF                540                     MOV DX, EOI
0191 B80800                541                     MOV AX, 8
0194 EE                    542                     OUT DX, AL
0195 CF                    543                     IRET
                           544     ; **************** End of TIMER2_INTR service routine ************************
                           545     
                           546     
                           547     
----                       548     MISC_ROUTINE    ENDS
                           549     
                           550     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
